<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>不停餐饮大亨 - 后厨模拟器</title>
    <link rel="preload" as="image" href="assets/bg/家庭厨房.jpeg">
    <link rel="preload" as="image" href="assets/bg/门店后厨.jpg">
    <link rel="preload" as="image" href="assets/bg/餐厅解锁地图.jpg">
    <link rel="preload" as="image" href="assets/bg/商店背景.jpg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @font-face {
            font-family: 'OPPOSans';
            src: local('OPPO Sans'), local('OPPOSans'), local('OPPO Sans Regular'), local('OPPOSans-Regular');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'OPPOSans';
            src: local('OPPO Sans Medium'), local('OPPOSans-Medium');
            font-weight: 500;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'OPPOSans';
            src: local('OPPO Sans Bold'), local('OPPOSans-Bold');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }
        :root {
            --bg: #fdfcfb; --panel: #ffffff; --primary: #e60012; --accent: #FCC307;
            --prep: #3498db; --cook: #e74c3c; --plate: #2ecc71; --burnt: #2c3e50;
            --danger: #ff4757; --text-main: #2c3e50; --outline: #101010; --shadow: rgba(0,0,0,0.2);
            
            /* Button Shadow Standards */
            --btn-sh-y: 2px;
            --btn-sh-hover-y: 4px;
            --btn-sh-active-y: 1px;
        }
        body {
            font-family: 'PingFang SC', sans-serif;
            background: #000;
            margin: 0;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            /* 禁止移动端默认的长按选中和橡皮筋效果 */
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        #game-container {
            display: none; /* JS加载完后再 flex */
            position: relative;
            width: 1920px;
            height: 1080px;
            background: transparent;
            /* 确保高层级 */
            z-index: 10;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            /* 缩放中心点设为中心 */
            transform-origin: center center;
        }

        /* [新增] 竖屏提示层 (强制用户横屏玩) */
        #orientation-lock {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; color: white; z-index: 99999;
            display: none; /* 默认隐藏 */
            flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
        }
        /* 仅在竖屏时显示 */
        @media screen and (orientation: portrait) {
            #orientation-lock { display: flex; }
        }

        /* Play Area Grid Layout */
        #play-area {
            display: grid;
            grid-template-rows: 170px 1fr 120px; /* Top: Fixed 170px for Belt, Mid: Kitchen, Bot: Shelf */
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        #game-bg { 
            /* [核心修改] 从 fixed 改为 absolute，相对于 #game-container 定位 */ 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; /* 强制填满 1920x1080 */ 
            z-index: 0; 
            pointer-events: none; 
            background-color: #000; 
            /* 移除 inset: 0 */ 
        }
        #game-bg::after { content: ""; position: absolute; inset: 0; background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.22)); opacity: var(--game-bg-overlay, 0.34); transition: opacity 0.6s ease; }
        #game-bg .bg-layer { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background-repeat: no-repeat; 
            background-position: center; 
            /* [核心修改] 强制拉伸填满容器，禁止自动裁切 */ 
            background-size: 100% 100% !important; 
            opacity: 0; 
            transform: scale(1); 
            transition: opacity 0.6s ease, filter 0.6s ease; 
        }
        /* [新增] 游戏模式下的背景样式：完整展示 + 顶部贴边 */
        #game-bg .bg-layer.game-mode {
            background-size: contain;
            background-position: top center;
        }
        #game-bg .bg-layer.is-active { opacity: 1; transform: scale(1); }

        /* 游戏标题与HUD */
        /* 1. 移除游戏标题栏，释放空间 */ 
        #game-header { display: none !important; background: #FFFFFF; color: #303030; padding: 10px 20px; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); position: relative; z-index: 100; }
        #game-title { font-size: 22px; font-weight: 900; letter-spacing: 2px; text-shadow: none; color: #303030; display: flex; align-items: center; line-height: 1; }
        #game-title .title-logo { height: 1em; width: auto; margin-right: 10px; image-rendering: pixelated; }
        #ui-controls { display: flex; gap: 12px; align-items: center; }
        .toggle, .toggle-btn { height: 36px; box-sizing: border-box; display: inline-flex; align-items: center; gap: 8px; padding: 0 12px; border: 3px solid var(--outline); border-radius: 12px; background: #fff; color: #303030; font-weight: 700; cursor: pointer; box-shadow: 0 4px 0 #bdbdbd; user-select: none; font-size: 14px; transition: all 0.1s ease; }
        .toggle input { appearance: none; width: 16px; height: 16px; border: 3px solid var(--outline); border-radius: 4px; display: inline-block; position: relative; margin: 0; }
        .toggle input:checked { background: var(--accent); }
        .toggle:active, .toggle-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #bdbdbd; }
        .toggle-btn:hover, .toggle:hover { transform: translateY(-1px); box-shadow: 0 5px 0 #bdbdbd; }
        
        #pause-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 3100; backdrop-filter: blur(2px); }
        
        #hud { 
            height: auto; 
            min-height: 0; /* [优化] 移除最小高度限制 */
            background: transparent; 
            color: white; 
            display: flex; 
            flex-direction: column; 
            justify-content: flex-start; 
            padding: 20px 20px 10px 20px; /* [优化] 增加顶部呼吸感 */
            position: absolute; /* [优化] 绝对定位，悬浮在游戏区上方 */
            top: 0 !important; /* [优化] 顶对齐 */
            left: 0;
            width: 100%;
            z-index: 20;
            pointer-events: none; /* [优化] 允许穿透点击下方的游戏区 */
        }
        #hud-row { 
            display: flex; 
            flex-direction: row;
            align-items: flex-start; 
            justify-content: space-between; /* [优化] 两端对齐：左侧数据，右侧暂停 */
            width: 100%; 
            z-index: 2; 
        }
        /* [新增] HUD 左侧数据统计区 */
        .hud-stats {
            display: flex;
            flex-direction: column;
            gap: 12px; /* [优化] 增加行间距，确保视觉上足够宽敞 */
            pointer-events: auto; /* [优化] 恢复交互 (如果需要) */
        }
        /* [新增] HUD 行容器 */
        .hud-line {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 0; /* 确保没有额外的 margin 干扰 gap */
        }

        .hud-item { 
            /* [微调] 更通透、更紧凑 */
            background: rgba(44, 62, 80, 0.55); 
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px; 
            padding: 6px 14px; 
            backdrop-filter: blur(6px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            
            display: flex; 
            flex-direction: column; 
            align-items: flex-start; /* 默认左对齐 */
            justify-content: center;
            gap: 1px; 
            white-space: nowrap; 
            flex: 0 1 auto; 
            min-width: 80px; 
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
            pointer-events: auto; /* [优化] 允许交互 */
            margin: 0; /* 确保没有额外的 margin */
        }
        .hud-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
            background: rgba(44, 62, 80, 0.85); /* hover时加深 */
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        /* 特定模块调整 */
        #game-timer-container {
            align-items: flex-start; /* [修复] 左对齐 */
            flex: 0 0 auto; /* 不拉伸 */
            min-width: 80px;
            border-color: rgba(231, 76, 60, 0.4); /* 红色微调 */
        }
        
        /* 暂停按钮样式重置，使其融入 HUD 风格 */
        #btn-pause { 
            justify-self: end; 
            height: auto;
            align-self: flex-start; /* [优化] 顶部对齐 */
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            backdrop-filter: blur(4px);
            padding: 8px 20px; /* [优化] 增加 padding */
            margin-left: auto; /* 靠右 */
            margin-right: 60px; /* [修复] 增加右侧边距，防止贴边被遮挡 */
            flex: 0 0 auto;
            pointer-events: auto; /* [优化] 允许点击 */
            color: #ffffff; /* [修复] 明确设置白色文字，提高对比度 */
            font-weight: 600; /* [优化] 增加字重 */
        }
        #btn-pause:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .hud-label { font-size: 11px; color: rgba(255, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .hud-main { display: flex; align-items: baseline; gap: 4px; }
        .hud-main .stat-val { text-align: left; font-variant-numeric: tabular-nums; line-height: 1.2; }
        .stat-val { font-size: 20px; color: #fff; margin-left: 0; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .hud-label-strong { font-size: 12px; font-weight: 800; letter-spacing: 1px; color: rgba(255, 255, 255, 0.9); }
        
        .hud-item-target .hud-main .stat-val { min-width: auto; text-align: left; }
        .hud-item-target .target-current { color: #fff; font-weight: 700; }
        .hud-item-target .target-goal { color: rgba(255,255,255,0.5); font-size: 14px; }
        .hud-item-target .target-sep { color: rgba(255,255,255,0.3); font-size: 14px; margin: 0 2px; }
        
        
        /* Unified HUD Colors */
        #revenue, #pass-rate { color: #fff; }
        
        /* 进度条 */
        #revenue-progress-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 6px; background: rgba(0,0,0,0.3); }
        #revenue-progress-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s ease; }

        /* 订单看板 (原传送带) */
        #belt-container {
            /* 尺寸与定位保持不变 */
            width: fit-content;
            min-width: 320px;
            max-width: 95%;
            height: 140px;
            position: relative;
            margin: 0 auto;
            overflow: visible;
            z-index: 10;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            gap: 16px;
            padding: 15px 24px;
            transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            
            /* [核心修改] 木质材质模拟 */
            background-color: #5d4037; /* 深棕底色 */
            background-image:
                /* 1. 顶部阴影 (营造深度) */
                linear-gradient(to bottom, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0) 15%),
                /* 2. 木板横向纹理 (模拟拼接感) */
                repeating-linear-gradient(90deg,
                    transparent 0, transparent 2px,
                    rgba(0,0,0,0.05) 3px, rgba(255,255,255,0.02) 4px,
                    transparent 6px
                ),
                /* 3. 基础木纹噪点 */
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.1'/%3E%3C/svg%3E");

            /* 木板边框 */
            border: 3px solid #3e2723;
            border-radius: 8px;
            box-shadow:
                0 10px 20px rgba(0,0,0,0.5), /* 整体投影 */
                inset 0 0 30px rgba(0,0,0,0.6); /* 内部暗角 */
        }

        .order-slot {
            width: 140px;
            height: 100%; /* 占满容器高度，订单纸可超出容器背景 */
            border: none;
            border-radius: 8px;
            display: flex;
            align-items: flex-start; /* 内部内容顶部对齐 */
            justify-content: center;
            position: relative;
            flex: 0 0 auto;
            overflow: visible;
        }
        
        /* Remove old belt animations */
        #belt-container::before, #belt-container::after { display: none; }

/* --- 垂直进度条新样式 --- */
.order-ticket {
    position: relative;
    width: 140px;
    min-height: 130px; /* 1 道菜时的基础高度 */
    background: linear-gradient(180deg, #fdfdfd 0%, #f5f5f5 60%, #e8e8e8 100%);
    /* Optimized: Reduced border radius (4px top, 0 bottom for tear effect) */
    border-radius: 4px 4px 0 0;
    /* Use filter for shadow to respect the jagged edge */
    box-shadow: none;
    filter: drop-shadow(0 4px 5px rgba(0,0,0,0.3));
    display: flex;
    flex-direction: column;
    align-items: stretch;
    padding: 8px 10px 10px 20px;
    cursor: pointer;
    transition: transform 0.1s;
    user-select: none;
    top: auto;
    left: auto;
    transform: none !important;
    border-top: 3px solid #d0d0d0;
    overflow: visible; /* 不产生内部滚动条，靠内容自然拉长 */
    z-index: 20; /* 确保在金属背景之上 */
}

/* Receipt Jagged Edge Effect */
.order-ticket::after {
    content: "";
    position: absolute;
    left: 0;
    bottom: -6px;
    width: 100%;
    height: 6px;
    /* Irregular sawtooth pattern using interference */
    background-color: transparent;
    background-image: 
        linear-gradient(to bottom right, #e8e8e8 50%, transparent 51%), 
        linear-gradient(to bottom left,  #e8e8e8 50%, transparent 51%);
    background-position: 0 0, 5px 0;
    background-size: 10px 6px;
    background-repeat: repeat-x;
    z-index: 19; /* Below the ticket content but visible */
}

.patience-bar {
    /* [修改] 改为绝对定位的垂直条 */
    position: absolute; left: 5px; top: 5px; bottom: 5px; /* 上下撑满，留一点边距 */
    width: 6px; /* 宽度固定 */
    height: auto;
    background: #eee; /* 底色 */
    border-radius: 3px;
    overflow: hidden;
    margin-top: 0; /* 移除旧样式的 margin */
}
.patience-fill {
    /* [修改] 锚定在底部，高度随时间减少 */
    position: absolute; bottom: 0; left: 0;
    width: 100%;
    height: 100%; /* 初始高度由 JS 控制 */
    background: #2ecc71;
    /* 高度变化动画 */
    transition: height 0.1s linear, background 0.3s;
}

/* --- Order Highlight Animation --- */
.order-ticket.match-highlight {
    animation: pulse-green 0.5s infinite;
    border: 4px solid #2ecc71 !important;
    /* Use filter for glow */
    box-shadow: none;
    z-index: 200;
}

@keyframes pulse-green {
    0% { transform: scale(1); filter: drop-shadow(0 0 5px rgba(46, 204, 113, 0.5)); }
    50% { transform: scale(1.05); filter: drop-shadow(0 0 15px rgba(46, 204, 113, 0.9)); }
    100% { transform: scale(1); filter: drop-shadow(0 0 5px rgba(46, 204, 113, 0.5)); }
}

        .order-list { width: 100%; display: flex; flex-direction: column; gap: 6px; margin-top: 6px; }
        .order-item { display: flex; align-items: flex-start; gap: 6px; border-bottom: 1px dashed rgba(0, 0, 0, 0.2); padding-bottom: 3px; }
        .order-item:last-child { border-bottom: none; }
        .order-ticket b { font-size: clamp(10px, 1.4vw, 13px); font-weight: 500; align-self: flex-start; margin-left: 2px; }
        .item-icon { font-size: clamp(14px, 1.6vw, 16px); font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', 'OPPOSans', 'OPPO Sans', sans-serif; }
        .item-name { font-size: clamp(10px, 1.4vw, 12px); font-weight: 300; color: #222; line-height: 1.2; text-align: left; }
        .order-info-col { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; }

        @media (max-width: 900px) {
            #belt-container {
                width: 95%;
                padding: 8px 16px;
                gap: 12px;
            }
            .order-slot {
                width: 130px;
            }
            .order-ticket {
                width: 130px;
            }
        }

        @media (max-width: 600px) {
            #belt-container {
                width: 100%;
                justify-content: flex-start;
            }
            .order-slot {
                width: 120px;
            }
            .order-ticket {
                width: 120px;
            }
        }

        /* 厨房 */
        #kitchen-area { 
            width: 100%; height: 100%; /* Fill Grid Row 2 */
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            padding: 20px; 
            padding-bottom: 0; /* 移除底部多余 padding */
            /* [修改] 隐藏滚动条，内容溢出时不再出现滚动条 */
            overflow: hidden; 
            align-content: center;
            justify-content: center;
            box-sizing: border-box;
        }
        

        
        .ing-icon { 
            font-size: 48px; /* [优化] 放大备菜区图标 (36px -> 48px) */
            margin-bottom: 4px; 
            text-shadow: 0 2px 2px rgba(0,0,0,0.2);
            pointer-events: none;
            will-change: transform;
            transition: transform 0.2s;
        }
        
        .ing-btn:hover .ing-icon {
            transform: scale(1.1);
        }

        .ing-name { 
            font-size: 12px; 
            font-weight: 800; 
            color: #424242; 
            text-shadow: 0 1px 0 rgba(255,255,255,0.5);
        }
        
        .ing-stock { 
            font-size: 10px; 
            color: #616161; 
            margin-top: 2px; 
            background: rgba(255,255,255,0.5);
            padding: 1px 6px;
            border-radius: 4px;
        }



/* Drag Cursor */ 
#drag-cursor { 
    position: fixed; 
    pointer-events: none; 
    z-index: 9999; 
    font-size: 40px; 
    transform: translate(-50%, -50%); 
    display: none; 
    text-shadow: 0 4px 10px rgba(0,0,0,0.3); 
    will-change: transform;
    top: 0;
    left: 0;
} 
 
 /* --- 真实菜品图片适配 --- */ 
 /* 1. 订单上的图片 */ 
.item-icon { 
    width: 36px; 
    height: 36px; 
    object-fit: contain; 
    text-shadow: 0 2px 2px rgba(0,0,0,0.15); 
    display: block; 
} 

 /* 2. 工位完成时的图片 (机器上显示) */ 
.cook-machine img { 
    width: 50px; 
    height: 50px; 
    object-fit: contain; 
    /* [修改] 移除默认动画，防止取餐后重置 */
    /* animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); */
    filter: drop-shadow(0 4px 4px rgba(0,0,0,0.2)); 
} 
 
 /* 3. 鼠标拖拽时的图片 */ 
 #drag-cursor img { 
     width: 60px; 
     height: 60px; 
     object-fit: contain; 
     filter: drop-shadow(0 8px 15px rgba(0,0,0,0.3)); 
 }

        /* --- 工位 UI 3.1 (专业定型版) --- */ 
.station {
    width: 240px;
    display: flex;
    flex-direction: column;
    position: relative;
    margin-top: 20px;
    user-select: none;
    /* [修改] 间距增加至 100px，让备菜区显著下移，留出更多操作空间 */
    gap: 100px;
} 
.station-card { 
    background: transparent !important; 
    backdrop-filter: none !important; 
    -webkit-backdrop-filter: none !important; 
    border-radius: 16px; 
    box-shadow: none !important; 
    padding: 0; 
    position: relative; 
    transition: transform 0.1s ease; 
    border: 2px solid rgba(255, 255, 255, 0.1); /* 微弱的边框用于界定区域 */
    display: flex; 
    flex-direction: column; 
    overflow: visible; 
    box-sizing: border-box; 
} 

/* 确保占位符有效 */
.station {
    width: 240px;
    flex-shrink: 0;
    margin: 0 10px;
}

/* 微调：二号工位整体向右平移 4px */
#s_s2 {
    transform: translateX(4px);
}

/* 悬停交互反馈 */
.station-card:hover {
    border-color: rgba(255, 255, 255, 0.4);
    background: rgba(255, 255, 255, 0.05) !important; /* 极淡的白色悬停底色 */
}

/* [修改] 统一增加高度，确保按钮不溢出 */
.station-card.prep-card, .station-card.cook-card {
    /* [修改] 高度调整回 320px */
    height: 320px !important;
    flex-shrink: 0;
    /* 确保内容垂直分布均匀 */
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    transform: translateX(16px);
}

/* [核心修复] 烹饪区卡片专用位移 - 根据装修等级隔离样式 */
.station-card.cook-card {
    /* 1. 基础重置 (所有等级通用) */
    margin-top: 0 !important;
    margin-left: 0 !important;
    position: relative !important;
    top: 0 !important;
    left: 0 !important;
}

/* --- 星级后厨 (Lv2) --- */
.kitchen-lv2 .station-card.cook-card,
.kitchen-lv2 #s_s1 .station-card.cook-card,
.kitchen-lv2 #s_s2 .station-card.cook-card,
.kitchen-lv2 #s_s3 .station-card.cook-card {
    transform: translate(16px, 40px) !important;
}

/* --- 标准后厨 (Lv0) & 扩容后厨 (Lv1) --- */
/* [可微调] 当前设置为 translate(16px, 20px)，请根据视觉效果调整 Y 轴数值 */
.kitchen-lv0 .station-card.cook-card,
.kitchen-lv0 #s_s1 .station-card.cook-card,
.kitchen-lv1 .station-card.cook-card,
.kitchen-lv1 #s_s1 .station-card.cook-card,
.kitchen-lv1 #s_s2 .station-card.cook-card {
    transform: translate(16px, 20px) !important;
} 

/* Card Header - 完全透明 */ 
.card-header { 
    flex: 0 0 40px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    padding: 0 12px; 
    border-bottom: 1px solid rgba(255, 255, 255, 0.2); 
    background: transparent !important; 
    border-radius: 13px 13px 0 0; 
} 

/* Card Title - 增强对比度 */
.card-title { 
    font-size: 12px; 
    font-weight: 800; 
    color: #fff; /* 纯白文字 */
    text-shadow: 0 1px 3px rgba(0,0,0,0.8); /* 强阴影保证可读性 */
    text-transform: uppercase; 
    letter-spacing: 1px; 
} 

/* 垃圾桶按钮 - 增强对比度 */
.btn-trash-mini { 
    width: 28px; height: 28px; 
    border-radius: 6px; border: none; 
    background: rgba(0, 0, 0, 0.2); /* 半透明黑底 */
    color: #fff; 
    display: flex; align-items: center; justify-content: center; 
    cursor: pointer; font-size: 16px; 
    transition: all 0.2s; z-index: 5; 
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
} 
.btn-trash-mini:hover { background: rgba(255, 255, 255, 0.2); color: #fff; transform: none; } 
.btn-trash-mini:active { background: rgba(0, 0, 0, 0.4); transform: scale(0.95); } 

/* 优化内部布局，利用新增的空间 */
.station-cook-zone, .station-prep-zone {
    flex: 1;
    width: 100%;
    /* [修改] 减少左右内边距，允许图片更大 (10px -> 0) */
    padding: 20px 0 !important;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    align-items: center;
    /* 均匀分布：图片在上，按钮在最下 */
    justify-content: space-between !important;
    
    /* Preserved properties */
    cursor: pointer;
    border-radius: 0 0 16px 16px;
    background-color: transparent;
    transition: transform 0.05s ease;
} 

/* [核心修复 2] 点击时的物理反馈：整体微缩，背景不变色 */ .station-prep-zone:active { transform: scale(0.98); /* 模拟按压感 */ background-color: transparent; /* 强制保持一致 */ } 

.prep-bowl { /* [修改] 容器极大化，利用 flex 剩余空间 */
    width: 220px !important; /* 放大至约 1.3 倍 (180->220) */
    height: 180px !important; /* 放大至约 1.3 倍 (140->180) */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 60px !important;
    background: transparent;
    border: none;
    box-shadow: none;
    margin: 5px 0 !important; /* 给上下留点间隙 */
    flex-shrink: 0;
    position: relative;
    top: 10px; /* [调整] 适应 320px 高度，稍微上移 (20px -> 10px) */
}
.prep-bowl img { /* [修改] 图片撑满容器 */
    width: 100% !important;
    height: 100% !important;
    object-fit: contain;
    filter: drop-shadow(0 8px 12px rgba(0,0,0,0.3)) !important;
    display: block;
}

/* 新增：状态文字容器样式 */
.prep-status-text {
    height: 20px;
    width: 100%;
    text-align: center;
    font-size: 12px;
    font-weight: 800;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

/* 微调备菜列表位置 - 覆盖在图片上 */
.ing-list-prep {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    display: flex; gap: -10px; align-items: center; justify-content: center; pointer-events: none; flex-shrink: 0;
    margin: 0 !important;
    width: 100%;
    height: auto !important;
} .ing-item-small { font-size: 40px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); background: transparent; width: auto; height: auto; line-height: 1; text-align: center; border: none; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); } 

/* 确保按钮容器固定在底部 */
.prep-action-container {
    width: 100%;
    height: 48px;
    flex-shrink: 0;
    /* 确保在最下方 */
    margin-top: auto;
    /* [修改] 增加内边距防止按钮贴边 */
    padding: 0 10px;
    box-sizing: border-box;
    /* [修改] 按钮整体上移 15px (原10px) */
    transform: translateY(-15px);
    
    /* Preserved layout properties */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    z-index: 10;
    margin-bottom: 5px;
}

/* 确保图片居中且尺寸合适 */
.cook-machine, .prep-bowl {
    /* 在剩余空间里垂直居中 */
    margin-top: auto;
    margin-bottom: auto;
} .move-btn { background: #2ecc71; color: white; border: none; padding: 0 12px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; width: 100%; height: 36px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: 0 2px 6px rgba(46, 204, 113, 0.2); letter-spacing: 0.5px; } .move-btn:hover { background: #27ae60; box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3); transform: translateY(-1px); } .move-btn:active { transform: translateY(0); box-shadow: none; background: #219150; } 

/* 2. 烹饪区 (下半部) - 基础样式已合并至上方 */
.station-cook-zone:active { transform: scale(0.98); } 

/* 机器主体 */ 
.cook-machine { 
    width: 150px !important; 
    height: 150px !important; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    margin-bottom: 0 !important; 
    pointer-events: none;
    position: relative; /* Enable relative positioning */
    top: -20px; /* Move up by 20px as requested */
} 
.cook-machine img { 
    width: 100% !important; 
    height: 100% !important; 
    object-fit: contain; 
    filter: drop-shadow(0 10px 15px rgba(0,0,0,0.35)) !important; 
    transition: transform 0.2s; 
} 
 /* 精确定位仅移动大锅（烹饪/空闲）图片 */
 .cook-machine img[alt="Idle"], 
 .cook-machine img[alt="Cooking"] {
     transform: translateX(6px);
 }
.cook-machine.active { 
    animation: machineWork 0.5s infinite; 
} 
.cook-machine.finished { 
    transform: scale(1.1); 
    filter: drop-shadow(0 0 15px rgba(241, 196, 15, 0.9)); 
} 

.progress-bar-container { width: 80%; height: 10px; background: rgba(0,0,0,0.3); border-radius: 5px; overflow: hidden; margin-top: 5px; border: 1px solid rgba(255,255,255,0.2); } .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #f39c12, #e67e22); width: 0%; transition: width 0.1s linear; box-shadow: 0 0 10px rgba(230, 126, 34, 0.5); } 

/* 状态样式 - 使用边框色区分 */ 
.prep-card.status-active { border-color: #3498db; box-shadow: 0 0 15px rgba(52, 152, 219, 0.3) !important; } 
.cook-card.status-cooking { border-color: #e67e22; box-shadow: 0 0 15px rgba(230, 126, 34, 0.3) !important; } 
.cook-card.status-finished { 
    border-color: #f1c40f; 
    background: transparent !important; /* 移除背景色 */
    box-shadow: 0 0 20px rgba(241, 196, 15, 0.5) !important; /* 增强发光效果替代背景 */
} 

@keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } } @keyframes machineWork { 0% { transform: translateY(0); } 50% { transform: translateY(-3px); } 100% { transform: translateY(0); } } 
 

/* 隐藏旧元素 */ .btn-trash { display: none; }

/* 维护按钮 (Preserved) */
.clean-btn {
    position: absolute; bottom: 10px; right: 10px;
    background: #e74c3c; color: white; border: none; padding: 4px 10px; border-radius: 8px;
    font-size: 11px; font-weight: bold; cursor: pointer;
    z-index: 10;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

        .station-active { border-color: var(--primary); box-shadow: 0 6px 0 #b03a2e, 0 6px 20px rgba(230, 126, 34, 0.15); }
        .station-ready { border-color: #2ecc71 !important; box-shadow: 0 6px 0 #27ae60, 0 6px 20px rgba(46, 204, 113, 0.2) !important; }
        .station-ruined { border-color: #FCC307 !important; box-shadow: 0 6px 0 #c49606, 0 6px 20px rgba(252, 195, 7, 0.25) !important; } /* 新增红色状态样式 */
        .dish-icon { transition: transform 0.18s ease, filter 0.18s ease; flex-grow: 1; display: flex; align-items: center; justify-content: center; font-size: 52px; width: 100%; }
        .dish-icon.pop { transform: scale(1.15); filter: brightness(1.1); }
        .dish-info { line-height: 1.2; margin-top: 4px; height: 28px; font-size: 20px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .dish-status { line-height: 1.2; text-align: center; height: 26px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; width: 100%; font-size: 16px; color: #666; }

        .progress-box { width: 100%; height: 16px; background: #eee; border-radius: 8px; overflow: hidden; margin: 0 0 16px 0; border: 1px solid #ddd; flex-shrink: 0; }
        .bar { width: 0%; height: 100%; transition: width 0.1s linear; background: var(--prep); }
        .seg-box { display: none; width: 100%; height: 100%; gap: 6px; align-items: center; justify-content: center; padding: 0 4px; box-sizing: border-box; }
        .seg { flex: 1; height: 10px; background: #e0e0e0; border: none; border-radius: 4px; transition: all 0.2s ease; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
        .seg.filled { background: var(--prep); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .seg.pop-anim { animation: segPop 0.3s ease-out; }
        .seg-box.ready .seg { background: #2ecc71; }
        .seg-box.ruined .seg { background: #FCC307; }

        @keyframes segPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.25); filter: brightness(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes bounce {
            0% { transform: scale(1); }
            40% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .dish-icon.bounce { animation: bounce 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .station-controls { 
            width: 100%; 
            height: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            flex-shrink: 0;
            /* [修改] 增加内边距防止按钮贴边 */
            padding: 0 10px;
            box-sizing: border-box;
        }

        .action-btn {
            width: 100%; height: 48px; /* 1.5x */
            padding: 0; display: flex; align-items: center; justify-content: center;
            border: 3px solid var(--outline); border-radius: 12px;
            background: var(--primary); color: white; font-weight: 800; cursor: pointer; font-size: 20px;
            box-shadow: 0 var(--btn-sh-y) 0 #b03a2e;
            transition: all 0.1s ease;
            margin: 0;
        }
        .action-btn:hover { transform: translateY(-2px); filter: brightness(1.05); box-shadow: 0 var(--btn-sh-hover-y) 0 #b03a2e; }
        .action-btn:active { transform: translateY(2px); box-shadow: 0 var(--btn-sh-active-y) 0 #b03a2e; }
        .action-btn:disabled, .action-btn:disabled:hover, .action-btn:disabled:active { 
            background: #ccc !important; 
            cursor: not-allowed; 
            box-shadow: 0 var(--btn-sh-y) 0 #9e9e9e !important; 
            color: #666 !important;
            transform: none !important; 
            filter: none !important;
        }
        
        /* Reusable Shadow Classes using Variables */
        .btn-danger { background: var(--burnt) !important; box-shadow: 0 var(--btn-sh-y) 0 #1a252f !important; }
        .btn-danger:hover { box-shadow: 0 var(--btn-sh-hover-y) 0 #1a252f !important; }
        .btn-danger:active { box-shadow: 0 var(--btn-sh-active-y) 0 #1a252f !important; }
        
        .btn-confirm { background: #2ecc71 !important; box-shadow: 0 var(--btn-sh-y) 0 #27ae60 !important; display: none; }
        .btn-confirm:hover { box-shadow: 0 var(--btn-sh-hover-y) 0 #27ae60 !important; }
        .btn-confirm:active { box-shadow: 0 var(--btn-sh-active-y) 0 #27ae60 !important; }
        
        /* New Button Variants */
        .btn-green { background: #2ecc71 !important; box-shadow: 0 var(--btn-sh-y) 0 #27ae60 !important; color: white !important; }
        .btn-green:hover { box-shadow: 0 var(--btn-sh-hover-y) 0 #27ae60 !important; }
        .btn-green:active { box-shadow: 0 var(--btn-sh-active-y) 0 #27ae60 !important; }

        /* [强制修复] 杀掉所有溢出隐藏 */ 
        .station, .station-card, .station-cook-zone, .cook-station-wrapper { 
            overflow: visible !important; 
            transform-style: preserve-3d; /* 尝试修复层级上下文问题 */ 
        } 
        /* [强制修复] Omni 巨型设备样式 */ 
        .omni-equipment-bg { 
            position: absolute; 
            bottom: -20px; 
            left: 50%; 
            transform: translateX(-50%); 
        
            /* 尺寸强制放大 */ 
            width: 140% !important; 
            height: auto !important; 
            max-height: none !important; 
            /* 层级调整：确保在最上层，但不在 UI 之上 */ 
            z-index: 5; 
        
            /* 调试辅助：如果图片透明或错误，能看到占位 */ 
            min-height: 100px; 
            pointer-events: none; 
        } 
        /* 确保 UI 依然在设备之上 */ 
        .station-ui-layer, .station-timer, .station-progress, .station-dish-icon { 
            position: relative; 
            z-index: 20 !important; 
        }

        .btn-yellow { background: #FCC307 !important; box-shadow: 0 var(--btn-sh-y) 0 #c49606 !important; color: black !important; }
        .btn-yellow:hover { box-shadow: 0 var(--btn-sh-hover-y) 0 #c49606 !important; }
        .btn-yellow:active { box-shadow: 0 var(--btn-sh-active-y) 0 #c49606 !important; }

        .btn-gray { background: #95a5a6 !important; box-shadow: 0 var(--btn-sh-y) 0 #7f8c8d !important; color: white !important; }
        .btn-gray:hover { box-shadow: 0 var(--btn-sh-hover-y) 0 #7f8c8d !important; }
        .btn-gray:active { box-shadow: 0 var(--btn-sh-active-y) 0 #7f8c8d !important; }

        /* 反馈 */
        .float-text { position: fixed; font-weight: bold; font-size: 24px; pointer-events: none; animation: floatUp 1.2s forwards; z-index: 2000; text-shadow: 0 2px 0 #fff; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-80px); opacity: 0; } }

        /* 弹窗 */
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 3000; padding: 18px; box-sizing: border-box; }
        .modal { background: white; color: #333; padding: 34px 32px; border-radius: 24px; text-align: center; width: 380px; border: 4px solid var(--outline); box-shadow: 0 10px 0 rgba(0,0,0,0.25), 0 0 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; max-height: min(82vh, 720px); overflow: hidden; }
        .modal h2 { color: var(--primary); margin: 0 0 10px; font-size: 26px; letter-spacing: 1px; line-height: 1.15; }
        .modal-content { margin: 0; font-size: 16px; line-height: 1.65; white-space: pre-line; text-align: left; width: 100%; flex: 1 1 auto; overflow: auto; padding-bottom: 16px; box-sizing: border-box; }
        .modal button { margin-top: 22px; padding: 12px 44px; border-radius: 14px; border: 3px solid var(--outline); background: var(--plate); color: white; font-weight: 900; cursor: pointer; font-size: 18px; box-shadow: 0 6px 0 rgba(0,0,0,0.25); transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease; flex-shrink: 0; }
        .modal button:hover { transform: translateY(-2px) scale(1.02); filter: brightness(1.05); }
        .modal button:active { transform: translateY(2px) scale(0.98); box-shadow: 0 3px 0 rgba(0,0,0,0.25); }
        
            /* Pass Rate Trend Styles */
            .trend-box { display: inline-flex; align-items: center; margin-left: 8px; font-size: 12px; font-weight: bold; position: relative; cursor: help; }
            .trend-up { color: #2ecc71; }
            .trend-down { color: #ff4757; }
            .trend-icon { margin-right: 2px; }
            
            .tooltip {
                visibility: hidden;
                width: 140px;
                background-color: rgba(0,0,0,0.9);
                color: #fff;
                text-align: center;
                border-radius: 6px;
                padding: 8px;
                position: absolute;
                z-index: 1;
                bottom: 125%; /* Position above */
                left: 50%;
                margin-left: -70px;
                opacity: 0;
                transition: opacity 0.3s;
                font-weight: normal;
                font-size: 11px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                pointer-events: none;
                border: 1px solid #444;
            }
            
            .tooltip::after {
                content: "";
                position: absolute;
                top: 100%;
                left: 50%;
                margin-left: -5px;
                border-width: 5px;
                border-style: solid;
                border-color: rgba(0,0,0,0.9) transparent transparent transparent;
            }
            
            .trend-box:hover .tooltip { visibility: visible; opacity: 1; }
        
        /* Loading Bar */
        #loading-bar-container { width: 300px; height: 12px; background: #eee; border: 2px solid #2c3e50; border-radius: 6px; overflow: hidden; margin: 20px 0; position: relative; }
        #loading-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.1s linear; }
        #loading-text { font-size: 14px; font-weight: bold; color: #666; margin-bottom: 10px; }

        /* [新增] Loading 界面样式优化 */
        .loading-icon {
            width: 100px;
            height: 100px;
            margin-bottom: 25px;
            
            /* 纯净图片展示 */
            background-position: center;
            background-size: contain;
            background-repeat: no-repeat;
            background-color: transparent; /* 确保无背景色 */
            border: none !important;       /* 强制去描边 */
            box-shadow: none !important;   /* 强制去阴影 */
            
            /* 浮动动画 */
            animation: floating 2s ease-in-out infinite;
        }

        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }

        /* [优化] 小贴士文字：更宽、更大、更清晰 */
        .loading-tips-text {
            margin-top: 20px;
            font-size: 16px;  /* [修改] 字号再加大 */
            color: rgba(255, 255, 255, 0.75); /* [修改] 稍微提亮颜色，但不纯白 */
            text-align: center;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5); /* 增加一点文字阴影增加可读性 */
            
            /* 强制单行逻辑 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            
            /* [修改] 使用视口宽度，突破父容器限制 */
            width: 90vw;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            
            line-height: 1.5;
            font-weight: 500;
            opacity: 0.9;
            transition: opacity 0.3s ease;
        }
        
        /* SVG Chart */
        .chart-container { width: 100%; height: clamp(140px, 22vh, 210px); position: relative; margin-top: 12px; margin-bottom: 6px; border-bottom: 2px solid #ddd; border-left: 2px solid #ddd; box-sizing: border-box; }
        .chart-tooltip { position: absolute; background: rgba(0,0,0,0.85); color: white; padding: 6px 10px; border-radius: 6px; font-size: 12px; pointer-events: none; opacity: 0; transition: opacity 0.2s, transform 0.1s; z-index: 100; white-space: pre; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); }
        .chart-point { fill: var(--primary); stroke: white; stroke-width: 2; cursor: pointer; transition: r 0.2s; transform-box: fill-box; transform-origin: center; transform: scale(0); opacity: 0; }
        .chart-point:hover { r: 6; }
        .chart-point.animate { animation: popPoint 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes popPoint { to { transform: scale(1); opacity: 1; } }

        .chart-line { fill: none; stroke: var(--primary); stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; will-change: stroke-dashoffset; }
        
        .chart-label { font-size: 10px; fill: #999; text-anchor: middle; opacity: 0; animation: fadeIn 0.5s ease forwards 0.3s; }

        /* Loading Button Hover */
        #btn-start:hover { transform: translateY(8px) scale(1.05) !important; filter: brightness(1.05); box-shadow: 0 10px 0 #c7a000 !important; }
        #btn-start:active { transform: translateY(12px) !important; box-shadow: 0 4px 0 #c7a000 !important; }
        #start-screen #btn-start {
            font-size: 24px;
        }

        #loading-content {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #loading-content.hidden {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
        }

        #start-screen {
            position: absolute;
            inset: 0;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #FFFFFF;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        #start-screen.active {
            display: flex;
            animation: homeFadeIn 0.3s ease forwards;
        }
        .home-title {
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .home-title-logo {
            max-width: min(420px, 70vw);
            height: auto;
            display: block;
            animation: titlePopIn 0.6s ease-out forwards;
            transform-origin: center center;
        }
        @keyframes titlePopIn {
            0% {
                transform: scale(0.7);
                opacity: 0;
            }
            60% {
                transform: scale(1.06);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        .home-main-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }
        .home-top-right {
            position: absolute;
            top: 24px;
            left: 30px;
            right: 24px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            z-index: 100; /* [Fix] Ensure buttons are clickable */
        }
        .home-balance {
            min-width: 140px;
            height: 48px;
            padding: 0 16px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.35);
            background: rgba(0,0,0,0.25);
            color: #ffffff;
            font-size: 16px;
            font-weight: 700;
            cursor: default;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
            backdrop-filter: blur(8px);
        }
        .balance-alert {
            color: #e74c3c !important;
        }
        .balance-shake {
            animation: balanceShake 0.4s ease;
        }
        @keyframes balanceShake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            50% { transform: translateX(3px); }
            75% { transform: translateX(-2px); }
            100% { transform: translateX(0); }
        }
        .home-btn-secondary {
            min-width: 140px;
            height: 48px;
            padding: 0 16px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.35);
            background: rgba(0,0,0,0.25);
            color: #ffffff;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
            backdrop-filter: blur(8px);
            transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
        }
        .home-btn-secondary:hover {
            transform: translateY(-2px);
            background: rgba(0,0,0,0.35);
            box-shadow: 0 4px 12px rgba(0,0,0,0.35);
        }
        .home-btn-secondary:active {
            transform: translateY(1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
        }

        @keyframes homeFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .urgent { animation: urgentFlash 0.6s infinite alternate; }
        @keyframes urgentFlash { from { background-color: #fff9c4; } to { background-color: #ffab91; } }
        @keyframes shake { 0% {left:0} 25% {left:2px} 75% {left:-2px} 100% {left:0} }

        /* Toast Message */
        .toast-msg {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 24px;
            font-weight: 700;
            z-index: 5000;
            pointer-events: none;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            animation: toastFade 2s ease-in-out forwards;
            white-space: nowrap;
            letter-spacing: 1px;
            border: 2px solid rgba(255,255,255,0.1);
        }
        @keyframes toastFade {
            0% { opacity: 0; transform: translate(-50%, -40%) scale(0.9); }
            15% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            85% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -60%) scale(1.05); }
        }

        .base-button-reset {
            position: absolute;
            bottom: 30px;
            left: 30px;
            width: 46px;
            height: 46px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            font-size: 20px;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            outline: none;
            backdrop-filter: blur(4px);
        }
        .base-button-reset:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        #btn-settings {
            left: 80px; /* Position to the right of reset button */
        }

        /* Settings Modal Styles */
        #settings-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            animation: fadeIn 0.3s ease;
        }
        #settings-modal .modal {
            background: #FFFFFF;
            color: #333333;
            border-radius: 20px;
            padding: 30px;
            width: 320px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 20px;
            border: 1px solid #eee;
        }
        #settings-modal h2 {
            margin: 0;
            font-size: 24px;
            text-align: center;
            color: #333;
        }
        .settings-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .settings-item:last-child {
            border-bottom: none;
        }
        .settings-label {
            font-weight: 600;
            font-size: 16px;
        }
        #settings-modal .close-btn {
            background: #FCC307;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 12px;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }
        #settings-modal .close-btn:hover {
            transform: scale(1.02);
            filter: brightness(1.1);
        }

        /* 情报标签样式 - 位于标题上方 */
.prep-trend-tag {
    font-size: 15px;
    color: #f1c40f;
    font-weight: 700;
    margin-bottom: 6px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(241, 196, 15, 0.15);
    padding: 4px 12px;
    border-radius: 4px;
    border-left: 3px solid #f1c40f;
    animation: slideInRight 0.5s ease-out forwards;
}
@keyframes slideInRight {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
}

@media (max-width: 768px) {
            #game-title { font-size: 22px; }
            /* Mobile adjustments for larger cards */
            .station {
                width: 100%;
                max-width: 480px;
                height: auto;
                min-height: 150px;
                padding: 14px 16px;
                background: transparent;
                border: none;
                box-shadow: none;
            }
            .station-right { padding-top: 6px; gap: 10px; }
            .progress-box { height: 12px; margin-bottom: 10px; }
            .action-btn { height: 42px; font-size: 18px; border-radius: 10px; }
            .dish-icon { font-size: 42px; }
            .dish-info { font-size: 18px; height: 24px; margin-top: 2px; }
            .dish-status { font-size: 14px; height: 20px; }
            
            #hud { height: 60px; font-size: 14px; }
            .stat-val { font-size: 18px; }
            .modal { width: min(360px, calc(100vw - 36px)); padding: 26px 22px; max-height: 86vh; }
            .modal h2 { font-size: 22px; }
            .modal button { width: 100%; box-sizing: border-box; }
        }

        /* Achievement Modal Styles - Light Mode */
        #achievement-modal .modal {
            background: #FFFFFF; /* Light theme */
            color: #333333;
            border: 1px solid #e0e0e0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            padding: 30px;
            width: 700px;
            max-width: 95vw;
            display: flex; /* Ensure flex layout */
            flex-direction: column;
            max-height: min(85vh, 750px); /* Limit height */
            overflow: hidden; /* Hide overflow of container */
            border-radius: 16px;
        }
        #achievement-modal.grade-S .modal {
            border-color: #f1c40f;
            box-shadow: 0 0 50px rgba(241, 196, 15, 0.45);
        }
        #achievement-modal.grade-A .modal {
            border-color: #f1c40f;
            box-shadow: 0 0 40px rgba(241, 196, 15, 0.25);
        }
        #achievement-modal.grade-B .modal {
            border-color: #bdc3c7;
            box-shadow: 0 0 40px rgba(189, 195, 199, 0.35);
        }
        #achievement-modal.grade-C .modal {
            border-color: #e67e22;
            box-shadow: 0 0 40px rgba(230, 126, 34, 0.35);
        }
        .ach-content { 
            width: 100%; 
            padding: 15px 0 5px 0; 
            overflow-y: visible; /* Remove scrollbar */
            flex: 1; 
            min-height: 0; 
            margin-bottom: 10px; 
        }
        .ach-grade-box {
            display: flex; flex-direction: column; align-items: center; margin-bottom: 15px; flex-shrink: 0;
        }
        .ach-grade-badge {
            width: 80px; height: 80px; line-height: 80px;
            border-radius: 50%; background: linear-gradient(135deg, #f1c40f, #d35400);
            color: white; font-size: 48px; font-weight: 900;
            margin: 0 auto 5px;
            text-align: center;
            animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-family: 'OPPOSans', sans-serif;
        }
        #achievement-modal.grade-S .ach-grade-badge {
            background: linear-gradient(135deg, #111111, #f1c40f);
            color: #fdfcfb;
        }
        #achievement-modal.grade-A .ach-grade-badge {
            background: linear-gradient(135deg, #f9e79f, #f1c40f);
            color: #5c4b11;
        }
        #achievement-modal.grade-B .ach-grade-badge {
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
            color: #444444;
        }
        #achievement-modal.grade-C .ach-grade-badge {
            background: linear-gradient(135deg, #e67e22, #b3580c);
            color: #2b1303;
        }
        .ach-grade-title { font-size: 14px; color: #666; letter-spacing: 1px; text-transform: uppercase; font-weight: 600; }
        
        .ach-stats-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        .ach-stat-item { 
            display: flex; flex-direction: column; align-items: center; 
            background: #f8f9fa; padding: 10px 5px; border-radius: 12px;
            border: 1px solid #eee;
            transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
        }
        .ach-stat-item:hover { background: #f1f3f5; transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        .ach-stat-label { font-size: 12px; color: #555; margin-bottom: 4px; font-weight: 600; }
        .ach-stat-val { font-size: 20px; font-weight: 700; color: #333; font-family: 'OPPOSans', sans-serif; }
        
        /* Metric Colors - Adjusted for Light Mode */
        .val-gold { color: #d4ac0d; }
        .val-green { color: #27ae60; }
        .val-red { color: #c0392b; }
        
        .ach-chart-box {
            background: #fff; border-radius: 12px; padding: 10px;
            height: 160px; display: flex; align-items: center; justify-content: center;
            margin-top: 10px;
            margin-bottom: 15px; border: 1px solid #eee;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.02);
        }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* Location Selection View (Map Screen) */
        #map-screen {
            position: absolute !important;
            inset: 0;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 3500;
            display: none;
            flex-direction: column;
            justify-content: flex-end; /* Align to bottom for Step 1 */
            padding: 0;
            box-sizing: border-box;
            background: #000 url('assets/bg/餐厅解锁地图.jpg') no-repeat center center / contain;
            animation: fadeIn 0.3s ease;
            color: #2c3e50;
        }

        /* 批量修改附属界面的定位 - 强制铺满容器 */
        .shop-overlay, 
        #achievement-modal, 
        #settings-modal, 
        #overlay, 
        #pause-overlay, 
        #end-game-modal, 
        .prep-overlay { 
            position: absolute !important; 
            top: 0; left: 0; 
            /* [核心修改] 强制使用 100% 填满 1920x1080 画板，覆盖 100vw */ 
            width: 100% !important; 
            height: 100% !important; 
            inset: 0; 
        }

        /* Top Header (Floating) */
        .loc-header-float {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            /* [修改] 弱化背景，去除按钮感 */
            background: rgba(255, 255, 255, 0.05); /* 更淡的背景 */
            backdrop-filter: blur(8px); /* 减弱模糊 */
            padding: 10px 25px; /* 减少内边距 */
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1); /* 弱化边框 */
            box-shadow: none; /* 移除阴影 */
            max-width: 400px;
            text-align: center;
            z-index: 10;
        }
        
        /* Independent Return Button */
        .loc-back-btn {
            position: absolute;
            top: 40px;
            left: 40px;
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 999px;
            min-height: 36px;
            z-index: 10;
        }
        
        .loc-back-btn:active {
            transform: translateY(1px);
            opacity: 0.9;
        }
        .loc-header-float h2 {
            margin: 0 0 5px 0;
            font-size: 24px;
            font-weight: 900;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        @media (max-width: 600px) {
            .loc-back-btn {
                top: 20px;
                left: 20px;
            }
            .loc-header-float {
                top: 70px;
                width: 90%;
                padding: 12px;
            }
            .loc-header-float h2 { font-size: 18px; }
        }
        .loc-header-float .loc-subtitle {
            font-size: 14px;
            color: rgba(255,255,255,0.9);
            font-weight: 500;
        }

        /* Step 1: Bottom Dock for Regions */
        .region-dock {
            width: 100%;
            padding: 30px 40px;
            display: flex;
            gap: 24px;
            overflow-x: auto;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
            align-items: flex-end;
            justify-content: center;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .region-dock.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
        }
        .region-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 15px 20px;
            min-width: 140px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .region-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-10px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        .region-card.locked {
            opacity: 0.5;
            filter: grayscale(1);
            cursor: not-allowed;
        }
        .region-card .r-flag { font-size: 48px; margin-bottom: 8px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        .region-card .r-name { font-size: 18px; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .region-card .r-desc { font-size: 12px; opacity: 0.8; margin-top: 4px; }

        /* Step 2: Center Modal for Districts */
        .district-panel-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            background: rgba(20, 20, 20, 0.75);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 3600;
        }
        .district-panel-container.active {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }
        .dp-header {
            margin-bottom: 24px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .dp-title { font-size: 22px; color: white; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .dp-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; padding-right: 5px; }
        
        /* District Item Card */
        .district-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            color: #fff;
        }
        .district-item:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }
        .district-item.active {
            background: rgba(241, 196, 15, 0.15);
            border-color: #f1c40f;
        }
        .district-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .di-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .di-name {
            font-size: 17px;
            font-weight: bold;
            color: white;
        }
        .di-tag {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .tag-locked { background: #7f8c8d; color: #fff; }
        .tag-expensive { background: #d35400; color: #fff; }
        .tag-open { background: #27ae60; color: #fff; }

        .di-info {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px 12px;
            line-height: 1.4;
        }
        .di-info div {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .panel-actions {
            margin-top: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* Action Buttons */
        .glass-btn {
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.2s;
            text-align: center;
        }
        .btn-primary-glass {
            background: rgba(241, 196, 15, 0.9);
            color: #2c3e50;
            border: none;
            box-shadow: 0 4px 12px rgba(241, 196, 15, 0.3);
        }
        .btn-primary-glass:hover {
            background: #f39c12;
            transform: translateY(-2px);
        }
        .btn-outline-glass {
            background: transparent;
            color: rgba(255,255,255,0.8);
        }
        .btn-outline-glass:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        /* Cursor & Shelf */
        #drag-cursor {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            font-size: 40px;
            transform: translate(-50%, -50%);
            display: none;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3);
            will-change: transform;
            top: 0;
            left: 0;
        }
        .ingredient-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: transparent;
            border: none;
            border-radius: 12px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 70px;
        }
        .ingredient-btn:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .ingredient-btn:active { transform: scale(0.95); }
        .ingredient-btn:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
        .ing-icon { font-size: 28px; margin-bottom: 4px; text-shadow: 0 2px 2px rgba(0,0,0,0.3); pointer-events: none; will-change: transform; }
        .ing-name { font-size: 12px; font-weight: bold; color: #f0f0f0; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        .ing-stock { font-size: 10px; color: #999; background: rgba(0,0,0,0.4); padding: 2px 6px; border-radius: 10px; margin-top: 4px; border: 1px solid rgba(255,255,255,0.1); }

        /* New Station Styles */
        .station-body { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; }
        .ingredient-list { display: flex; gap: 4px; min-height: 30px; margin: 5px 0; flex-wrap: wrap; justify-content: center; }
        .ing-mini { font-size: 20px; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        
        .st-idle { border-color: #bdc3c7 !important; }
        .st-ready { border-color: #2ecc71 !important; box-shadow: 0 0 15px rgba(46, 204, 113, 0.4); }
        .st-cooking { border-color: #e67e22 !important; }
        .st-finished { border-color: #f1c40f !important; animation: pulseGold 2s infinite; }
        
        @keyframes pulseGold { 0% { box-shadow: 0 0 0 rgba(241, 196, 15, 0.4); } 50% { box-shadow: 0 0 20px rgba(241, 196, 15, 0.8); } 100% { box-shadow: 0 0 0 rgba(241, 196, 15, 0.4); } }

        .trash-btn {
            background: none; border: none; font-size: 18px; cursor: pointer; opacity: 0.6; transition: opacity 0.2s;
            position: absolute; top: 10px; right: 10px;
        }
        .trash-btn:hover { opacity: 1; transform: scale(1.1); }

        .dp-list::-webkit-scrollbar { width: 6px; }
        .dp-list::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .dp-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }


        .loc-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.22);
        }
        .loc-btn:disabled {
            background: #bdbdbd;
            border-color: #9e9e9e;
            color: #666666;
            cursor: not-allowed;
            box-shadow: 0 4px 0 #9e9e9e;
            transform: none;
            filter: none;
        }
        .loc-btn-outline {
            margin-top: 10px;
            padding: 10px 18px;
            font-size: 16px;
            background: #ffffff;
            color: #555555;
            border-radius: 12px;
            border: 2px solid #bdc3c7;
            box-shadow: none;
            font-weight: 600;
        }
        .loc-btn-outline:hover {
            transform: none;
            filter: none;
            background: #f7f7f7;
            box-shadow: none;
        }

        @media (max-width: 900px) {
            #map-screen { padding: 16px; }
            .loc-shell { border-radius: 20px; }
            .loc-container { flex-direction: column; padding: 10px 0 0; max-height: 75vh; }
            .loc-map-panel { flex: none; }
            .map-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        @media (max-width: 600px) {
            #map-screen { padding: 10px; }
            .loc-header { padding: 10px 12px; }
            .loc-header h2 { font-size: 18px; }
            .loc-subtitle { font-size: 12px; }
            .loc-container { padding: 8px 0 0; }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .shop-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background-color: #000;
            z-index: 10000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .shop-overlay::before {
            content: "";
            position: absolute;
            top: -10px; left: -10px; right: -10px; bottom: -10px;
            background-image: url('assets/bg/商店背景.jpg');
            background-size: cover;
            background-position: center;
            filter: blur(5px);
            z-index: 0;
        }
        .shop-overlay::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.65);
            z-index: 0;
        }
        .shop-modal {
            width: 100%; height: 100%;
            background: transparent;
            border-radius: 0;
            border: none;
            box-shadow: none;
            display: flex; flex-direction: column;
            padding: 0; box-sizing: border-box;
            color: #ecf0f1;
            position: relative;
            z-index: 1;
        }
        .shop-header {
            flex: 0 0 auto;
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 0;
        }
        .shop-back-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: #ecf0f1;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            padding: 8px 22px;
            border-radius: 999px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
            margin-right: 15px;
            height: 40px;
            box-sizing: border-box;
        }
        .shop-back-btn:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-1px);
            border-color: rgba(255,255,255,0.5);
        }
        .shop-back-btn:active {
            transform: translateY(1px);
        }
        .shop-title {
            font-size: 28px; font-weight: 900; 
            color: #ecf0f1;
            letter-spacing: 2px;
        }

        .shop-tabs {
            flex: 0 0 auto;
            display: flex;
            padding: 10px 20px 0;
            gap: 12px;
        }
        .shop-tab {
            padding: 8px 18px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            color: #bdc3c7;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            transition: background 0.15s, transform 0.15s, box-shadow 0.15s;
            backdrop-filter: blur(4px);
        }
        .shop-tab.active {
            background: linear-gradient(135deg, #f1c40f, #e67e22);
            color: #2c3e50;
            box-shadow: 0 4px 10px rgba(0,0,0,0.12);
            border-color: rgba(241,196,15,0.8);
        }
        .shop-tab:hover {
            transform: translateY(-1px);
        }
        #shop-items-container {
            flex: 1; overflow-y: auto; 
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 20px; padding: 20px;
            align-content: start;
        }

        /* Pagination Styles */
        .shop-pagination {
            flex: 0 0 60px; /* 固定高度 */
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            backdrop-filter: blur(10px);
        }
        .shop-page-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 24px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .shop-page-btn:not(:disabled):hover {
            background: #f1c40f;
            color: #2c3e50;
            transform: scale(1.05);
        }
        .shop-page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        .shop-page-info {
            color: #ecf0f1;
            font-size: 18px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }
        @media (max-width: 1024px) {
            #shop-items-container { 
                gap: 12px; padding: 15px; 
                grid-template-columns: repeat(3, 1fr);
            }
            .shop-item-name { font-size: 16px; }
        }
        @media (max-width: 768px) {
            #shop-items-container { 
                gap: 8px; padding: 10px; 
                grid-template-columns: repeat(2, 1fr);
            }
            /* Mobile Optimization: Adjust proportion */
            .shop-item-image-container { height: 60% !important; min-height: 120px; } /* [优化] 移动端同步提升图片占比 */
            .shop-item-content { padding: 8px 10px !important; }
            
            .shop-item-category { font-size: 9px; }
            .shop-item-name { font-size: 13px; }
            .shop-item-level { font-size: 9px; padding: 2px 4px; }
            .shop-item-desc { font-size: 10px; -webkit-line-clamp: 2; margin-bottom: 2px !important; }
            .shop-item-effect { font-size: 10px; margin-bottom: 4px !important; }
            .shop-btn-buy { padding: 4px; font-size: 11px; border-radius: 4px; }
        }
        #shop-items-container::-webkit-scrollbar { width: 8px; }
        #shop-items-container::-webkit-scrollbar-track { background: transparent; }
        #shop-items-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        /* Refactored Shop Item Card */
        .shop-item-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; 
            padding: 0; /* Remove padding to allow full-width image */
            display: flex; flex-direction: column;
            transition: all 0.2s ease;
            position: relative; overflow: hidden;
            backdrop-filter: blur(4px);
            height: 100%; /* Ensure uniform height in grid */
        }
        
        /* Image Container - Significantly increased area & Visual Polish */
        .shop-item-image-container {
            width: 100%;
            height: 65%; /* [优化] 图片区域占比提升至 65% */
            min-height: 160px; /* Safety minimum */
            background: radial-gradient(circle at center, rgba(255,255,255,0.08) 0%, rgba(0,0,0,0.15) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px; /* [优化] 减少内边距，让图片更大 */
            box-sizing: border-box;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: background 0.3s ease;
        }
        .shop-item-card:hover .shop-item-image-container {
            background: radial-gradient(circle at center, rgba(255,255,255,0.12) 0%, rgba(0,0,0,0.1) 100%);
        }
        
        .shop-item-icon {
            /* Reset old styles */
            width: 100%;
            height: 100%;
            font-size: 60px; /* For emoji fallback */
            margin-bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.4)); /* Enhanced shadow */
        }
        
        .shop-item-icon img {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain !important; /* [优化] 自适应填充，完整展示 */
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
            transition: transform 0.3s ease;
        }
        
        .shop-item-card:hover .shop-item-icon img {
            transform: scale(1.1);
        }

        /* Content Container */
        .shop-item-content {
            padding: 8px 10px; /* [优化] 紧凑内边距 */
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px; /* [优化] 减小间距 */
        }

        .shop-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 4px; /* [优化] 减小底部间距 */
        }
        
        .shop-item-title-group {
            display: flex;
            flex-direction: column;
        }

        .shop-item-category { 
            font-size: 9px; color: #bdc3c7; font-weight: bold; /* [优化] 更小的字体 */
            text-transform: uppercase; letter-spacing: 1px; 
            margin-bottom: 2px;
        }
        
        .shop-item-name { 
            font-size: 14px; font-weight: bold; color: #ecf0f1; /* [优化] 调整标题大小 */
            line-height: 1.2;
            margin-bottom: 0;
        }
        
        .shop-item-level { 
            font-size: 10px; color: #bdc3c7; background: rgba(255,255,255,0.1); 
            padding: 2px 6px; border-radius: 4px; /* [优化] 更紧凑的等级标签 */
            white-space: nowrap;
            margin-left: 6px;
            height: fit-content;
        }

        .shop-item-desc { 
            font-size: 11px; /* [优化] 更小的描述字体 */
            color: #bdc3c7; 
            line-height: 1.4; 
            
            /* 强制卡片内容适配，防止溢出 */
            display: -webkit-box;
            -webkit-line-clamp: 2; /* 限制描述最多2行 */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
            
            flex-grow: 1; /* Push footer down */
        }
        
        .shop-item-effect { 
            font-size: 11px; color: #2ecc71; margin-bottom: 4px; font-weight: bold; /* [优化] 更小的特效字体 */
            display: flex; align-items: center; gap: 4px;
        }
        .shop-item-effect::before { content: "✨"; font-size: 10px; }

        .shop-item-footer {
            margin-top: auto;
        }
        
        /* [新增] 紧凑按钮样式 */
        .shop-btn-buy {
            padding: 6px 0;
            width: 100%;
            font-size: 12px;
            font-weight: bold;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        /* Hover Effects */
        .shop-item-card:hover {
            transform: translateY(-4px);
            border-color: rgba(241, 196, 15, 0.6);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            background: rgba(255, 255, 255, 0.12);
        }

        .shop-item-card.owned-card {
            background: rgba(46, 204, 113, 0.15);
            border-color: rgba(46, 204, 113, 0.3);
        }
        .shop-item-card.owned-card .shop-item-name { color: #2ecc71; }
        
        .shop-item-card.digital-card {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        .shop-item-card.digital-card:hover {
            border-color: rgba(52, 152, 219, 0.6);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.15);
        }
        .shop-btn-buy {
            width: 100%; padding: 12px; border-radius: 10px; border: none;
            font-size: 15px; font-weight: bold; cursor: pointer;
            transition: all 0.18s; display: flex; align-items: center; justify-content: center; gap: 6px;
            margin-top: auto;
        }
        .shop-btn-buy.can-buy {
            background: linear-gradient(135deg, #f1c40f, #f39c12); color: #2c3e50;
            box-shadow: 0 4px 0 #d4ac0d;
        }
        .shop-btn-buy.can-buy:hover { filter: brightness(1.06); transform: translateY(-2px); box-shadow: 0 6px 0 #d4ac0d; }
        .shop-btn-buy.can-buy:active { transform: translateY(2px); box-shadow: 0 2px 0 #d4ac0d; }
        .shop-btn-buy.disabled {
            background: #bdc3c7; color: #ecf0f1; cursor: pointer;
            box-shadow: none; opacity: 0.8;
        }
        .shop-btn-buy.maxed {
            background: #2ecc71; color: white; cursor: default;
            box-shadow: none;
        }
        .shop-btn-buy.flash {
            animation: shopFlash 0.4s ease-out;
        }
        @keyframes shopFlash {
            0% { box-shadow: 0 0 0 rgba(241,196,15,0.0); transform: scale(1); }
            50% { box-shadow: 0 0 18px rgba(241,196,15,0.9); transform: scale(1.04); }
            100% { box-shadow: 0 0 0 rgba(241,196,15,0.0); transform: scale(1); }
        }

        .shop-header-left { display: flex; align-items: center; }

        .shop-item-category { font-size: 12px; color: #bdc3c7; font-weight: bold; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 1px; }
        .digital-badge { 
            background: linear-gradient(135deg, #3498db, #2980b9); 
            color: white; 
            font-size: 10px; 
            padding: 2px 6px; 
            border-radius: 4px; 
            margin-left: 6px; 
            vertical-align: middle; 
            font-weight: 800;
            box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
        }


        .stat-val {
            font-weight: bold;
            color: #333;
        }

 
    /* --- 清晨集市 (Prep Market) 极致优化版样式 --- */
    .prep-overlay { 
        position: fixed; inset: 0; z-index: 10000; 
        display: flex; flex-direction: column; 
        background: transparent; /* 背景由 prep-bg 统一管理 */
        animation: fadeIn 0.3s ease; 
    } 
    .prep-bg { 
        position: absolute; inset: -20px; 
        /* background: url('assets/bg/白天菜市场.png') no-repeat center center / cover; */
        background: #333; /* Default fallback color */
        z-index: 0; 
        transform: scale(1.05);
        /* [优化] 背景渐进模糊 */
        filter: blur(0px);
        will-change: filter;
        animation: bgBlur 2.0s ease 0.5s forwards;
    }
    /* .prep-curtain styles moved to bottom */

    /* [重构] 聊天流容器 - 稍微上移，给底部立绘留空间 */
    #chat-history-container {
        position: absolute;
        bottom: 12%;
        left: 50%;
        transform: translateX(-50%);
        width: 95%;
        max-width: 900px; /* 加宽容器 */
        display: flex;
        flex-direction: column;
        gap: 25px; /* 增加行间距 */
        justify-content: flex-end;
        z-index: 5001;
        pointer-events: none;
    }
    /* 单条消息行 */
    .chat-row {
        display: flex;
        align-items: flex-start; /* [修改] 改为顶部对齐，确保气泡间距一致 */
        gap: 15px;
        width: 100%;
        opacity: 0;
        transform: translateY(30px);
        animation: msgSlideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    
    /* 左侧角色 (A) */
    .chat-row.left {
        flex-direction: row;
        padding-right: 60px;
    }
    
    /* 右侧角色 (B) */
    .chat-row.right {
        flex-direction: row-reverse;
        padding-left: 60px;
    }
    
    /* [重构] 立绘容器：作为定位基准 */
    .chat-portrait-box {
        position: relative; /* 关键：为绝对定位的图片提供坐标系 */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end; /* 内容底部对齐 */
        width: 100px; /* 稍微占宽一点，防止气泡贴太死 */
        flex-shrink: 0;
        height: 140px; /* 给容器一个基础高度，确保布局不塌陷 */
        z-index: 10; /* [关键] 确保立绘在气泡之上 */
    }

    /* [重构] 立绘图片：巨大化 + 绝对定位 */
    .chat-portrait-img {
        position: absolute;
        bottom: 20px; /* 稍微上移，给底部的名字留位置 */
        left: 50%;
        transform: translateX(-50%); /* 水平居中 */
        width: 220px;  /* [放大] 宽度极大增加 */
        height: 240px; /* [放大] 高度极大增加 */
        object-fit: contain;
        object-position: bottom center; /* 确保脚部/底部对齐 */
        filter: drop-shadow(0 5px 15px rgba(0,0,0,0.4));
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        pointer-events: none; /* 防止大图挡住点击 */
        z-index: 20; /* 极高层级 */
    }

    /* 名字条：保持在最底部 */
    .chat-role-name {
        position: relative;
        z-index: 25; /* 名字在立绘之上 */
        font-size: 13px;
        color: rgba(255,255,255,0.95);
        text-shadow: 0 1px 3px rgba(0,0,0,0.9);
        background: rgba(0,0,0,0.6);
        padding: 4px 10px;
        border-radius: 12px;
        margin-top: auto; /* 推到底部 */
        border: 1px solid rgba(255,255,255,0.2);
        max-width: 100px;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* 立绘占位符 - 兼容旧逻辑 */
    .chat-portrait-placeholder {
        width: 80px; /* [预留] 宽度增加 */
        height: 100px; /* [预留] 高度增加，模拟半身像比例 */
        border-radius: 12px; /* 改为圆角矩形 */
        background: #eee;
        color: #fff;
        font-size: 32px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 3px solid rgba(255,255,255,0.3);
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        transition: transform 0.2s;
    }
    
    /* 气泡本体 - 加大 */
    .chat-bubble {
        background: #fff;
        color: #2c3e50;
        padding: 18px 24px; /* [修改] 增加内边距 */
        border-radius: 20px;
        font-size: 22px; /* [修改] 增大字号 */
        font-weight: 500;
        line-height: 1.5;
        position: relative;
        box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        max-width: 100%;
        min-height: 50px; /* 确保最小高度 */
        display: flex;
        flex-direction: column; /* [修改] 改为纵向布局，确保按钮在文字下方 */
        align-items: flex-start;
        pointer-events: auto;
    }
    
    /* [调整] 左侧角色气泡：立绘在左，文字向右大幅避让 */
    .chat-row.left .chat-bubble {
        margin-left: -40px;
        margin-right: 20px;
        border-bottom-left-radius: 4px;
        z-index: 5;
        
        /* [核心修改] 加大两边留白 */
        padding-left: 110px !important;  /* 从 85px 进一步加大到 110px */
        padding-right: 30px !important;  /* 右边也增加一点呼吸感 */
    }
    /* [调整] 右侧角色气泡：立绘在右，文字向左大幅避让 */
    .chat-row.right .chat-bubble {
        margin-right: -40px;
        margin-left: 20px;
        border-bottom-right-radius: 4px;
        z-index: 5;
        background: #e1f5fe;

        /* [核心修改] 加大两边留白 */
        padding-right: 110px !important; /* 增加到 110px 统一遮挡安全区 */
        padding-left: 30px !important;   /* 左边也增加一点呼吸感 */
    }
    
    /* 进场动画 */
    @keyframes msgSlideUp {
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* 嵌入在最后一条消息里的按钮容器 */
    .chat-action-area {
        margin-top: 25px; /* [修改] 增加顶部间距，让按钮离文字更远 */
        width: 100%; /* 确保占满宽度 */
        display: flex;
        justify-content: flex-end;
    }

    /* 沉浸式文案样式 */
    .prep-intro-text {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        font-size: 24px; color: #fff; font-weight: 600; letter-spacing: 4px; /* [优化] 字重加粗 */
        text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        z-index: 5;
        opacity: 0;
        animation: introSequence 2.5s ease forwards;
        pointer-events: none;
        width: 100%; text-align: center;
    }

    /* 关键帧动画定义 */
    @keyframes bgBlur {
        0% { filter: blur(0px); }
        100% { filter: blur(8px); } /* [优化] 最终模糊度 */
    }
    @keyframes curtainDown {
        from { transform: scaleY(0); }
        to { transform: scaleY(1); }
    }
    @keyframes introSequence {
        0% { opacity: 0; transform: translate(-50%, -40%); }
        20% { opacity: 1; transform: translate(-50%, -50%); }
        80% { opacity: 1; transform: translate(-50%, -50%); }
        100% { opacity: 0; transform: translate(-50%, -60%); }
    }
    @keyframes uiFadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes footerSlideUp {
        from { opacity: 0; transform: translateY(100%); }
        to { opacity: 1; transform: translateY(0); }
    }

    .prep-container { 
        position: relative; z-index: 1; 
        display: flex; flex-direction: column; 
        height: 100%; width: 100%; 
        max-width: 1200px; /* [优化] 增加宽度，最大化利用屏幕 */
        margin: 0 auto; 
        padding: 15px 20px 0 20px; /* [优化] 底部Padding归零，让Footer贴底 */
        box-sizing: border-box; 
    } 
    .prep-header { 
        flex: 0 0 auto; margin-bottom: 15px; 
        padding-left: 15px; border-left: 6px solid #f1c40f; 
        display: flex; flex-direction: row; justify-content: space-between; align-items: flex-start;
        /* 动画：延迟淡入 */
    } 
    .prep-header-content { display: flex; flex-direction: column; }
    
    /* 返回按钮样式 */
    .btn-back {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #eee;
        padding: 0 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        backdrop-filter: blur(4px);
        display: flex; align-items: center; gap: 6px;
        height: 32px;
        margin-top: 2px; /* 视觉微调，与标题顶部对齐 */
        text-shadow: 0 1px 1px rgba(0,0,0,0.3);
    }
    .btn-back:hover { background: rgba(255, 255, 255, 0.25); transform: translateY(-1px); color: #fff; border-color: #fff; }
    .btn-back:active { transform: translateY(0); opacity: 0.8; } 

    /* [新增] 深色背景适配样式 */
    .btn-back.dark {
        color: #555; /* 深灰色文本 */
        border-color: rgba(0, 0, 0, 0.15); /* 浅灰边框 */
        background: rgba(255, 255, 255, 0.5); /* 半透明白色背景增强对比 */
        text-shadow: none;
    }
    .btn-back.dark:hover {
        background: rgba(255, 255, 255, 0.8);
        color: #000;
        border-color: rgba(0, 0, 0, 0.3);
    }
    .prep-title { font-size: 32px; font-weight: 900; color: #fff; letter-spacing: 2px; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.5); } 
    .prep-subtitle { font-size: 14px; color: rgba(255,255,255,0.8); margin-top: 4px; font-weight: 400; letter-spacing: 1px; } 
    
    .prep-grid { 
        flex: 1; overflow-y: auto; padding: 5px 15px; 
        display: flex; flex-direction: column; gap: 20px; 
        /* 滚动条规避：内容区域内部滚动 */
    } 
    .prep-grid::-webkit-scrollbar { width: 6px; } 
    .prep-grid::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; } 
    .prep-grid::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
    
    /* 分类区块样式 */ 
    .market-category { display: flex; flex-direction: column; gap: 10px; animation: slideInUp 0.4s ease forwards; } 
    .category-title { font-size: 18px; font-weight: 800; color: #f1c40f; display: flex; align-items: center; gap: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); padding-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); } 
    
    .category-items { 
        display: grid; 
        /* [优化] 增加卡片宽度：110px -> 130px (约+18%)，保持信息不拥挤 */
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); 
        gap: 12px; /* [优化] 增加间距 */
    } 

    /* 精致卡片样式 */ 
    .market-item-card { 
        background: rgba(255, 255, 255, 0.1); 
        border: 1px solid rgba(255, 255, 255, 0.15); 
        border-radius: 10px; padding: 12px 8px; /* [优化] 调整内边距 */
        display: flex; flex-direction: column; align-items: center; 
        backdrop-filter: blur(5px); 
        transition: all 0.2s ease-out; 
        position: relative; overflow: hidden; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
    } 
    .market-item-card:hover { transform: translateY(-3px); background: rgba(255, 255, 255, 0.18); border-color: #fff; box-shadow: 0 6px 12px rgba(0,0,0,0.2); } 
    .market-item-card.active { border: 1px solid #2ecc71; background: linear-gradient(160deg, rgba(46, 204, 113, 0.2), rgba(255,255,255,0.05)); } 
    
    .pc-icon { font-size: 36px; margin-bottom: 4px; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); transition: transform 0.2s; } 
    .market-item-card:hover .pc-icon { transform: scale(1.15) rotate(5deg); } 
    
    .pc-info { text-align: center; width: 100%; margin-bottom: 6px; } 
    .pc-name { font-size: 13px; font-weight: bold; color: #fff; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; } 
    .pc-price { font-size: 12px; color: #ffd700; font-weight: 600; display: inline-block; background: rgba(0,0,0,0.5); padding: 1px 6px; border-radius: 4px; } 
    
    /* 胶囊控制器 */ 
    .pc-controls { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.4); border-radius: 16px; padding: 2px; width: 100%; height: 26px; border: 1px solid rgba(255,255,255,0.1); } 
    .pc-btn { width: 22px; height: 22px; border-radius: 50%; border: none; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.1s; } 
    .pc-btn-minus { background: transparent; color: #fff; } 
    .pc-btn-minus:hover { background: rgba(255,255,255,0.3); } 
    .pc-btn-plus { background: #f1c40f; color: #000; box-shadow: 0 1px 3px rgba(0,0,0,0.2); } 
    .pc-btn-plus:hover { background: #f39c12; transform: scale(1.1); } 
    .pc-count { font-size: 14px; font-weight: bold; flex: 1; text-align: center; color: #fff; } 
    
    .prep-footer { 
        flex: 0 0 auto; background: rgba(15, 15, 15, 0.95); 
        border-top: 1px solid rgba(255,255,255,0.1); 
        padding: 18px 32px; /* [优化] 左右Padding改为32px */
        display: flex; justify-content: space-between; align-items: center; /* [优化] 改回两端对齐 */
        border-radius: 10px 10px 0 0; /* [优化] 顶部圆角10px，与卡片一致 */
        margin-top: 0; 
        box-shadow: 0 -4px 25px rgba(0,0,0,0.4); 
        width: 100%; max-width: 1200px; margin: 0 auto; 
        box-sizing: border-box;
    } 
    .pf-info { display: flex; flex-direction: column; } 
    .pf-label { font-size: 11px; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; } 
    .pf-val { font-size: 20px; font-weight: 900; color: #fff; font-family: 'Courier New', monospace; } 
    .pf-val.highlight { color: #f1c40f; } 
    
    .btn-start-day { 
        background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none; 
        padding: 0 30px; height: 44px; font-size: 16px; font-weight: 800; border-radius: 22px; 
        cursor: pointer; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4); 
        display: flex; align-items: center; gap: 8px; text-shadow: 0 1px 1px rgba(0,0,0,0.2); 
        transition: all 0.2s;
    } 
    .btn-start-day:hover { filter: brightness(1.15); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(46, 204, 113, 0.5); } 
    
    @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* [优化] 响应式设计：适配移动端 */
    @media (max-width: 768px) {
        .prep-container { padding: 10px 10px 0 10px; width: 100%; max-width: 100%; }
        .category-items { grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 8px; } /* 移动端保持较小 */
        .pc-icon { font-size: 30px; }
        .prep-footer { padding: 15px 20px; flex-direction: column; gap: 15px; align-items: stretch; border-radius: 0; }
        .pf-info { flex-direction: row; justify-content: space-between; align-items: center; }
        .btn-start-day { width: 100%; justify-content: center; }
        .prep-title { font-size: 24px; }
    }

/* --- 订单配方可视化样式 --- */
.order-item {
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 1px dashed rgba(0,0,0,0.1);
    padding: 4px 0;
}
.item-icon {
    font-size: 26px; /* 稍微调大菜品图标 */
    flex-shrink: 0;
    text-shadow: 0 2px 2px rgba(0,0,0,0.15);
}
.order-info-col {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
}
.item-name {
    font-size: 13px;
    font-weight: 700;
    color: #2c3e50;
    line-height: 1.1;
}
.recipe-tags {
    display: flex;
    align-items: center;
    gap: 3px;
    background: rgba(0,0,0,0.04);
    border-radius: 4px;
    padding: 1px 4px;
    width: fit-content;
}
.micro-ing {
    font-size: 11px;
    line-height: 1;
    cursor: help;
    opacity: 0.85;
}
    /* --- 地图界面重构样式 --- */
    #map-screen {
        /* [核心修改] 改为顶部对齐 + 居中，不再挤到底部 */
        justify-content: flex-start !important;
        align-items: center !important;
        padding-top: 120px !important; /* 留出顶部标题空间 */
        background: #000 url('assets/bg/餐厅解锁地图.jpg') no-repeat center center / cover !important;
    }

    /* [核心修改] 移除深色大面板背景，保留布局功能 */
    .region-dock {
        width: 90%;
        max-width: 1100px;
        height: auto;
        max-height: 80vh;
        background: transparent !important;
        backdrop-filter: none !important;
        border: none !important;
        box-shadow: none !important;
        padding: 40px 50px !important; /* 调整间距 */
        align-items: flex-start !important; /* 强制左对齐 */
        display: flex;
        flex-direction: column;
        gap: 30px; /* 上下分区的间距 */
        overflow-y: auto; /* 内容过多可滚动 */
        margin: 0 auto;
    }

    /* 标题增加背景条以保证在地图上的可读性 */
    .region-dock h3 {
        text-shadow: 0 2px 4px rgba(0,0,0,0.8) !important;
        background: rgba(0, 0, 0, 0.4); /* 轻微黑底 */
        padding: 8px 16px;
        border-radius: 8px;
        display: inline-block;
        backdrop-filter: blur(4px);
        border-left: 4px solid #f1c40f; /* 装饰线 */
    }
    /* [核心修改] “拓展新版图”区域改为左对齐 */
    .new-territory-container {
        justify-content: flex-start !important;
        padding-left: 10px;
    }

    /* 横向滚动容器通用样式 */
    .map-scroll-row {
        display: flex;
        flex-wrap: wrap; /* [核心] 允许换行，防止遮挡 */
        gap: 20px;
        width: 100%;
        padding-bottom: 10px;
        justify-content: center; /* 卡片居中排列 */
    }

    /* 国家卡片样式优化 */
    .region-card {
        min-width: 180px; /* 加宽 */
        height: 140px;
        background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        position: relative;
        overflow: visible; /* 允许角标溢出 */
    }
    .region-card:hover {
        transform: translateY(-5px) scale(1.02) !important;
        background: rgba(255,255,255,0.15);
        border-color: rgba(255,255,255,0.5);
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .region-card .r-flag {
        font-size: 56px;
        margin-bottom: 5px;
    }
    .region-card .r-name {
        font-size: 20px;
        font-weight: 800;
        color: #fff;
    }
    .region-card .r-desc {
        font-size: 13px;
        color: rgba(255,255,255,0.7);
    }

    /* 当前所在地的高亮样式 */
    .region-card.current-location {
        border: 2px solid #2ecc71;
        background: rgba(46, 204, 113, 0.15);
        box-shadow: 0 0 20px rgba(46, 204, 113, 0.2);
    }
    .current-badge {
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        background: #2ecc71;
        color: white;
        font-size: 12px;
        font-weight: bold;
        padding: 2px 10px;
        border-radius: 10px;
        white-space: nowrap;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    /* --- 地图 UI v3.0：水晶轻量化 --- */
    /* 1. 顶部资产区：完全透明，仅布局 */
    .region-dock {
        position: absolute;
        top: 90px;
        left: 50%;
        transform: translateX(-50%);
        width: 95%;
        max-width: 1200px;
        z-index: 3510;
        display: flex;
        flex-direction: column;
        pointer-events: none; /* 容器穿透 */
    }

    /* 标题样式：轻量化标签 */
    .map-section-title {
        font-size: 16px;
        font-weight: 800;
        color: #fff;
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(8px);
        padding: 6px 16px;
        border-radius: 20px;
        align-self: flex-start;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .empire-scroll-container {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        width: 100%;
        pointer-events: auto;
        justify-content: flex-start; /* 左对齐更自然 */
    }

    /* [核心] 帝国卡片：清透水晶风格 */
    .empire-card {
        /* 去除深色背景，改用高亮白透 */
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 16px;
        padding: 12px;
        min-width: 140px;
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); /* 柔和阴影 */
        position: relative;
        overflow: hidden;
    }

    /* 悬停高光 */
    .empire-card:hover {
        transform: translateY(-5px) scale(1.02);
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.8);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3), inset 0 0 20px rgba(255,255,255,0.2);
    }

    /* 文字增强：确保在地图背景上可见 */
    .empire-name {
        font-size: 14px;
        font-weight: 900;
        color: #fff;
        text-align: center;
        margin: 4px 0;
        text-shadow: 0 2px 4px rgba(0,0,0,0.8); /* 强投影 */
        line-height: 1.2;
    }
    .empire-info-row {
        font-size: 11px;
        color: #fff;
        font-weight: 700;
        text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        background: rgba(0,0,0,0.3);
        padding: 2px 8px;
        border-radius: 10px;
        margin-top: 4px;
    }

    /* 状态角标优化 */
    .card-badge {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        font-size: 10px;
        font-weight: 800;
        color: #fff;
        text-align: center;
        padding: 2px 0;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    .badge-live {
        background: linear-gradient(90deg, rgba(46, 204, 113, 0.8), rgba(39, 174, 96, 0.8));
    }
    .badge-money {
        background: linear-gradient(90deg, rgba(241, 196, 15, 0.8), rgba(243, 156, 18, 0.8));
    }

    /* 2. 底部导航栏：悬浮胶囊风格 */
    .map-bottom-bar {
        position: absolute;
        bottom: 30px; /* 悬浮，不贴底 */
        left: 50%;
        transform: translateX(-50%);
        width: 95%;
        max-width: 800px;
        height: 90px;
        
        /* 完全去除死板背景，改用渐变遮罩或纯透明 */
        background: rgba(20, 20, 20, 0.4); /* 极淡黑底用于衬托 */
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 24px; /* 大圆角 */
        display: flex;
        align-items: center;
        justify-content: center; /* 居中排列 */
        padding: 0 20px;
        gap: 15px;
        z-index: 3550;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .map-bottom-label {
        position: absolute;
        top: -30px;
        left: 20px;
        font-size: 14px;
        color: rgba(255,255,255,0.9);
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* 国家 Tab：透明水晶块 */
    .country-tab {
        flex: 1;
        max-width: 120px;
        height: 60px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }
    .country-tab:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .country-tab.active {
        background: rgba(255, 255, 255, 0.25);
        border-color: #fff;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
    }
    .tab-flag {
        font-size: 24px;
        line-height: 1;
        margin-bottom: 2px;
        filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
    }
    .tab-name {
        font-size: 12px;
        font-weight: 700;
        color: #fff;
        text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }

    .more-countries {
        font-size: 12px;
        color: rgba(255,255,255,0.6);
        font-weight: 600;
        padding: 0 15px;
        border-left: 1px solid rgba(255,255,255,0.1);
    }

    /* 3. 商圈面板：统一清透风格 */
    .district-panel-container {
        /* 覆写旧样式 */
        background: rgba(30, 30, 30, 0.6) !important; /* 降低不透明度 */
        backdrop-filter: blur(30px) !important; /* 强模糊 */
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        box-shadow: 0 30px 80px rgba(0,0,0,0.6) !important;
        border-radius: 30px !important;
    }
    .district-item {
        background: rgba(255, 255, 255, 0.08) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
    }
    .district-item:hover {
        background: rgba(255, 255, 255, 0.15) !important;
    }
    .current-indicator {
        position: absolute;
        top: -6px;
        right: -6px;
        width: 12px;
        height: 12px;
        background: #2ecc71;
        border-radius: 50%;
        border: 2px solid #1a1a1a;
        box-shadow: 0 0 5px #2ecc71;
    }
/* --- 商业版图 UI v3.5 微调 --- */ 
/* 1. 底部标题：横向 + 无阴影 */
.map-bottom-title { 
    writing-mode: horizontal-tb !important; /* 强制横向 */
    text-orientation: mixed !important; 
    text-shadow: none !important; /* 去除阴影 */
    height: auto !important; 
    margin-right: 25px !important; 
    padding-right: 25px !important; 
    border-right: 1px solid rgba(255, 255, 255, 0.2) !important; 
    letter-spacing: 1px !important; 
    font-size: 18px !important; 
    color: #ffffff !important; 
    display: flex; 
    align-items: center; 
    margin-left: -18px !important; /* 向左平移 */
} 

/* 2. 底部 Tab 文字：浅色 + 无阴影 */
.tab-name { 
    color: rgba(255, 255, 255, 0.7) !important; /* 浅色 */
    text-shadow: none !important; /* 去除阴影 */
    font-weight: 600 !important; 
} 
.country-tab.active .tab-name { 
    color: #fff !important; /* 选中时高亮 */
} 

/* 3. 帝国卡片文字：辅助信息去除阴影 */
.empire-country-tag, .empire-info-row { 
    text-shadow: none !important; 
    color: rgba(255, 255, 255, 0.9) !important; 
    font-weight: bold !important; /* 加粗 */
} 
/* 只有店名保留阴影，增强辨识度 */
.empire-name { 
    text-shadow: 0 2px 4px rgba(0,0,0,0.6) !important; 
} 

/* 新增：等待开放按钮样式 */ 
.country-tab.waiting { 
    opacity: 0.4; 
    cursor: not-allowed; 
    background: rgba(255, 255, 255, 0.02); 
    border-color: rgba(255, 255, 255, 0.05); 
}
        /* 底部标题布局优化：支持双行 */ 
    .map-bottom-title { 
        flex-direction: column !important; /* 改为垂直排列 */ 
        align-items: flex-start !important; /* 左对齐 */ 
        justify-content: center !important; 
        line-height: 1.2 !important; 
        padding-right: 20px !important; /* 调整间距 */ 
    } 
    .map-bottom-main-text { 
        font-size: 18px; 
        font-weight: 800; 
        color: #f1c40f; 
    } 
    .map-bottom-sub-text { 
        font-size: 11px; 
        color: rgba(255, 255, 255, 0.5); 
        font-weight: normal; 
        letter-spacing: 0.5px; 
    }
/* [新增] 底部导航双行标题样式 */
        .map-bottom-main-text {
            display: block;
            font-size: 18px;
            line-height: 1.2;
            font-weight: 800;
            color: #FFFFFF;
        }
        .map-bottom-sub-text {
            display: block;
            font-size: 11px;
            line-height: 1.2;
            color: #bdc3c7;
            font-weight: 600;
            margin-top: 4px;
        }
    
    /* 街坊情报站 */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* [新增] 动画辅助类 */
    .animate__animated {
        animation-duration: 0.5s;
        animation-fill-mode: both;
    }
    .animate__fadeIn {
        animation-name: fadeIn;
    }
    .animate__fadeInUp {
        animation-name: fadeInUp;
    }
    .animate__fadeOut {
        animation-name: fadeOut;
    }
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }

    /* --- [新增] 集市流程控制样式 --- */
    /* 采购界面元素的初始隐藏状态 */
    .prep-ui-hidden {
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.8s ease;
    }
    .prep-ui-visible {
        opacity: 1;
        pointer-events: auto;
    }

    /* [修改] 移除自动动画，初始状态设为 scaleY(0) */
    .prep-curtain {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 0;
        transform: scaleY(0); /* 初始收起 */
        transform-origin: top;
        pointer-events: none;
    }
    /* [新增] 激活时才播放下拉动画 */
    .prep-curtain.active {
        animation: curtainDown 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    /* [优化] 开始买菜按钮 - 视觉升级 */
    .btn-start-shopping {
        /* 基础尺寸与 btn-start-day 保持一致 */
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-top: 20px;
        padding: 12px 36px; /* 加大尺寸 */
        background: #2ecc71; /* 保持经典绿 */
        color: white;
        border-radius: 50px; /* 大圆角 */
        font-size: 18px;     /* 加大字号 */
        font-weight: 800;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    /* Hover 态：轻微上浮 + 变亮 */
    .btn-start-shopping:hover {
        transform: translateY(-2px);
        background: #27ae60;
        box-shadow: 0 6px 20px rgba(46, 204, 113, 0.6);
    }
    /* Active 态：按下缩放 */
    .btn-start-shopping:active {
        transform: translateY(1px) scale(0.98);
        box-shadow: 0 2px 10px rgba(46, 204, 113, 0.3);
    }
    @keyframes pulse-green {
        0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
        100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
    }

    /* [重构] 居中无闪烁对话框 */
    #market-chatter-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 5000; /* 极高层级，在集市 UI 之上 */
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.3); /* 轻微压暗背景 */
        backdrop-filter: blur(2px); /* 轻微模糊背景突出对话 */
        opacity: 0;
        animation: fadeIn 0.5s forwards;
    }

    .chatter-box-centered {
        width: 90%;
        max-width: 600px;
        /* [核心] 设定固定高度，防止按钮出现时跳动 */
        height: 260px;
        background: rgba(20, 20, 20, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.6);
        backdrop-filter: blur(12px);
        transform: translateY(20px);
        animation: slideUpFade 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        text-align: left;
        cursor: pointer;
        position: relative;
        /* [新增] 使用 Flex 布局垂直分布内容 */
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .chatter-speaker {
        font-size: 18px;
        font-weight: 800;
        color: #f1c40f;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .chatter-text {
        font-size: 20px;
        line-height: 1.6;
        color: #ecf0f1;
        font-weight: 500;
        /* [新增] 自动占据剩余空间，确保布局分布 */
        flex: 1;
        display: flex;
        align-items: flex-start; /* 文字顶对齐 */
        padding-top: 10px;
    }

    .chatter-hint {
        /* [新增] 固定底部高度，无论放文字还是按钮，高度一致 */
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: flex-end; /* 靠右对齐 */
        
        /* 字体样式 */
        margin-top: 0;
        font-size: 12px;
        color: rgba(255,255,255,0.4);
        font-weight: 700;
        letter-spacing: 1px;
        text-transform: uppercase;
    }

    @keyframes slideUpFade {
        to { transform: translateY(0); opacity: 1; }
    }

/* --- [修复] 灶台位置与动画逻辑 --- */
/* 1. 调整灶台位置：下移 28px + 16px = 44px */
.cook-machine .stove-bg {
    position: absolute;
    bottom: -87px !important; /* Modified to -87px */
    left: 50%;
    transform: translateX(-50%);
    width: 160px !important;
    height: auto !important;
    z-index: 0;
    pointer-events: none;
    display: block;
}

/* --- [核心修复] 灶台静止与动画分离 --- */
/* 1. 强制父容器静止 (覆盖旧的 active/finished 样式) */
.cook-machine.active, .cook-machine.finished {
    animation: none !important;
    transform: none !important;
    filter: none !important; /* 移除容器级发光，防止灶台发光 */
}

/* 2. 烹饪状态：只让锅抖动 */
.cook-machine.active .pot-main {
    animation: machineWork 0.5s infinite;
}

/* 3. 出餐状态：只让菜品容器放大+发光 (排除灶台) */
.cook-machine.finished > div {
    transform: scale(1.1);
    filter: drop-shadow(0 0 15px rgba(241, 196, 15, 0.9));
    transition: transform 0.2s;
}

/* 确保锅具和菜品悬浮在灶台之上 */
/* [修复] 排除 .omni-popout-bg，防止它被强制设为 relative */
.cook-machine > img:not(.stove-bg):not(.omni-popout-bg),
.cook-machine > div {
    position: relative;
    z-index: 2;
}

/* --- [核心修复] 烹饪区布局防抖动优化 --- */
/* 1. 进度条改为绝对定位 (彻底解决位移问题) */
.progress-bar-container {
    position: absolute !important;
    bottom: 45px; /* 固定在文字上方 */
    left: 50%;
    transform: translateX(-50%);
    width: 80% !important;
    z-index: 10;
    margin-top: 0 !important; /* 移除外边距 */
}

/* 2. 状态文字位置微调 (配合进度条) */
.dish-status {
    position: absolute !important;
    bottom: 15px; /* 固定在底部 */
    left: 0;
    width: 100%;
    z-index: 10;
}

/* 3. 机器容器恢复原位 (不刻意下移) */
.cook-machine {
    top: 0 !important;
    margin-top: -15px !important;
    margin-bottom: 0 !important;
    overflow: visible !important; /* 保持灶台溢出可见 */
}

/* 4. 容器布局恢复 */
.station-cook-zone {
    justify-content: flex-start !important; /* 保持顶对齐 */
    padding-top: 36px !important; /* [调整] 20px -> 36px (整体下移 16px) */
    padding-bottom: 70px !important; /* [新增] 底部留白，给绝对定位的进度条/文字留出空间 */
    position: relative; /* 确保绝对定位子元素参考此容器 */
}

/* [安全修改] 仅允许工位容器溢出，这不会影响内部普通灶台的布局 */
.station {
    overflow: visible !important;
    position: relative; /* 确保是定位基准 */
}
/* [新增] Omni 专用样式：破框、放大、沉底 */
/* [修复] 增加权重以覆盖 .cook-machine img 的 width: 100% !important */
.cook-machine img.omni-popout-bg {
    position: absolute !important; /* [强制] 确保绝对定位生效，不被通用样式覆盖 */
    bottom: -56px !important; /* [调整] 再上移 20px (原-76px) */
    left: 50% !important;
    transform: translateX(-50%) !important;
    width: 181.2% !important; /* [调整] 高度增加40px (154.5% -> 181.2%) */
    height: auto !important;
    z-index: 0 !important;
    pointer-events: none;
    filter: drop-shadow(0 10px 20px rgba(0,0,0,0.4));
}
/* [新增] 确保 UI 元素绝对居中且在最上层 (修复图片消失问题) */
.station-dish-icon {
    position: absolute !important;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 45px; /* 确保有固定尺寸 */
    height: 45px;
    z-index: 100 !important; /* 极高层级 */
}
.station-progress {
    position: absolute !important;
    bottom: 5px;
    left: 10%;
    width: 80%;
    z-index: 100 !important;
}
/* [新增] Omni 出餐图标悬浮动效 */
    @keyframes omni-dish-bounce {
        0%, 100% { transform: translate(-50%, -50%); }
        50% { transform: translate(-50%, calc(-50% - 10px)); }
    }
    
    /* [新增] 全局垃圾桶卡片：位于右侧垂直居中 */
/* [UI 优化] 全局垃圾桶：风格对齐 station-card (毛玻璃/透明卡片) */
    .global-trash-card {
        position: absolute;
        right: 45px; /* [调整] 向左平移 10px (35px -> 45px) */
        top: 55%;
        transform: translateY(-50%);
        margin-top: 18px; /* [调整] 向下平移 18px */
        
        width: 130px; /* [调整] 等比放大 (70px -> 130px) */
        height: 160px; /* [调整] 高度设为备菜卡片的一半 (85px -> 160px) */
        
        /* 风格：透明背景，与 Omni station 保持一致 */
        background: transparent !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        
        border-radius: 16px; /* 对齐 station-card */
        border: none; /* [修改] 去除描边，对齐 Omni 风格 */
        box-shadow: none; /* 对齐 station-card */
        
        /* 初始状态：必须隐藏！ */
        display: none;
        
        /* 布局与交互 */
        flex-direction: column;
        align-items: center;
        justify-content: center;
        
        /* 层级控制：低于暂停遮罩 (3100)，但在 HUD (20) 之上 */
        z-index: 50;
        
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    /* 悬停效果：对齐 station-card:hover */
    .global-trash-card:hover {
        border-color: rgba(255, 255, 255, 0.4);
        background: rgba(255, 255, 255, 0.05) !important;
    }

    /* 激活状态：清洁模式 */
    .global-trash-card.active {
        background: rgba(231, 76, 60, 0.15) !important; /* 红调透明 */
        border-color: #e74c3c;
        transform: translateY(-50%) scale(1.05);
        box-shadow: 0 0 15px rgba(231, 76, 60, 0.3) !important;
        z-index: 100; /* 激活时适当提升层级 */
    }
    
    .global-trash-icon {
        font-size: 58px; /* [调整] 等比放大 (32px -> 58px) */
        margin-bottom: 10px; /* [调整] 等比放大 (5px -> 10px) */
        filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3)); /* 增强投影 */
    }
    
    .global-trash-label {
        font-size: 18px; /* [调整] 等比放大 (11px -> 18px) */
        color: rgba(255, 255, 255, 0.9); /* 白色文字 */
        font-weight: 800; /* 加粗 */
        letter-spacing: 1px;
        text-shadow: 0 1px 3px rgba(0,0,0,0.8); /* 强阴影保证可读性 */
    }
    
    .global-trash-card.active .global-trash-label {
        color: #e74c3c;
        text-shadow: none;
    }
        /* [核心] 抽屉容器 */ 
    /* [视觉升级] 4A级 高保真木质食材柜 */ 
    #pantry-drawer { 
        position: absolute; 
        top: 22%; 
        bottom: 18%; 
        left: 0; 
        width: 70%; 
        max-width: 400px; 
        
        /* [材质核心] 逼真胡桃木纹理 stack */ 
        background-color: #3E2723; /* 深褐色底色 */ 
        background-image: 
            /* 1. 顶部高光 (模拟清漆反光) */ 
            linear-gradient(to bottom, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 20%), 
            /* 2. 木纹线条 (深浅交替) */ 
            repeating-linear-gradient(105deg, transparent 0px, transparent 2px, rgba(0,0,0,0.15) 3px, rgba(0,0,0,0.05) 6px), 
            /* 3. 噪点质感 (增加真实度) */ 
            url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E"); 
        
        /* [立体感] 厚重的木框边框 */ 
        border: 4px solid #281813; /* 极深色边框 */ 
        border-left: none; 
        border-radius: 0 12px 12px 0; 
        
        /* [立体感] 内发光+外投影 */ 
        box-shadow: 
            inset 0 0 20px rgba(0,0,0,0.8), /* 内部深邃感 */ 
            inset 2px 2px 5px rgba(255,255,255,0.1), /* 边缘高光 */ 
            10px 10px 30px rgba(0,0,0,0.5); /* 外部真实投影 */ 
            
        z-index: 3000; 
        transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1.1); /* 带有轻微回弹的物理动效 */ 
    } 
    #pantry-drawer.closed { transform: translateX(-100%); } 
    #pantry-drawer.open { transform: translateX(0); } 

    /* [视觉升级] 拉丝金属镂空把手 (C型结构) */ 
    #pantry-handle { 
        position: absolute; 
        top: 50%; 
        right: -34px; /* 挂在柜体外侧 */ 
        transform: translateY(-50%); 
        width: 34px; 
        height: 100px; 
        cursor: pointer; 
        z-index: 3001; 
        
        /* 镂空结构的实现：利用 border 和 背景镂空 */ 
        box-sizing: border-box; 
        border-radius: 0 16px 16px 0; /* 外圆角 */ 
        /* [材质核心] 拉丝金属渐变 */ 
        background: repeating-linear-gradient( 
            90deg, 
            #bdc3c7 0%, 
            #95a5a6 10%, 
            #ecf0f1 20%, 
            #7f8c8d 30%, 
            #bdc3c7 40% 
        ); 
        
        /* 金属光泽投影 */ 
        box-shadow: 
            2px 2px 5px rgba(0,0,0,0.4), /* 外部投影 */ 
            inset 1px 1px 2px rgba(255,255,255,0.8), /* 顶部高光倒角 */ 
            inset -1px -1px 2px rgba(0,0,0,0.3); /* 底部阴影倒角 */ 
            
        /* 弹性布局用于居中镂空部分 */ 
        display: flex; 
        align-items: center; 
        justify-content: flex-start; /* 靠左对齐，因为要连着柜子 */ 
    } 

    /* [把手细节] 中间镂空的“扣手位” */ 
    #pantry-handle::after { 
        content: ''; 
        display: block; 
        width: 24px; /* 镂空宽度 */ 
        height: 76%; /* 镂空高度，上下留出金属实体 */ 
        
        /* 镂空部分的颜色：设为透明或深色阴影，模拟“透过去”或“凹槽” */ 
        background: rgba(0,0,0,0.3); 
        /* 如果想做真镂空（透出后面背景），可以用 clip-path，但这里模拟凹槽手感更好 */ 
        border-radius: 0 10px 10px 0; /* 内圆角 */ 
        box-shadow: inset 2px 2px 5px rgba(0,0,0,0.6); /* 内部凹陷阴影 */ 
        border-left: 1px solid rgba(0,0,0,0.2); 
    } 

    /* 内部容器微调 */ 
    .drawer-content { 
        height: 100%; 
        display: flex; 
        flex-direction: column; 
        padding: 16px; 
        box-sizing: border-box; 
    } 

    /* 标题栏 - 嵌入式烫金文字感 */ 
    .drawer-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 12px; 
        padding-bottom: 10px; 
        border-bottom: 2px solid rgba(0,0,0,0.3); 
        box-shadow: 0 1px 0 rgba(255,255,255,0.05); /* 雕刻线效果 */ 
    } 

    .drawer-title { 
        color: #E0E0E0 !important; 
        font-size: 16px; 
        font-weight: 700; 
        letter-spacing: 1.5px; 
        text-shadow: 0 2px 0 rgba(0,0,0,0.5); /* 凹陷文字效果 */ 
    } 

    /* 翻页按钮 - 金属微动开关风格 */ 
    .drawer-nav button { 
        background: linear-gradient(to bottom, #555, #333); 
        color: #ddd; 
        border: 1px solid #222; 
        border-top: 1px solid #666; 
        border-radius: 4px; 
        padding: 4px 12px; 
        cursor: pointer; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.4); 
    } 
    .drawer-nav button:active { 
        background: #222; 
        transform: translateY(1px); 
    } 

    #pantry-layer-indicator { 
        color: #aaa !important; 
        font-family: monospace; 
        font-size: 14px; 
        text-shadow: 0 1px 0 rgba(0,0,0,0.8); 
    } 

    /* 网格保持不变 */ 
    #ingredient-grid { 
        flex: 1; 
        display: grid; 
        grid-template-columns: repeat(3, 1fr); 
        grid-template-rows: repeat(4, 1fr); 
        gap: 12px; 
        overflow: hidden; 
    } 

    /* 格子升级 - 嵌入式木盒 */ 
    .ingredient-item { 
        width: 100%; 
        height: 100%; 
        /* 深色凹槽 */ 
        background: rgba(0, 0, 0, 0.2); 
        border-radius: 8px; 
        /* 内部阴影，制造深度 */ 
        box-shadow: inset 3px 3px 8px rgba(0,0,0,0.4), inset -1px -1px 2px rgba(255,255,255,0.05); 
        border: 1px solid rgba(255,255,255,0.03); 
        
        display: flex; 
        flex-direction: column;
        align-items: center; 
        justify-content: center; 
        position: relative; 
        cursor: pointer; 
    } 

    .ingredient-item img { 
        width: 80%; 
        height: 80%; 
        object-fit: contain; 
        filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); /* 食材悬浮感 */ 
    } 

    .ingredient-count { 
        position: absolute; 
        bottom: 5px; 
        right: 5px; 
        background: #C0392B; /* 更深沉的红 */ 
        color: #fff; 
        font-size: 11px; 
        font-weight: 700; 
        padding: 2px 6px; 
        border-radius: 4px; 
        box-shadow: 0 2px 3px rgba(0,0,0,0.3); 
        text-shadow: none !important; 
    }
        
    </style>
</head>
<body>
<!-- [Audio System] Preloaded Audio Elements -->
<div id="audio-pool" style="display: none;">
    <audio id="bgm-theme" loop>
        <source src="audio/theme_bgm.mp3" type="audio/mpeg">
    </audio>
    <audio id="bgm-shop" loop>
        <source src="audio/shop_bgm.mp3" type="audio/mpeg">
    </audio>
    <audio id="bgm-game" loop>
        <source src="audio/game_bgm.mp3" type="audio/mpeg">
    </audio>
</div>
<div id="orientation-lock">
    <div style="font-size: 60px; margin-bottom: 20px;">📱🔄</div>
    <div style="font-size: 24px; font-weight: bold;">请旋转手机</div>
    <div style="opacity: 0.8; margin-top: 10px;">为了最佳体验，请使用横屏游玩</div>
</div>


<div id="game-container">
    <div id="game-ui" style="display:none;"> 
        <div id="pantry-drawer" class="closed"> 
            <div class="drawer-content"> 
                <div class="drawer-header"> 
                    <span class="drawer-title" style="color:#8B4513; font-weight:bold;">📦 食材储物柜</span> 
                    <div class="drawer-nav"> 
                        <button onclick="changePantryLayer(-1)">◀</button> 
                        <span id="pantry-layer-indicator" style="color:#5D4037;">1/2</span> 
                        <button onclick="changePantryLayer(1)">▶</button> 
                    </div> 
                </div> 
                <div id="ingredient-grid"></div> 
            </div> 
            <div id="pantry-handle" onclick="togglePantry()"> 
                <div class="handle-grip"></div> 
            </div> 
        </div> 
    </div>
    <div id="game-bg" aria-hidden="true">
        <div class="bg-layer bg-a"></div>
        <div class="bg-layer bg-b"></div>
    </div>
    <div id="game-header">
        <div id="game-title"><img src="assets/ui/游戏logo.png" alt="游戏logo" class="title-logo">不停餐饮大亨</div>
    </div>

    <div id="hud">
        <div id="hud-row">
            <div class="hud-stats">
                <!-- Row 1: Time, Pass Rate -->
                <div class="hud-line">
                    <div class="hud-item" id="game-timer-container">
                        <span class="hud-label-strong" style="color:#e74c3c">TIME</span>
                        <span class="stat-val" id="game-timer" style="font-variant-numeric: tabular-nums; width:50px;">120</span>
                    </div>
                    <div class="hud-item">
                        <span class="hud-label hud-label-strong">及格率</span>
                        <span class="hud-main">
                            <span class="stat-val" id="pass-rate">0%</span>
                            <span id="pass-trend" class="trend-box" style="display:none">
                                <span class="trend-icon"></span>
                                <span class="trend-val"></span>
                                <span class="tooltip" id="trend-tooltip"></span>
                            </span>
                        </span>
                    </div>
                </div>
                <!-- Row 2: Target -->
                <div class="hud-line">
                    <div class="hud-item hud-item-target">
                        <span class="hud-label hud-label-strong">目标</span>
                        <span class="hud-main">
                            <span class="stat-val target-current" id="target-current">¥0</span>
                            <span class="target-sep">/</span>
                            <span class="stat-val target-goal" id="target-goal">¥1000</span>
                        </span>
                    </div>
                </div>
                <!-- Row 3: Day Revenue -->
      <div class="hud-line">
        <div class="hud-item">
          <span class="hud-label hud-label-strong" id="hud-day-label">DAY 1 营业额</span>
          <span class="hud-main">
            <span class="stat-val" id="revenue">¥0</span>
          </span>
        </div>
      </div>
            </div>
            <button class="toggle-btn" id="btn-pause" type="button">⏸ 暂停</button>
        </div>
        <!-- Progress bar removed -->
    </div>

    <!-- [新增] 全局垃圾桶卡片 (插入在 HUD 之后，Play Area 之前) -->


    <div id="play-area">
        <div id="belt-container"></div>

        <div id="kitchen-area">
            <!-- Stations injected by JS -->
        </div>

    </div>



    <div id="start-screen">
        <div class="home-top-right">
            <div class="home-balance">
                <span>钱包</span>
                <span id="home-balance">¥0</span>
            </div>
            <button id="btn-world-map" class="home-btn-secondary" onclick="playCoin(); showLocationSelection()">🗺 商业版图</button>
            <button id="btn-shop" class="home-btn-secondary" onclick="showShop()">🛒 商店</button>
        </div>
        <div class="home-title">
            <img src="assets/ui/robotinkitchen.png" alt="不停餐饮大亨" class="home-title-logo">
        </div>
        <div class="home-main-actions">
            <button id="btn-start" style="padding:15px 50px; background:#FCC307; color:white; border:none; border-radius:16px; cursor:pointer; font-weight:900; box-shadow:0 8px 0 #c7a000, 0 10px 20px rgba(0,0,0,0.4); transition:all 0.3s; margin-top:14px;">开始游戏</button>
        </div>
        <button id="btn-reset" class="base-button-reset" title="重置游戏" onclick="GameStateManager.resetAllDataPrompt()">🔄</button>
        <button id="btn-settings" class="base-button-reset" title="游戏设置" onclick="showSettingsModal()">⚙️</button>
    </div>

    <!-- 移入游戏容器的子界面 -->
    <div id="shop-overlay" class="shop-overlay" style="display:none; position:absolute; inset:0; width:100%; height:100%; z-index:3000; flex-direction:column; align-items:center; justify-content:center;">
        <div class="shop-modal" style="width: 80%; max-width: 1000px; height: 80%; background: #fff; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
             <div class="shop-header" style="background: #f1c40f; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                 <h2 style="margin:0; color:#fff; font-size: 28px; text-shadow: 0 2px 0 rgba(0,0,0,0.1);">🛒 道具商店</h2>
                 <button class="close-shop-btn" onclick="closeShop()" style="background:none; border:none; font-size:30px; color:white; cursor:pointer;">&times;</button>
             </div>
             <div class="shop-content" style="flex: 1; padding: 30px; overflow-y: auto; background: #f9f9f9;">
                 <!-- Shop Items Dynamic Render -->
             </div>
        </div>
    </div>

    <div id="settings-modal">
        <div class="modal">
            <h2>游戏设置</h2>
            <div class="settings-group">
                <div class="settings-item">
                    <span class="settings-label">主题音乐</span>
                    <label class="toggle"><input type="checkbox" id="toggle-theme" checked><span>开启</span></label>
                </div>
                <div class="settings-item">
                    <span class="settings-label">游戏音乐</span>
                    <label class="toggle"><input type="checkbox" id="toggle-music" checked><span>开启</span></label>
                </div>
                <div class="settings-item">
                    <span class="settings-label">游戏音效</span>
                    <label class="toggle"><input type="checkbox" id="toggle-sfx" checked><span>开启</span></label>
                </div>
            </div>
            <button class="close-btn" onclick="hideSettingsModal()">保存并返回</button>
        </div>
    </div>

    <div id="overlay">
        <div class="modal">
            <h2 id="modal-title">关卡结算</h2>
            <div id="modal-desc" class="modal-content"></div>
            <div class="modal-actions">
                <button onclick="startNextLevel()" id="modal-btn">继续营业</button>
                <button onclick="hideResultModal()" id="modal-cancel">返回首页</button>
            </div>
        </div>
    </div>

    <div id="achievement-modal" style="position:absolute; inset:0; background:rgba(0,0,0,0.9); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:3200; color:white;">
        <div class="modal" style="width: 600px; max-width: 95vw;">
            <h2 id="ach-title" style="color:#f1c40f; font-size:28px;">🏆 传奇名厨</h2>
            <div id="ach-container" class="ach-content">
                <!-- Dynamic Content -->
            </div>
            <div style="margin-top: 20px; width: 100%; display: flex; flex-direction: column; gap: 10px;">
                 <button id="btn-continue-business" onclick="startNextLevel('btn-continue-business')" style="background:#2ecc71; border-color:#27ae60; color:white; font-size: 20px; padding: 15px; width: 100%; font-weight: bold; border-radius: 12px; cursor: pointer; transition: transform 0.2s;">💰 继续营业</button>
                 <button onclick="showLocationSelection()" style="background:#f1c40f; border-color:#d4ac0d; color:#2c3e50; font-size: 20px; padding: 15px; width: 100%; font-weight: bold; border-radius: 12px; cursor: pointer; transition: transform 0.2s;">🚀 开启新的征途</button>
            </div>
        </div>
    </div>

    <div id="map-screen" role="dialog" aria-modal="true" aria-labelledby="location-title">
        <button class="glass-btn btn-outline-glass loc-back-btn" onclick="closeLocationSelection()">返回</button>
        <div class="loc-header-float">
            <h2 id="location-title">我的店铺</h2>
            <div class="loc-subtitle">商业版图全景管理</div>
        </div>
        
        <div class="region-dock" id="region-dock-container">
            <!-- Step 1: Regions -->
        </div>

        <div class="district-panel-container" id="district-panel">
            <div class="dp-header">
                <div class="dp-title">
                    <span id="dp-flag"></span>
                    <span id="dp-city-name"></span>
                </div>
            </div>
            <div class="dp-list" id="district-list-container">
                <!-- Step 2: Districts -->
            </div>
            <div class="panel-actions">
                 <button id="btn-confirm-loc" class="glass-btn btn-primary-glass" onclick="confirmNewJourney()">请选择新店位置</button>
                 <button class="glass-btn btn-outline-glass" onclick="closeDistrictPanel()">返回管理店铺</button>
            </div>
        </div>
    </div>

    <div id="pause-overlay">
        <div class="modal">
            <h2>⏸ 已暂停</h2>
            <p>按空格 / P 键，或点击“继续”恢复游戏。</p>
            <button type="button" id="btn-resume">继续</button>
            <button type="button" id="btn-end-game" style="margin-top: 10px; background: #e74c3c; border-bottom: 4px solid #c0392b;" onclick="window.confirmEndGame()">店铺打烊</button>
        </div>
    </div>

    <div id="end-game-modal" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:3200; align-items:center; justify-content:center;">
        <div class="modal" style="background:white; padding:30px; border-radius:15px; text-align:center; max-width:400px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
            <h2 style="margin-top:0; color:#e74c3c; font-size:24px;">⚠️ 结束游戏确认</h2>
            <p style="color:#555; font-size:16px; line-height:1.6; margin:20px 0;">确定要结束当前游戏吗？<br><span style="font-size:14px; color:#7f8c8d;">当前关卡进度将丢失，但最高分记录会保留。</span></p>
            <div style="display:flex; justify-content:center; gap:20px; margin-top:25px;">
                <button onclick="window.hideEndGameModal()" style="padding:10px 25px; background:#95a5a6; border-bottom:4px solid #7f8c8d; color:white; border-radius:8px; font-weight:bold; cursor:pointer;">取消</button>
                <button onclick="window.endGame()" style="padding:10px 25px; background:#e74c3c; border-bottom:4px solid #c0392b; color:white; border-radius:8px; font-weight:bold; cursor:pointer;">确认结束</button>
            </div>
        </div>
    </div>

    <!-- [新增] 全局垃圾桶卡片 (Moved inside game-container) -->
    <div id="global-trash-card" class="global-trash-card" onclick="toggleTrashMode()">
        <div class="global-trash-icon">🗑️</div>
        <div class="global-trash-label">丢弃</div>
    </div>
    </div>
</div>



<div id="drag-cursor"></div>

<div id="loading" style="position:fixed; inset:0; background:#000 url('assets/bg/门店后厨.jpg') no-repeat center center / cover; z-index:9999; display:flex; align-items:center; justify-content:center; transition:opacity 0.5s ease;">
    <div id="loading-content" style="position:relative; z-index:2; font-size:24px; font-weight:bold; color:#FFFFFF; display:flex; flex-direction:column; align-items:center; text-shadow: 0 2px 4px rgba(0,0,0,0.8);">
        <!-- [修改] 移除Emoji，使用动态素材轮播 -->
        <div id="loading-icon" class="loading-icon"></div>
        <div style="margin-bottom:10px; letter-spacing: 2px;">准备好成为餐饮大亨了吗？</div>
        <div id="loading-text" style="color:#FFFFFF; text-shadow: 0 1px 3px rgba(0,0,0,0.9);">资源加载中 0%</div>
        <div id="loading-bar-container" style="background:rgba(255,255,255,0.2); border:2px solid rgba(255,255,255,0.6); box-shadow: 0 4px 6px rgba(0,0,0,0.4);"><div id="loading-bar"></div></div>
        <!-- [新增] 随机小贴士容器 -->
        <div id="loading-tips" class="loading-tips-text">正在准备厨房...</div>
    </div>
</div>
<div id="transition-overlay" style="position:fixed; inset:0; background:black; z-index:10000; opacity:0; pointer-events:none; transition:opacity 0.45s ease;"></div>

<div id="settings-modal">
    <div class="modal">
        <h2>游戏设置</h2>
        <div class="settings-group">
            <div class="settings-item">
                <span class="settings-label">主题音乐</span>
                <label class="toggle"><input type="checkbox" id="toggle-theme" checked><span>开启</span></label>
            </div>
            <div class="settings-item">
                <span class="settings-label">游戏音乐</span>
                <label class="toggle"><input type="checkbox" id="toggle-music" checked><span>开启</span></label>
            </div>
            <div class="settings-item">
                <span class="settings-label">游戏音效</span>
                <label class="toggle"><input type="checkbox" id="toggle-sfx" checked><span>开启</span></label>
            </div>
        </div>
        <button class="close-btn" onclick="hideSettingsModal()">保存并返回</button>
    </div>
</div>
<audio id="bgm" src="audio/theme_bgm.mp3" loop style="display:none"></audio>
<audio id="game-bgm" src="audio/game_bgm.mp3" loop style="display:none"></audio>

<div id="overlay">
    <div class="modal">
        <h2 id="modal-title">关卡结算</h2>
        <div id="modal-desc" class="modal-content"></div>
        <div class="modal-actions">
            <button onclick="startNextLevel()" id="modal-btn">继续营业</button>
            <button onclick="hideResultModal()" id="modal-cancel">返回首页</button>
        </div>
    </div>
</div>

<div id="achievement-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:3200; color:white;">
    <div class="modal" style="width: 600px; max-width: 95vw;">
        <h2 id="ach-title" style="color:#f1c40f; font-size:28px;">🏆 传奇名厨</h2>
        <div id="ach-container" class="ach-content">
            <!-- Dynamic Content -->
        </div>
        <div style="margin-top: 20px; width: 100%; display: flex; flex-direction: column; gap: 10px;">
             <button id="btn-continue-business" onclick="startNextLevel('btn-continue-business')" style="background:#2ecc71; border-color:#27ae60; color:white; font-size: 20px; padding: 15px; width: 100%; font-weight: bold; border-radius: 12px; cursor: pointer; transition: transform 0.2s;">💰 继续营业</button>
             <button onclick="showLocationSelection()" style="background:#f1c40f; border-color:#d4ac0d; color:#2c3e50; font-size: 20px; padding: 15px; width: 100%; font-weight: bold; border-radius: 12px; cursor: pointer; transition: transform 0.2s;">🚀 开启新的征途</button>
        </div>
    </div>
</div>

<div id="map-screen" role="dialog" aria-modal="true" aria-labelledby="location-title">
    <button class="glass-btn btn-outline-glass loc-back-btn" onclick="closeLocationSelection()">返回</button>
    <div class="loc-header-float">
        <h2 id="location-title">🗺️ 选择新分店位置</h2>
        <div class="loc-subtitle">扩张你的商业帝国，选择下一个挑战地点</div>
    </div>
    
    <div class="region-dock" id="region-dock-container">
        <!-- Step 1: Regions -->
    </div>

    <div class="district-panel-container" id="district-panel">
        <div class="dp-header">
            <div class="dp-title">
                <span id="dp-flag"></span>
                <span id="dp-city-name"></span>
            </div>
        </div>
        <div class="dp-list" id="district-list-container">
            <!-- Step 2: Districts -->
        </div>
        <div class="panel-actions">
             <button id="btn-confirm-loc" class="glass-btn btn-primary-glass" onclick="confirmNewJourney()">确认进驻</button>
             <button class="glass-btn btn-outline-glass" onclick="closeDistrictPanel()">返回选择城市</button>
        </div>
    </div>
</div>

<!-- Static prep-modal removed -->

<div id="pause-overlay">
    <div class="modal">
        <h2>⏸ 已暂停</h2>
        <p>按空格 / P 键，或点击“继续”恢复游戏。</p>
        <button type="button" id="btn-resume">继续</button>
        <button type="button" id="btn-end-game" style="margin-top: 10px; background: #e74c3c; border-bottom: 4px solid #c0392b;" onclick="window.confirmEndGame()">店铺打烊</button>
    </div>
</div>

<div id="end-game-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:3200; align-items:center; justify-content:center;">
    <div class="modal" style="background:white; padding:30px; border-radius:15px; text-align:center; max-width:400px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
        <h2 style="margin-top:0; color:#e74c3c; font-size:24px;">⚠️ 结束游戏确认</h2>
        <p style="color:#555; font-size:16px; line-height:1.6; margin:20px 0;">确定要结束当前游戏吗？<br><span style="font-size:14px; color:#7f8c8d;">当前关卡进度将丢失，但最高分记录会保留。</span></p>
        <div style="display:flex; justify-content:center; gap:20px; margin-top:25px;">
            <button onclick="window.hideEndGameModal()" style="padding:10px 25px; background:#95a5a6; border-bottom:4px solid #7f8c8d; color:white; border-radius:8px; font-weight:bold; cursor:pointer;">取消</button>
            <button onclick="window.endGame()" style="padding:10px 25px; background:#e74c3c; border-bottom:4px solid #c0392b; color:white; border-radius:8px; font-weight:bold; cursor:pointer;">确认结束</button>
        </div>
    </div>
</div>

<script src="tests.js"></script>
<script>
// [Audio System] Global Audio Controller
const AudioController = {
    currentBgm: null,
    isUnlocked: false, // User interaction flag

    // Initialize: Unlock audio context on first interaction
    init() {
        if (this.isUnlocked) return;
        const unlock = () => {
            this.isUnlocked = true;
            
            // Resume Web Audio Context if suspended
            if (typeof audioCtx !== 'undefined' && audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            // Unlock Audio Elements
            const theme = document.getElementById('bgm-theme');
            if (theme) {
                // [Fix] Only perform play-pause unlock if NOT already playing/active
                // This prevents interrupting the theme song if it's already playing
                if (this.currentBgm === 'bgm-theme' || !theme.paused) {
                    // Already active, no need to interrupt
                } else {
                    theme.play().then(() => {
                         // Double check before pausing
                         if (this.currentBgm !== 'bgm-theme') {
                             theme.pause();
                         }
                    }).catch(() => {});
                }
            }
            document.removeEventListener('click', unlock);
            document.removeEventListener('touchstart', unlock);
        };
        document.addEventListener('click', unlock);
        document.addEventListener('touchstart', unlock);
    },

    // Stop current BGM
    stopCurrent() {
        if (this.currentBgm) {
            const audio = document.getElementById(this.currentBgm);
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
            }
            this.currentBgm = null;
        }
    },

    // Play specific BGM (Mutex)
    play(id) {
        if (this.currentBgm === id) {
            // Ensure it's playing
            const audio = document.getElementById(id);
            if (audio && audio.paused) audio.play().catch(() => {});
            return;
        }

        this.stopCurrent(); // Stop previous

        const audio = document.getElementById(id);
        if (audio) {
            audio.volume = 0.5; // Default volume
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.warn(`Audio playback failed for ${id}:`, error);
                });
            }
            this.currentBgm = id;
        }
    },

    playTheme() { if (typeof themeMusicEnabled === 'undefined' || themeMusicEnabled) this.play('bgm-theme'); },
    playShop() { if (typeof themeMusicEnabled === 'undefined' || themeMusicEnabled) this.play('bgm-shop'); },
    playGame() { if (typeof gameMusicEnabled === 'undefined' || gameMusicEnabled) this.play('bgm-game'); }
};

// Auto-init on load
window.addEventListener('DOMContentLoaded', () => AudioController.init());

// [新增] 移动端视窗适配系统
function resizeGameWindow() {
    const container = document.getElementById('game-container');
    const loadingScreen = document.getElementById('loading');
    
    // 目标设计尺寸
    const designW = 1920;
    const designH = 1080;
    
    // 当前窗口尺寸
    const winW = window.innerWidth;
    const winH = window.innerHeight;
    
    // 计算缩放比例 (Contain 模式：保证全部内容可见)
    const scale = Math.min(winW / designW, winH / designH);
    
    // 应用缩放
    const targetStyles = `
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%) scale(${scale});
        width: ${designW}px;
        height: ${designH}px;
        transform-origin: center center;
        display: flex; /* 确保容器始终可见 */
    `;
    
    if (container) {
        container.style.cssText = targetStyles;
    }
    
    // 加载页特殊处理：全屏铺满
    if (loadingScreen) {
        loadingScreen.style.width = '100vw';
        loadingScreen.style.height = '100vh';
    }
}

// 监听窗口变化
window.addEventListener('resize', resizeGameWindow);
// 初始调用
window.addEventListener('load', () => {
    setTimeout(resizeGameWindow, 100); // 延时确保获取准确高度
});

window.tempInventory = {};
window.tempCoins = 0;
/** 初始化数据 - 内容扩充版 **/ 
 const RECIPES = [ 
     // [Day 1-2] 基础蛋类 (Low Cost)
     { name: "番茄炒蛋", ingredients: ["tomato", "egg"], price: 18, icon: "🥘" }, 
     { name: "洋葱炒蛋", ingredients: ["onion", "egg"], price: 20, icon: "🍳" }, 

     // [Day 3-5] 进阶肉类 (Pork)
     { name: "番茄肉片", ingredients: ["tomato", "pork"], price: 25, icon: "🍲" }, 
     { name: "青椒肉丝", ingredients: ["pepper", "pork"], price: 28, icon: "🥘" }, 
     { name: "麻婆豆腐", ingredients: ["tofu", "pork"], price: 26, icon: "🌶️" }, 
     { name: "土豆炖肉", ingredients: ["potato", "pork"], price: 30, icon: "🍲" }, 

     // [Day 6-8] 高级食材 (Shrimp/Beef)
     { name: "虾仁滑蛋", ingredients: ["egg", "shrimp"], price: 45, icon: "🍤" }, 
     { name: "滑蛋牛肉", ingredients: ["egg", "beef"], price: 48, icon: "🍛" }, 
     { name: "葱爆牛肉", ingredients: ["onion", "beef"], price: 50, icon: "🥩" }, 

     // [Day 9+] 复杂大菜 (3 Ingredients)
     { name: "地三鲜", ingredients: ["potato", "pepper", "tomato"], price: 35, icon: "🥗" }, 
     { name: "扬州炒饭", ingredients: ["rice", "egg", "shrimp"], price: 68, icon: "🥡" }, 
     { name: "土豆牛腩饭", ingredients: ["rice", "beef", "potato"], price: 75, icon: "🍱" } 
 ]; 
 
 const INGREDIENTS = { // 原有食材 
    "tomato": { id: "tomato", name: "番茄", icon: "🍅", stock: 0, price: 3 }, 
    "egg": { id: "egg", name: "鸡蛋", icon: "🥚", stock: 0, price: 2 }, 
    "pork": { id: "pork", name: "猪肉", icon: "🥩", stock: 0, price: 8 }, 
    "shrimp": { id: "shrimp", name: "虾仁", icon: "🦐", stock: 0, price: 15 }, 
 
 // 新增食材 
 "beef":   { id: "beef",   name: "牛肉", icon: "🍖", stock: 0, price: 20 }, // 高成本 
 "potato": { id: "potato", name: "土豆", icon: "🥔", stock: 0, price: 3 }, 
 "pepper": { id: "pepper", name: "青椒", icon: "🫑", stock: 0, price: 4 }, 
 "onion":  { id: "onion",  name: "洋葱", icon: "🧅", stock: 0, price: 3 }, 
 "tofu":   { id: "tofu",   name: "豆腐", icon: "🧊", stock: 0, price: 3 }, // 豆腐用冰块icon暂代方块感，或用⬜ 
 "rice":   { id: "rice",   name: "米饭", icon: "🍚", stock: 0, price: 2 } 
 };

// Global State
let holdingThing = null; // { type: 'INGREDIENT' | 'DISH', val: object }
let currentStore = 'China_Town';

// Legacy MENU for compatibility if needed, or mapped from RECIPES
const MENU = RECIPES.map(r => ({ n: r.name, i: r.icon, price: r.price }));

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let sfxEnabled = true, themeMusicEnabled = true, gameMusicEnabled = true;
let gameLang = (localStorage.getItem('gameLang') || ((navigator.language || '').toLowerCase().startsWith('en') ? 'en' : 'zh'));
let coinBuffer = null;
let revenueBuffer = null;
let angryBuffers = []; // [新增] 存储生气音效 Buffer
let resultSfxBuffer = null; // [新增] 成绩单音效 Buffer
/* [Deprecated] Legacy Audio Objects
let shopMusic = new Audio('audio/shop_bgm.mp3'); // [新增] 商店/集市音乐
shopMusic.loop = true;
shopMusic.volume = 1.0; // [核心修改] 提高 BGM 音量至 1.0 (Max)
let shopMusicSource = null;
*/

let angryAudioElements = []; // [新增] 存储生气音效 Audio 元素 (Fallback)
const ANGRY_SOUNDS = ['audio/angry_man.mp3', 'audio/angry_woman.mp3', 'audio/angry_child.mp3']; // [新增] 音效文件列表 (英文文件名避免编码问题)
const revenueAudio = new Audio('audio/coin.mp3'); // Fallback
let bgmSource = null; // Track BGM MediaElementSource
let gameBgmSource = null; // Track Game BGM MediaElementSource
const masterGain = audioCtx.createGain(); masterGain.gain.value = 0.9; masterGain.connect(audioCtx.destination);
const sfxGain = audioCtx.createGain(); sfxGain.gain.value = 0.8; sfxGain.connect(masterGain);
const musicGain = audioCtx.createGain(); musicGain.gain.value = 0.3; musicGain.connect(masterGain);
const themeGain = audioCtx.createGain(); themeGain.gain.value = 1.0; themeGain.connect(musicGain); // Theme song specific gain for normalization
const gameFileGain = audioCtx.createGain(); gameFileGain.gain.value = 0.3; gameFileGain.connect(musicGain); // Game BGM specific gain

let uiState = 'LOADING';

const GAME_BG_PLAY = 'assets/bg/家庭厨房.jpeg';
const GAME_BG_ALT = 'assets/bg/门店后厨.jpg';
const gameBg = { root: null, layers: [], activeIdx: 0, currentUrl: '', filter: '', overlay: 0.34 };

function preloadImage(url) {
    return new Promise((resolve) => {
        const img = new Image();
        img.decoding = 'async';
        img.src = url;
        if (img.complete) resolve(true);
        else {
            img.onload = () => resolve(true);
            img.onerror = () => resolve(false);
        }
    });
}

function initGameBackground() {
    const root = document.getElementById('game-bg');
    if (!root) return;
    const a = root.querySelector('.bg-a');
    const b = root.querySelector('.bg-b');
    if (!a || !b) return;

    gameBg.root = root;
    gameBg.layers = [a, b];
    gameBg.activeIdx = 0;
    gameBg.currentUrl = GAME_BG_PLAY;
    gameBg.filter = 'saturate(1.02) brightness(1) contrast(1.02)';
    gameBg.overlay = 0.34;

    gameBg.root.style.setProperty('--game-bg-overlay', String(gameBg.overlay));
    gameBg.layers.forEach(l => { l.style.filter = gameBg.filter; l.classList.remove('is-active'); });
    a.style.backgroundImage = `url('${GAME_BG_PLAY}')`;
    requestAnimationFrame(() => a.classList.add('is-active'));

    preloadImage(GAME_BG_PLAY);
    preloadImage(GAME_BG_ALT);
}

function setGameBgVisual(filter, overlay) {
    if (!gameBg.root) return;
    if (typeof filter === 'string') {
        gameBg.filter = filter;
        gameBg.layers.forEach(l => { l.style.filter = filter; });
    }
    if (typeof overlay === 'number') {
        gameBg.overlay = overlay;
        gameBg.root.style.setProperty('--game-bg-overlay', String(overlay));
    }
}

// [新增] 根据国家和装修等级获取背景图路径
function getDynamicKitchenBg() {
    // 1. 获取当前区域 (默认为 cn)
    const ngParams = JSON.parse(localStorage.getItem('ng_params') || '{}');
    const region = (ngParams.location || 'cn:main').split(':')[0];
    // 2. 获取当前装修等级 (0:标准, 1:扩容, 2:星级)
    const expansion = game.inventory.expansion || 0;
    // 3. 构建文件名规范
    // 格式: assets/bg/kitchen_{国家代码}_lv{等级}.jpg
    // 例如: assets/bg/kitchen_cn_lv0.jpg (中国标准)
    // 例如: assets/bg/kitchen_jp_lv2.jpg (日本星级)
    return `assets/bg/kitchen_${region}_lv${expansion}.jpg`;
}

async function setGameBgImage(url, fallbackUrl = null) {
    if (!gameBg.root || !url) return;
    if (url === gameBg.currentUrl) return;

    // 1. 尝试加载目标图片
    let ok = await preloadImage(url);
    let finalUrl = url;

    // 2. 如果失败且有备用图，尝试加载备用图
    if (!ok && fallbackUrl) {
        console.warn(`Background [${url}] not found, using fallback: ${fallbackUrl}`);
        ok = await preloadImage(fallbackUrl);
        finalUrl = fallbackUrl;
    }

    // 3. 如果都失败，保持当前图片不变
    const nextUrl = ok ? finalUrl : gameBg.currentUrl;
    if (nextUrl === gameBg.currentUrl) return;

    const nextIdx = (gameBg.activeIdx + 1) % 2;
    const nextLayer = gameBg.layers[nextIdx];
    const curLayer = gameBg.layers[gameBg.activeIdx];
    if (!nextLayer || !curLayer) return;

    nextLayer.style.backgroundImage = `url('${nextUrl}')`;
    
    // 显示模式判断 (只要是厨房背景都用 contain)
    if (nextUrl.includes('kitchen_') || nextUrl.includes('家庭厨房')) {
        nextLayer.classList.add('game-mode');
    } else {
        nextLayer.classList.remove('game-mode');
    }

    nextLayer.style.filter = gameBg.filter;
    nextLayer.classList.add('is-active');
    curLayer.classList.remove('is-active');
    gameBg.activeIdx = nextIdx;
    gameBg.currentUrl = nextUrl;
}

function getDominantStage() {
    const s1 = stations?.[1]?.stage || 'IDLE';
    const s2 = stations?.[2]?.stage || 'IDLE';
    const list = [s1, s2];
    const priority = ['SPOILED', 'READY', 'COOKING', 'PREP', 'IDLE'];
    for (const p of priority) if (list.includes(p)) return p;
    return 'IDLE';
}

function updateGameBackground(stateStage = null) {
    const loadingEl = document.getElementById('loading');
    const isLoadingVisible = loadingEl && loadingEl.style.display !== 'none';
    if (isLoadingVisible) {
        setGameBgVisual('saturate(1) brightness(1) contrast(1)', 0);
        setGameBgImage(GAME_BG_ALT);
        return;
    }

    if (!game.isLive) {
        setGameBgVisual('grayscale(0.15) brightness(0.72) contrast(1.05)', 0.56);
        setGameBgImage(GAME_BG_ALT);
        return;
    }

    if (game.isPaused) {
        setGameBgVisual('grayscale(0.35) brightness(0.72) contrast(1.05)', 0.60);
        // [核心修复] 暂停时也要显示当前的动态背景，而不是回退到 GAME_BG_PLAY
        const targetBg = getDynamicKitchenBg();
        const defaultBg = 'assets/bg/家庭厨房.jpeg';
        setGameBgImage(targetBg, defaultBg);
        return;
    }

    const stage = stateStage || getDominantStage();
    if (stage === 'PREP') setGameBgVisual('saturate(1.06) brightness(1.03) contrast(1.03)', 0.32);
    else if (stage === 'COOKING') setGameBgVisual('saturate(1.15) brightness(0.96) contrast(1.06)', 0.42);
    else if (stage === 'READY') setGameBgVisual('saturate(1.05) brightness(1.05) contrast(1.02)', 0.32);
    else if (stage === 'SPOILED') setGameBgVisual('grayscale(0.25) brightness(0.90) contrast(1.10)', 0.52);
    else setGameBgVisual('saturate(1.02) brightness(1) contrast(1.02)', 0.34);

    // [核心修改] 使用动态背景逻辑
    const targetBg = getDynamicKitchenBg();
    const defaultBg = 'assets/bg/家庭厨房.jpeg'; // 兜底默认图
    // 尝试设置动态背景，如果文件不存在则回退到默认图
    setGameBgImage(targetBg, defaultBg);
}

function playSfx(f, t='sine', d=0.1, v=0.1) {
    if (!sfxEnabled) return;
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type = t; o.connect(g); g.connect(sfxGain);
    o.frequency.setValueAtTime(f, audioCtx.currentTime);
    g.gain.setValueAtTime(v, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
    o.start(); o.stop(audioCtx.currentTime + d);
}

// [新增] IM 气泡音效 (模拟清脆的水滴/气泡声)
function playChatBubbleSound() {
    if (!sfxEnabled) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();
    
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    
    osc.connect(gain);
    gain.connect(sfxGain);
    
    // 频率滑音：从 300Hz 快速升至 600Hz，模拟气泡破裂
    osc.type = 'sine';
    osc.frequency.setValueAtTime(350, t);
    osc.frequency.exponentialRampToValueAtTime(700, t + 0.12);
    
    // 包络：快速起音，自然衰减
    gain.gain.setValueAtTime(0, t);
    gain.gain.linearRampToValueAtTime(0.15, t + 0.02);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
    
    osc.start(t);
    osc.stop(t + 0.2);
}

// [新增] 随机播放生气音效
function playRandomAngrySound() {
    if (!sfxEnabled) return;
    
    // [修复] 尝试恢复音频上下文 (解决自动播放策略限制)
    if (audioCtx.state === 'suspended') {
        audioCtx.resume().catch(e => console.error("Audio resume failed:", e));
    }

    // 优先使用 Web Audio API (Buffer)
    if (angryBuffers.length > 0) {
        try {
            const buffer = angryBuffers[Math.floor(Math.random() * angryBuffers.length)];
            if (buffer) {
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                source.connect(sfxGain);
                source.start();
                console.log("Played angry sound (Web Audio)");
                return;
            }
        } catch (e) {
            console.error("Web Audio Play Error:", e);
        }
    }

    // 降级方案：使用 HTML5 Audio (Fallback)
    if (angryAudioElements.length > 0) {
        try {
            console.warn("Using fallback HTML5 Audio for angry sound");
            const aud = angryAudioElements[Math.floor(Math.random() * angryAudioElements.length)];
            aud.currentTime = 0;
            aud.volume = 0.8; // 模拟 sfxGain
            aud.play().catch(e => console.error("HTML5 Audio Play Error:", e));
            return;
        } catch (e) {
             console.error("HTML5 Audio Fallback Error:", e);
        }
    }

    // 最后防线：蜂鸣声
    console.warn("Angry sounds not loaded yet, fallback to sawtooth");
    playSfx(80, 'sawtooth', 0.4);
}

// [新增] 播放成绩单音效
function playResultSfx() {
    if (!sfxEnabled) return;
    
    // 确保 AudioContext 已激活
    if (audioCtx.state === 'suspended') {
        audioCtx.resume().catch(e => console.error(e));
    }

    // 优先尝试 Web Audio API (Buffer)
    if (resultSfxBuffer) {
        try {
            const source = audioCtx.createBufferSource();
            source.buffer = resultSfxBuffer;
            source.connect(sfxGain);
            source.start();
            console.log("Played Result SFX (Web Audio)");
            return;
        } catch(e) { 
            console.error('Web Audio Play Result SFX error:', e); 
        }
    } else {
        console.warn("Result SFX Buffer not ready, trying fallback...");
    }

    // Fallback: 直接使用 HTML5 Audio
    try {
        const tempAudio = new Audio('audio/result_sfx.mp3');
        tempAudio.volume = 0.8; // 模拟 sfxGain
        tempAudio.play().catch(e => console.error("HTML5 Fallback Result SFX error:", e));
        console.log("Played Result SFX (HTML5 Fallback)");
    } catch(e) {
        console.error("Result SFX Total Failure:", e);
    }
}

/* [Deprecated] Legacy Audio Functions
function playShopMusic() {
   console.warn("playShopMusic is deprecated. Use AudioController.playShop() instead.");
}
*/

// [新增] 停止商店/集市音乐
function stopShopMusic() {
    if (AudioController.currentBgm === 'bgm-shop') {
        AudioController.stopCurrent();
    }
}

/* Removed old playCoin and createCoinBuffer definitions to avoid duplication */

function preloadAudio() {
    console.log("Starting preloadAudio...");
    coinBuffer = createCoinBuffer(audioCtx);
    
    // Preload Revenue Sound
    fetch('audio/coin.mp3')
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.arrayBuffer();
        })
        .then(arrayBuffer => audioCtx.decodeAudioData(arrayBuffer))
        .then(audioBuffer => {
            console.log("coin.mp3 loaded successfully");
            revenueBuffer = audioBuffer;
        })
        .catch(e => console.error("Error loading coin.mp3:", e));

    // [新增] 预加载成绩单音效 (使用英文文件名避免编码问题)
    fetch('audio/result_sfx.mp3')
        .then(r => {
            if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
            return r.arrayBuffer();
        })
        .then(b => audioCtx.decodeAudioData(b))
        .then(a => { resultSfxBuffer = a; console.log('Result SFX loaded'); })
        .catch(e => {
            console.error('Error loading result SFX:', e);
        });

    // [新增] 预加载生气音效
    angryAudioElements.length = 0; // Clear previous fallback elements
    ANGRY_SOUNDS.forEach(url => {
        // 1. Web Audio Fetch
        fetch(url)
            .then(res => {
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.arrayBuffer();
            })
            .then(buf => audioCtx.decodeAudioData(buf))
            .then(audioBuf => {
                // 确保不重复添加
                if (!angryBuffers.includes(audioBuf)) {
                    angryBuffers.push(audioBuf);
                    console.log(`Loaded SFX: ${url}`);
                }
            })
            .catch(e => console.error(`Failed to load ${url}:`, e));

        // 2. HTML5 Audio Fallback (Create element immediately)
        try {
            const aud = new Audio(url);
            aud.preload = 'auto'; // Hint to preload
            angryAudioElements.push(aud);
        } catch (e) {
            console.error(`Failed to create fallback Audio for ${url}:`, e);
        }
    });
}

let nintendoBGMInterval = null;

function startNintendoBGM() {
    AudioController.playGame();
}

function startMusic() {
    // 检查当前是否处于“非游戏状态”（即 Loading 或 Start 界面）
    const loadingEl = document.getElementById('loading');
    const startScreen = document.getElementById('start-screen');
    const mapScreen = document.getElementById('map-screen');
    
    const isLoading = loadingEl && loadingEl.style.display !== 'none';
    const isStart = startScreen && startScreen.style.display !== 'none';
    const isMap = mapScreen && mapScreen.style.display !== 'none';
    const isMenuState = isLoading || isStart || isMap;
    
    if (isMenuState) {
        if (themeMusicEnabled) {
            AudioController.playTheme();
        } else {
            AudioController.stopCurrent();
        }
    } else {
        if (gameMusicEnabled) {
            AudioController.playGame();
        } else {
            AudioController.stopCurrent();
        }
    }
}

function stopMusic() {
    AudioController.stopCurrent();
    if (typeof nintendoBGMInterval !== 'undefined' && nintendoBGMInterval) {
        clearInterval(nintendoBGMInterval);
        nintendoBGMInterval = null;
    }
}

/* Removed old createCoinBuffer definition */

const MARKET_GOSSIP_CONFIG = { 
    // --- 🍖 肉类爆发 (道明叔) --- 
    meat: { 
        rush: [ 
            { 
                speakers: ["撸铁阿姨", "道明叔"], 
                lines: [ 
                    "道明叔，最近深蹲重量上去了，太费体能。", 
                    "嚯，大姐，看你这肌肉线条，比好多小伙子都结实！", 
                    "那是，三分练七分吃，教练让我必须加餐。", 
                    "懂行！这块最嫩的牛里脊归你了，高蛋白低脂肪！" 
                ] 
            }, 
            { 
                speakers: ["外卖骑手", "道明叔"], 
                lines: [ 
                    "这倒春寒太厉害，跑了一上午单，手都冻僵了。", 
                    "辛苦辛苦！赶紧进棚子里暖和暖和。", 
                    "今晚收工早，想吃顿热乎的肉菜驱驱寒。", 
                    "来二斤五花肉，回去炖个红烧肉，吃完保证浑身冒汗！" 
                ] 
            }, 
            { 
                speakers: ["项目经理", "道明叔"], 
                lines: [ 
                    "道明叔，最近团队赶项目，大家都熬红了眼。", 
                    "看出来了，你这黑眼圈都快掉地上了。", 
                    "今晚聚餐，我答应给大家搞顿全肉宴补补元气。", 
                    "没问题！这些大排骨全包给你，让大家吃个爽！" 
                ] 
            } 
        ] 
    }, 
// --- 🥬 蔬菜爆发 (林大婶 - 保持原样) --- 
vege: { 
    rush: [ 
        { 
            speakers: ["全职老爸", "林大婶"], 
            lines: [ 
                "大婶，我家那两个神兽最近太难伺候了。", 
                "怎么？又不爱吃饭啦？", 
                "是啊，天热没胃口，看到肉就摇头，愁死我了。", 
                "试试这刚摘的番茄和黄瓜，做个凉拌或者罗宋汤，酸酸甜甜孩子最爱！" 
            ] 
        }, 
        { 
            speakers: ["程序员", "林大婶"], 
            lines: [ 
                "大婶，最近加班熬夜，脸上疯狂爆痘。", 
                "哎哟，年轻人要注意身体，这是虚火太旺了。", 
                "是啊，想吃点清淡的，把身体调理一下。", 
                "听婶子的，多吃苦瓜和芹菜，降火排毒最有效。" 
            ] 
        }, 
        { 
            speakers: ["退休教师", "林大婶"], 
            lines: [ 
                "小林啊，最近体检报告出来了，医生让控制血脂。", 
                "那肉摊那边您最近可得少去了。", 
                "是啊，以后就是‘素食主义’喽，得讲究科学饮食。", 
                "放心，我这儿的蔬菜都是有机的，健康着呢！" 
            ] 
        } 
    ] 
}, 
// --- 🦐 海鲜爆发 (老张头 - 保持原样) --- 
seafood: { 
    rush: [ 
        { 
            speakers: ["焦虑老爸", "老张头"], 
            lines: [ 
                "老张，孩子马上中考了，我看他背书背得头疼。", 
                "兄弟别急，这时候得吃点海里的补补脑。", 
                "我也听说DHA好，是不是得多吃鱼？", 
                "没错！今天的鲈鱼特别鲜，清蒸给孩子吃最灵！" 
            ] 
        }, 
        { 
            speakers: ["探店博主", "老张头"], 
            lines: [ 
                "张大爷！听说第一批渔船刚靠岸？", 
                "你这小丫头鼻子真灵，刚卸下来的货。", 
                "我要拍一期‘开渔第一鲜’的视频，要最好的货！", 
                "必须有，看这皮皮虾和梭子蟹，镜头怼近点，鲜得跳起来！" 
            ] 
        }, 
        { 
            speakers: ["背包客", "老张头"], 
            lines: [ 
                "大爷，我做攻略说来这里必须吃海鲜大餐。", 
                "那肯定，靠山吃山靠海吃海嘛。", 
                "但是怕景区饭店太贵，想买了回民宿自己煮。", 
                "那你来对地方了，我这价格公道，童叟无欺！" 
            ] 
        } 
    ] 
}, 
// --- 🌶️ 辣味/重口爆发 (杂货店 -> 左伊姐) --- 
spicy: { 
    rush: [ 
        { 
            speakers: ["创业青年", "左伊姐"], 
            lines: [ 
                "左伊姐，最近压力大得睡不着，头发大把掉。", // 改口叫左伊姐 
                "年轻人不容易啊，是不是心里憋得慌？", 
                "是啊，就想找个刺激点的法子发泄一下。", 
                "拿这包特辣火锅底料回去，辣出一身大汗，什么烦恼都忘光了！" 
            ] 
        }, 
        { 
            speakers: ["南方游客", "左伊姐"], 
            lines: [ 
                "这梅雨天什么时候是个头？感觉被子里都能拧出水。", 
                "还得半个月呢，这湿气钻得人骨头疼。", 
                "有没有什么本地的土法子去去湿？", 
                "简单，多吃辣椒花椒，以毒攻毒，湿气全跑光！" 
            ] 
        } 
    ] 
}, 
// --- 😐 平稳/无明显倾向 (通用 - 保持原样) --- 
general: { 
    normal: [ 
        { 
            speakers: ["集市管理员", "滑板少年"], 
            lines: [ 
                "喂！那边的，集市里不许滑滑板！", 
                "不好意思大叔，我这就下来走。", 
                "小心撞到老人家，去外面的广场玩。", 
                "知道啦，我就进来买根烤肠，马上走！" 
            ] 
        }, 
        { 
            speakers: ["老顾客", "包子铺老板"], 
            lines: [ 
                "老板，老规矩，两个素包一杯豆浆。", 
                "好嘞，我看您今天气色不错啊。", 
                "嗨，刚在公园打完太极，浑身舒坦。", 
                "得嘞，趁热吃，健康长寿！" 
            ] 
        }, 
        { 
            speakers: ["小女孩", "妈妈"], 
            lines: [ 
                "妈妈，我想买那盆小多肉植物！", 
                "我们是来买菜的，不是逛花鸟市场的。", 
                "就买一盆嘛，我会自己浇水的。", 
                "行吧，那你要说话算话，不能养死了。" 
            ] 
        } 
    ] 
} 
};

const SHOP_CONFIG = {
    expansion: {
        name: "店铺装修",
        desc: "升级后厨布局，增加灶台位与订单容量。",
        basePrice: 0,
        levels: [
            {
                name: "中式·标准后厨", // [修改] 增加区域前缀
                stations: 1,
                slots: 2,
                effectText: "基础配置：1个灶台，2个订单位，适合起步经营。",
                price: 0
            },
            {
                name: "中式·扩容后厨", // [修改] 增加区域前缀
                stations: 2,
                slots: 3,
                effectText: "升级配置：解锁第2个灶台，接单上限提升至3单。",
                price: 800
            },
            {
                name: "中式·星级后厨", // [修改] 增加区域前缀
                stations: 3,
                slots: 5,
                effectText: "顶级配置：解锁第3个灶台，接单上限提升至5单，火力全开。",
                price: 2500
            }
        ]
    },
    pot: {
        name: "烹饪设备",
        desc: "选择你的流派：是追求极致的工业化量产，还是唯快不破的手速大师？",
        basePrice: 150,
        levels: [
            // --- 阶段一：手工起步 ---
            { 
                name: "基础铁锅", 
                effect: 0, 
                yield: 1, 
                effectText: "传统手工烹饪，慢工出细活。", 
                price: 0 
            },
            { 
                name: "专业不粘锅", 
                effect: 0.25, // 提速 25% 
                yield: 1, 
                effectText: "不粘涂层，烹饪速度小幅提升。", 
                price: 200 
            },
            { 
                name: "多段控温精钢锅", 
                effect: 0.5, // 提速 50% 
                yield: 1, 
                effectText: "精准控温，烹饪速度显著提升。", 
                price: 600 
            },
            
            // --- 阶段二：Omni 工业化 (量产流) ---
            { 
                name: "Omni 1.0", 
                effect: 0.6, // 速度一般 
                yield: 2,    // [核心] 双份出餐 
                isDigital: true, 
                effectText: "智能温控，虽然速度普通，但一次烹饪产出 2 份！", 
                price: 1800 
            },
            { 
                name: "Omni 2.0", 
                effect: 0.7, 
                yield: 3,    // [核心] 三份出餐 
                isDigital: true, 
                effectText: "双核加热，效能升级，一次烹饪产出 3 份！", 
                price: 5000 
            },
            { 
                name: "Omni 3.0", 
                effect: 0.8, 
                yield: 4,    // [核心] 四份出餐 
                isDigital: true, 
                effectText: "AI 算力全开，工业级怪兽，一次烹饪产出 4 份！", 
                price: 12000 
            },
            
            // --- 阶段三：小锅大师 (极速流) ---
            // 价格定位比 Omni 略高，因为“灵活性”通常比“死板量产”更强
            { 
                name: "单边小锅", 
                effect: 4.0, // [核心] 5倍速 (极快) 
                yield: 1, 
                effectText: "【双胆模拟】极速加热，几乎瞬发，适合连续处理不同订单。", 
                price: 15000 
            },
            { 
                name: "小锅", 
                effect: 10.0, // [核心] 11倍速 (瞬发) 
                yield: 1, 
                effectText: "【四胆模拟】意念合一，点击即完成。手速越快，产出越快。", 
                price: 30000 
            }
        ]
    },
    belt: {
        name: "智慧系统",
        desc: "优化后厨管理系统，提升订单流转效率与顾客满意度。",
        basePrice: 200,
        levels: [
            { name: "纸质工单", effect: 0, effectText: "传统手写单，容易出错。", price: 0 },
            { name: "平板派单", effect: 0.2, effectText: "电子化派单，减少沟通成本，顾客耐心提升 20%。", price: 400 },
            { name: "K-MES 基础版", effect: 0.4, effectText: "后厨管理系统，流程标准化，顾客耐心提升 40%。", price: 1200 },
            { name: "K-MES 全功能版", effect: 0.8, effectText: "全链路数字化，智能调度，顾客极具耐心。", isDigital: true, price: 3000 }
        ]
    },
    fridge: {
        name: "仓储管理",
        desc: "升级仓储设施，减少食材损耗。",
        basePrice: 600,
        levels: [
            { name: "常温货架", effect: 0, effectText: "每日打烊后食材清零。", price: 0 },
            { name: "保鲜冷库", effect: 1, effectText: "保留每日剩余食材。", price: 1500 }
        ]
    }
};

const SHOP_TABS = [
    { id: 'expand', label: '🏗️ 装修', types: ['expansion'] },
    { id: 'equip', label: '🍳 厨具', types: ['pot'] },
    { id: 'system', label: '💻 系统', types: ['belt', 'fridge'] }
];

let currentShopTab = 'expand';

// [新增] 商店分页状态
let currentShopPage = 0;
const SHOP_ITEMS_PER_PAGE = 8; // 每页显示8个 (2行 x 4列)

function getShopItemIcon(type) {
    switch(type) {
        case 'expansion': return '🏗️';
        case 'pot': return '🍳';
        case 'belt': return '🖥️';
        case 'fridge': return '❄️';
        default: return '📦';
    }
}

function getUpgradePrice(type, nextLevelIdx) {
    const config = SHOP_CONFIG[type];
    if (!config) return 0;
    
    // Use explicit price if available
    if (config.levels[nextLevelIdx] && config.levels[nextLevelIdx].price !== undefined) {
        return config.levels[nextLevelIdx].price;
    }

    const base = config.basePrice || 0;
    if (nextLevelIdx <= 0) return base;
    return Math.round(base * Math.pow(1.5, nextLevelIdx));
}

// [修改] 切换 Tab 时重置页码
function switchShopTab(tabId) {
    currentShopTab = tabId;
    currentShopPage = 0; // 重置回第一页
    renderShop();
}

// [新增] 翻页函数
function changeShopPage(delta) {
    const overlay = document.getElementById('shop-overlay');
    // 简单的防抖，防止渲染未完成
    if (!overlay) return;
    
    currentShopPage += delta;
    if(typeof playSfx === 'function') playSfx(300, 'square', 0.1); // 翻页音效
    renderShop();
}

function generateDailyGossip() {
    if (!MARKET_GOSSIP_CONFIG) return;
    // 1. 随机决定今日趋势
    // 权重：各 20% (肉/菜/海鲜/辣/无事发生)
    const rand = Math.random();
    let category = 'general';
    if (rand < 0.2) category = 'vege';
    else if (rand < 0.4) category = 'meat';
    else if (rand < 0.6) category = 'seafood';
    else if (rand < 0.8) category = 'spicy';
    else category = 'general';

    // 2. [核心] 将趋势存入全局变量，供 generateDailyOrders 使用
    // 如果是 general，则趋势为 'balanced' (均衡)
    game.dailyTrend = (category === 'general') ? 'balanced' : category;
    // 3. 从配置中抽取文案
    // 只有非 general 才有 'rush' 状态，general 对应 normal
    let typeKey = (category === 'general') ? 'normal' : 'rush';
    // 容错读取
    const configGroup = MARKET_GOSSIP_CONFIG[category];
    const list = configGroup[typeKey] || configGroup['normal'] || MARKET_GOSSIP_CONFIG['general']['normal'];

    if (!list || list.length === 0) {
        game.dailyGossip = { speakers: ["系统"], lines: ["今日集市风平浪静。"], currentLineIndex: 0 };
        return;
    }

    const dialogueObj = list[Math.floor(Math.random() * list.length)];
    // 4. 存入情报对象
    game.dailyGossip = {
        category: category,
        speakers: dialogueObj.speakers,
        lines: dialogueObj.lines,
        currentLineIndex: 0
    };
    console.log(`[情报生成] 趋势锁定: ${game.dailyTrend} (文案: ${category})`);
}

// 启动对话流程
function startMarketChatterFlow() { 
    const layer = document.getElementById('market-chatter-layer'); 
    if (!layer) {
        // 如果层不存在，这里可以是一个容错逻辑，或者直接创建它
        // 但根据新的设计，我们最好在 startMarketChatterFlow 内部确保它的存在
        const newLayer = document.createElement('div'); 
        newLayer.id = 'market-chatter-layer'; 
        newLayer.style.cssText = "position:absolute; top:0; left:0; width:100%; height:100%; z-index:5000;"; 
        
        // 顶部返回按钮
        const headerHtml = `
            <div style="position:absolute; top:0; left:50%; transform:translateX(-50%); width:100%; max-width:1200px; padding:15px 20px; box-sizing:border-box; z-index:5002; display:flex; justify-content:flex-end; pointer-events:none;">
                <button class="btn-back dark" onclick="playSfx(300, 'sine', 0.1); switchScreen('start-screen')" style="pointer-events:auto;"><span>↩</span> 返回</button>
            </div>
        `;
        newLayer.innerHTML = headerHtml;

        // 消息容器
        const listContainer = document.createElement('div'); 
        listContainer.id = 'chat-history-container'; 
        newLayer.appendChild(listContainer); 
        
        // 底部提示
        const hint = document.createElement('div'); 
        hint.className = 'chat-hint-text';
        hint.innerText = "(点击屏幕继续) ▶"; 
        hint.style.cssText = "position:absolute; bottom:20px; width:100%; text-align:center; color:rgba(255,255,255,0.5); font-size:12px; pointer-events:none; animation:fadeIn 1s infinite alternate;"; 
        newLayer.appendChild(hint); 
        
        // 点击事件
        newLayer.onclick = (e) => { 
            if(e.target.closest('button')) return; 
            window.advanceChatter(); 
        };
        
        const prepModal = document.getElementById('prep-modal');
        if (prepModal) prepModal.appendChild(newLayer);
    } else {
        // 重置
        const container = document.getElementById('chat-history-container'); 
        if (container) container.innerHTML = ''; 
        const hint = layer.querySelector('.chat-hint-text');
        if (hint) {
            hint.style.display = 'block';
            hint.innerText = "(点击屏幕继续) ▶"; 
        }
        layer.style.display = 'block';
    }

    // 确保再次获取 (如果是刚创建的)
    const activeLayer = document.getElementById('market-chatter-layer');
    if (!activeLayer) return;

    // === 核心逻辑修正：完整的 if...else 结构 ===
    const hasPlayedMarketIntro = localStorage.getItem('hasPlayedMarketIntro'); 
    
    if (!hasPlayedMarketIntro) { 
        // === 首次进入集市：打招呼剧情 (去除特定名字与沉重词汇) === 
        game.dailyGossip = { 
            speakers: ["道明叔", "我", "左伊姐", "我", "老张头", "我"], 
            lines: [ 
                "哎哟喂！这不是老掌柜家那丫头吗？好几年没见，出落得越发水灵了！", 
                "道明叔早呀！我回来接手爷爷的老店啦，今天第一天来进货，您可得多关照我！", 
                "那必须的！欢迎回来小老板，以后铺子里缺什么调料尽管来找姐，全按底价给你拿！", 
                "太感谢左伊姐了，有大家在我心里就踏实多了！", 
                "好好干丫头！老店重新开张，大家伙儿都替你高兴。海鲜找老头子我准没错！", 
                "嗯！老张头您放心，我一定会把咱们老店的招牌重新擦亮的！" 
            ], 
            currentLineIndex: 0 
        }; 
        localStorage.setItem('hasPlayedMarketIntro', 'true'); 
    } else { 
        // === 非首次进入：随机八卦剧情 === 
        // 这里直接嵌入随机生成逻辑，确保不依赖外部调用
        if (typeof MARKET_GOSSIP_CONFIG !== 'undefined') {
            const categories = Object.keys(MARKET_GOSSIP_CONFIG); 
            const randomCategory = categories[Math.floor(Math.random() * categories.length)]; 
            
            const subCategories = Object.keys(MARKET_GOSSIP_CONFIG[randomCategory]); 
            const randomSub = subCategories[Math.floor(Math.random() * subCategories.length)]; 
            
            const gossipList = MARKET_GOSSIP_CONFIG[randomCategory][randomSub]; 
            const randomGossip = gossipList[Math.floor(Math.random() * gossipList.length)]; 
            
            game.dailyGossip = { 
                speakers: randomGossip.speakers, 
                lines: randomGossip.lines, 
                currentLineIndex: 0 
            }; 
        } else {
             // 容错
             game.dailyGossip = { speakers: ["系统"], lines: ["今日集市风平浪静。"], currentLineIndex: 0 };
        }
    } 

    // 启动显示
    appendNextChatMessage(); 
}

// [新增] 追加气泡核心逻辑
function appendNextChatMessage() { 
    const gossip = game.dailyGossip; 
    const container = document.getElementById('chat-history-container'); 
    
    if (!container || gossip.currentLineIndex >= gossip.lines.length) return; 
    
    const line = gossip.lines[gossip.currentLineIndex]; 
    let isLeft = (gossip.currentLineIndex % 2 === 0); 
    const speakerName = gossip.speakers[gossip.currentLineIndex % gossip.speakers.length]; 
    
    // [核心新增] 智能朝向修正 
    if (speakerName === '我') isLeft = true; 
    if (['道明叔', '左伊姐', '老张头', '林大婶', '刘大爷'].includes(speakerName)) isLeft = false; 
    if (speakerName === '滑板少年') isLeft = true;
    if (speakerName === '集市管理员') isLeft = false;
    
    // [核心修复] 左边是流动NPC(B角)，右边是固定摊主(A角) 
    const rolePrefix = isLeft ? "B角-" : "A角-"; 
    
    // 优先尝试的文件名 和 备用文件名 
    const primaryImageSrc = `assets/characters/${rolePrefix}${speakerName}.png`; 
    const fallbackImageSrc = `assets/characters/${speakerName}.png`; 
    const placeholderImageSrc = `assets/characters/${rolePrefix}占位符.png`;
    
    // 颜色生成逻辑 (最终兜底方案) 
    const charCode = speakerName.charCodeAt(0); 
    const colorList = ['#e67e22', '#3498db', '#e74c3c', '#9b59b6', '#1abc9c', '#f1c40f']; 
    const avatarColor = colorList[charCode % colorList.length]; 
    const avatarChar = speakerName.charAt(0); 

    const row = document.createElement('div'); 
    row.className = `chat-row ${isLeft ? 'left' : 'right'}`; 
    
    // [增强] 三重 onerror 机制 (Primary -> Fallback -> Placeholder -> CSS Box)
    // 注意：data 属性必须使用驼峰式访问，或者在 HTML 中避免连字符。
    // 这里我们将 HTML 属性改为 data-fallback1 以匹配 dataset.fallback1
    const portraitHtml = `
    <div class="chat-portrait-box">
        <img class="chat-portrait-img" src="${primaryImageSrc}" 
             data-fallback1="${fallbackImageSrc}"
             data-fallback2="${placeholderImageSrc}"
             onerror="
                if (!this.dataset.retry) {
                    this.dataset.retry = '1';
                    this.src = this.dataset.fallback1;
                } else if (this.dataset.retry === '1') {
                    this.dataset.retry = '2';
                    this.src = this.dataset.fallback2;
                } else {
                    this.style.display='none';
                    this.nextElementSibling.style.display='flex';
                }
             ">
        <div class="chat-portrait-placeholder" style="background:${avatarColor}; display:none;"> 
            ${avatarChar} 
        </div> 
        <div class="chat-role-name">${speakerName}</div> 
    </div> 
    `; 

    let bubbleContent = line; 

    const isLastLine = gossip.currentLineIndex === gossip.lines.length - 1; 
    if (isLastLine) { 
        const hint = document.querySelector('#market-chatter-layer > div:last-child'); 
        if(hint && hint.innerText.includes('点击')) hint.style.display = 'none'; 

        bubbleContent += ` 
            <div class="chat-action-area"> 
                <button class="btn-start-shopping" onclick="event.stopPropagation(); playSfx(400, 'triangle', 0.3); finishChatterAndShop()"> 
                    开始买菜 
                </button> 
            </div> 
        `; 
    } 
    row.innerHTML = isLeft ? `${portraitHtml}<div class="chat-bubble">${bubbleContent}</div>` : `${portraitHtml}<div class="chat-bubble">${bubbleContent}</div>`; 
    
    container.appendChild(row); 
    playChatBubbleSound(); // [修改] 使用 IM 气泡音效
} 

// 点击推进逻辑
window.advanceChatter = function() { 
    const gossip = game.dailyGossip; 
    // 如果已经是最后一句，阻止点击屏幕触发（必须点按钮） 
    if (gossip.currentLineIndex >= gossip.lines.length - 1) { 
        return; 
    } 
    
    gossip.currentLineIndex++; 
    appendNextChatMessage(); 
}; 

// [新增] 结束对话并开始采购
window.finishChatterAndShop = function() { 
    const layer = document.getElementById('market-chatter-layer'); 
    if (layer) { 
        layer.style.transition = 'opacity 0.3s ease'; 
        layer.style.opacity = '0'; 
        setTimeout(() => { 
            layer.remove(); 
            if (!localStorage.getItem('hasPlayedIntro')) { 
                showUncleGaoInterlude(); 
                return; 
            } 
            revealPrepUI(); 
        }, 300); 
    } else { 
        if (!localStorage.getItem('hasPlayedIntro')) { 
            showUncleGaoInterlude(); 
            return; 
        } 
        revealPrepUI(); 
    } 
};

// 显示采购界面 (Fade In)
function revealPrepUI() {
    // 1. 触发黑幕 (持续 0.8s)
    const curtain = document.querySelector('.prep-curtain');
    if (curtain) curtain.classList.add('active');

    // 2. [核心修改] 延迟 800ms，等待黑幕完全盖住屏幕后，再显示 UI
    setTimeout(() => {
        const header = document.querySelector('.prep-header');
        const grid = document.getElementById('prep-grid');
        const footer = document.getElementById('prep-footer');

        const reveal = (el) => {
            if (el) {
                el.classList.remove('prep-ui-hidden');
                el.classList.add('prep-ui-visible');
            }
        };

        reveal(header);
        reveal(grid);
        reveal(footer);

        // 恢复 Footer 滑入动画
        if (footer) {
            footer.style.animation = 'footerSlideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';
        }
    }, 800); // 对应 CSS 动画时长
}

// [已废弃] 旧的 renderMarketChatter，保留作为兼容或移除
function renderMarketChatter_deprecated(onComplete) {
    // ...
}

// [新增] 辅助函数：打开商店UI
function openShopUI() {
    const shopOverlay = document.getElementById('shop-overlay');
    if (!shopOverlay) return;
    renderShop();
    updateBalanceDisplay();
    shopOverlay.style.display = 'flex';
}

function renderShop() {
    // playShopMusic(); // [Fixed] Removed duplicate music call. AudioController handles this in showShop().
    const overlay = document.getElementById('shop-overlay');
    if (!overlay) return;

    // [新增] 获取当前区域 ID (例如 'cn', 'jp')
    const ngParams = JSON.parse(localStorage.getItem('ng_params') || '{}');
    const currentRegion = (ngParams.location || 'cn:main').split(':')[0];

    const currentTab = SHOP_TABS.find(t => t.id === currentShopTab) || SHOP_TABS[0];
    const types = currentTab.types;

    // 1. 收集所有卡片的 HTML 到数组中
    let allCards = [];
    types.forEach((key) => {
        const config = SHOP_CONFIG[key];
        if (!config) return;
        const currentLevelIdx = game.inventory[key] || 0;
        
        config.levels.forEach((levelData, levelIdx) => {
            const isOwned = levelIdx <= currentLevelIdx;
            const isNext = levelIdx === currentLevelIdx + 1;
            const itemName = levelData.name;
            const isDigital = levelData.isDigital;
            let iconHtml = getShopItemIcon(key);

            // [核心修改] 图片加载逻辑重构
            if (key === 'pot') {
                // 厨具保持原逻辑，使用 itemName 加载
                const targetPots = ['基础铁锅', '专业不粘锅', '多段控温精钢锅', 'Omni 1.0', 'Omni 2.0', 'Omni 3.0', '单边小锅', '小锅'];
                // 简单的模糊匹配防止改名失效
                if (targetPots.some(t => itemName.includes(t)) || true) {
                    const fallbackId = `fallback-pot-${levelIdx}-${key}`;
                    // [修复] Omni 系列文件名无空格 (Omni1.0.png)，但名称有空格 (Omni 1.0)
                    const fileName = itemName.replace(/\s+/g, '');
                    iconHtml = `
                        <img src="assets/equipment/${fileName}.png" 
                             alt="${itemName}" 
                             style="width: 100%; height: 100%; object-fit: contain;" 
                             onerror="this.style.display='none'; document.getElementById('${fallbackId}').style.display='flex';">
                        <span id="${fallbackId}" style="display:none; width:100%; height:100%; align-items:center; justify-content:center; font-size:50px;">${getShopItemIcon(key)}</span>
                    `;
                }
            } else if (key === 'expansion') {
                // [核心升级] 装修图片：根据 国家 + 等级 动态加载
                // 文件名格式: kitchen_cn_lv0.png
                const dynamicImgName = `kitchen_${currentRegion}_lv${levelIdx}`;
                const fallbackId = `fallback-exp-${levelIdx}-${key}`;
                
                iconHtml = `
                    <img src="assets/equipment/${dynamicImgName}.png" 
                         alt="${itemName}" 
                         style="width: 100%; height: 100%; object-fit: contain;" 
                         onerror="this.style.display='none'; document.getElementById('${fallbackId}').style.display='flex';">
                    <span id="${fallbackId}" style="display:none; width:100%; height:100%; align-items:center; justify-content:center; font-size:50px;">${getShopItemIcon(key)}</span>
                `;
            }
            
            let digitalBadge = isDigital ? `<span class="digital-badge">DIGITAL</span>` : '';
            
            let btnHtml = '';
            if (isOwned) {
                btnHtml = `<button class="shop-btn-buy maxed">已拥有</button>`;
            } else if (isNext) {
                const price = getUpgradePrice(key, levelIdx);
                const canAfford = game.coins >= price;
                const btnClass = canAfford ? 'can-buy' : 'disabled';
                const btnText = canAfford ? `购买 (¥${price})` : `余额不足 (¥${price})`;
                // 购买后刷新页面，保持当前页码
                btnHtml = `<button class="shop-btn-buy ${btnClass}" onclick="playSfx(400, 'triangle', 0.1); buyUpgrade('${key}', this)">${btnText}</button>`;
            } else {
                 btnHtml = `<button class="shop-btn-buy disabled">需前置等级</button>`;
            }

            const cardHtml = `
                <div class="shop-item-card ${isDigital ? 'digital-card' : ''} ${isOwned ? 'owned-card' : ''}">
                    <div class="shop-item-image-container">
                        <div class="shop-item-icon">${iconHtml}</div>
                    </div>
                    <div class="shop-item-content">
                        <div class="shop-item-header">
                            <div class="shop-item-title-group">
                                <div class="shop-item-category">${config.name}</div>
                                <div class="shop-item-name">${itemName} ${digitalBadge}</div>
                            </div>
                            <div class="shop-item-level">Lv.${levelIdx}</div>
                        </div>
                        <div class="shop-item-desc">${config.desc}</div>
                        <div class="shop-item-effect">${levelData.effectText}</div>
                        <div class="shop-item-footer">${btnHtml}</div>
                    </div>
                </div>
            `;
            allCards.push(cardHtml);
        });
    });

    // 2. 计算分页
    const totalPages = Math.ceil(allCards.length / SHOP_ITEMS_PER_PAGE) || 1;
    
    if (currentShopPage >= totalPages) currentShopPage = totalPages - 1;
    if (currentShopPage < 0) currentShopPage = 0;

    const start = currentShopPage * SHOP_ITEMS_PER_PAGE;
    const end = start + SHOP_ITEMS_PER_PAGE;
    const pageCards = allCards.slice(start, end).join('');

    const tabsHtml = SHOP_TABS.map(tab => `
        <button class="shop-tab ${tab.id === currentTab.id ? 'active' : ''}" onclick="switchShopTab('${tab.id}')">${tab.label}</button>
    `).join('');

    // 3. 构建分页控制栏 HTML
    const prevDisabled = currentShopPage === 0 ? 'disabled style="opacity:0.5; cursor:default;"' : '';
    const nextDisabled = currentShopPage === totalPages - 1 ? 'disabled style="opacity:0.5; cursor:default;"' : '';
    
    const paginationHtml = `
        <div class="shop-pagination">
            <button class="shop-page-btn" ${prevDisabled} onclick="changeShopPage(-1)">◀ 上一页</button>
            <span class="shop-page-info">${currentShopPage + 1} / ${totalPages}</span>
            <button class="shop-page-btn" ${nextDisabled} onclick="changeShopPage(1)">下一页 ▶</button>
        </div>
    `;

    // 4. 组装最终 HTML (Grid + Footer)
    overlay.innerHTML = `
        <div class="shop-modal">
            <div class="shop-header">
                <div class="shop-header-left">
                    <button class="shop-back-btn" onclick="closeShop()">返回</button>
                    <div class="shop-title">🛒 道具商店</div>
                </div>
                <div class="home-balance" style="position:static; transform:none; min-width:auto; height:40px; border-color:rgba(255,255,255,0.2);">
                    <span>钱包</span>
                    <span id="shop-balance">¥${game.coins}</span>
                </div>
            </div>
            <div class="shop-tabs">
                ${tabsHtml}
            </div>
            <div id="shop-items-container" style="flex: 1; overflow: hidden; padding: 20px 40px; display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(2, 1fr); gap: 20px;">
                ${pageCards}
            </div>
            ${paginationHtml}
        </div>
    `;

    updateBalanceDisplay();
}

function showShop() {
    AudioController.playShop();
    const startScreen = document.getElementById('start-screen');
    if (startScreen) {
        startScreen.style.display = 'none';
    }

    const shopOverlay = document.getElementById('shop-overlay');
    if (!shopOverlay) {
        console.error('未找到 shop-overlay 容器');
        return;
    }
    renderShop();
    updateBalanceDisplay();
    shopOverlay.style.display = 'flex';
}

function closeShop() {
    startMusic();
    const shopOverlay = document.getElementById('shop-overlay');
    if (shopOverlay) {
        shopOverlay.style.display = 'none';
    }

    // Only show start screen if game hasn't started yet (startTime is 0)
    if (game.startTime === 0) {
        const startScreen = document.getElementById('start-screen');
        if (startScreen) {
            startScreen.style.display = 'flex';
            updateBalanceDisplay();
            // [修复] 返回首页时恢复背景音乐
            /* 
            if (themeMusicEnabled) {
                const bgm = document.getElementById('bgm');
                if (bgm && bgm.paused) bgm.play().catch(e => console.log(e));
            }
            */
        }
    } else {
        // Return to game/settlement view
        updateBalanceDisplay();
    }
}

function showInsufficientBalanceFeedback() {
    const homeBalance = document.getElementById('home-balance');
    const shopBalance = document.getElementById('shop-balance');
    [homeBalance, shopBalance].forEach(el => {
        if (!el) return;
        el.classList.add('balance-alert');
        el.classList.add('balance-shake');
        setTimeout(() => {
            el.classList.remove('balance-shake');
        }, 600);
    });
    showToast("主厨，资金不足，快去开餐赚钱吧！");
}

function buyUpgrade(type, btnEl) {
    const config = SHOP_CONFIG[type];
    if (!config) return;
    
    const currentLevelIdx = game.inventory[type] || 0;
    const nextLevelIdx = currentLevelIdx + 1;
    
    if (nextLevelIdx >= config.levels.length) return;
    
    const price = getUpgradePrice(type, nextLevelIdx);
    if (game.coins >= price) {
        game.coins -= price;
        game.inventory[type] = nextLevelIdx;
        
        saveGameState();
        updateBalanceDisplay();
        
        playSfx(880, 'sine', 0.1); 
        playSfx(1100, 'sine', 0.2);
        playCoin();
        if (btnEl) {
            btnEl.classList.remove('flash');
            void btnEl.offsetWidth;
            btnEl.classList.add('flash');
        }
        
        renderShop();
        
        triggerFeedback(window.innerWidth / 2, window.innerHeight / 2, `升级成功！-¥${price}`, '#2ecc71');
    } else {
        showInsufficientBalanceFeedback();
    }
}

const GameStateManager = {
    // [核心修改] 增加 keepLegacy 参数，默认为 false (完全重置)
    resetAllData: function(keepLegacy = false) {
        const keysToRemove = [
            'gameState',          // 核心存档
            'restaurant_game_save', // 兼容可能的旧存档名
            'yesterdayRate',      // 昨日评分
            'ng_params',          // 新征程参数
            'dailyLegacyIncome'
        ];
        
        // [关键] 只有在非继承模式下，才删除旧店存档列表
        if (!keepLegacy) {
            keysToRemove.push('legacy_shops_list');
            // 兼容清理旧版单店数据
            keysToRemove.push('legacy_shop_data');
            // [核心新增] 清除高叔新手剧情的播放记录！
            keysToRemove.push('hasPlayedIntro');
            // [核心新增] 清除集市初见剧情
            keysToRemove.push('hasPlayedMarketIntro');
            // [核心新增] 清除开业贺礼领取记录
            keysToRemove.push('hasSeenPrepGift');
        }
        
        keysToRemove.forEach(key => localStorage.removeItem(key));
        
        // 重置运行时对象
        game.level = 1;
        game.totalRevenue = 0;
        game.dailyRevenue = 0;
        game.history = [];
        game.orderQueue = [];
        game.coins = 0;
        game.inventory = { pot: 0, belt: 0, fridge: 0, expansion: 0 };
        
        window.tempInventory = {};
        window.tempCoins = 0;
        window.startCoins = 0;
        
        saveGameState();
        console.log(`Game reset. Keep Legacy: ${keepLegacy}`);
    },
    
    resetAllDataPrompt: function() {
        if (confirm("⚠️ 警告：这将删除所有存档（包括所有分店进度），完全回到初始状态。\n\n确定要重置吗？")) {
            this.resetAllData(false); // 手动重置是彻底清除
            location.reload();
        }
    }
};

let game = {
    level: 1, revenue: 0, served: 0, total: 0, spawned: 0, isLive: true, isPaused: false, dayEnded: false,
    dailyRevenue: 0, totalRevenue: 0, targetRevenue: 1000,
    dailyDishCount: 0, dailyQualitySum: 0,
    activeOrders: [],
    orderQueue: [], // 每日预生成订单队列
    dailyGossip: null, // [新增] 每日街坊情报
    dailyInventory: {}, // Daily stock levels
    logs: [], // 系统日志
    history: [], // Stores {day, revenue, rate}
    coins: 0, // 当前可用货币
    inventory: { pot: 0, belt: 0, fridge: 0, expansion: 0 }, // 商店道具等级
    startTime: 0, // Game start timestamp
    totalErrors: 0, // Track operational errors
    totalOrdersCompleted: 0, // Track total completed orders
    totalDishesServed: 0, // Track total dishes served
    getGoal: (lv) => 4 + lv,
    getSpeed: (lv) => {
        const base = 0.5 + (lv * 0.15);
        const beltEffect = getBeltEffect();
        const factor = Math.max(0.4, 1 - beltEffect);
        return base * factor;
    },
    getDishesPerOrder: (lv) => lv < 3 ? 1 : (lv < 7 ? 2 : 3),
    timeRemaining: 120, // Global Timer
    lastTime: 0
};

function getKnifeEffect() {
    const level = game.inventory.knife || 0;
    const cfg = SHOP_CONFIG.knife;
    if (!cfg) return 0;
    const lv = cfg.levels[level];
    return lv ? (lv.effect || 0) : 0;
}

function getPotEffect() {
    const level = game.inventory.pot || 0;
    const cfg = SHOP_CONFIG.pot;
    if (!cfg) return 0;
    const lv = cfg.levels[level];
    return lv ? (lv.effect || 0) : 0;
}

function getBeltEffect() {
    const level = game.inventory.belt || 0;
    const cfg = SHOP_CONFIG.belt;
    if (!cfg) return 0;
    const lv = cfg.levels[level];
    return lv ? (lv.effect || 0) : 0;
}

function getRequiredPrepClicks(dish) {
    const base = dish && dish.p ? dish.p : 3;
    const effect = getKnifeEffect();
    const factor = Math.max(0.3, 1 - effect);
    return Math.max(1, Math.round(base * factor));
}

// Persistence Helpers
function saveGameState() {
    try {
        const state = {
            level: game.level,
            coins: game.coins,
            inventory: game.inventory,
            totalRevenue: game.totalRevenue,
            totalOrdersCompleted: game.totalOrdersCompleted,
            totalDishesServed: game.totalDishesServed,
            history: game.history
        };
        localStorage.setItem('gameState', JSON.stringify(state));
        console.log("Game Saved:", state);
    } catch (e) { console.error("Save failed:", e); }
}

function logSystemEvent(tag, payload) {
    const ts = new Date().toISOString();
    const body = payload && typeof payload === 'object' ? JSON.stringify(payload) : '';
    const msg = `[${ts}] [${tag}] ${body}`;
    console.log(msg);
    if (Array.isArray(game.logs)) {
        game.logs.push(msg);
        if (game.logs.length > 200) game.logs.shift();
    }
}

function loadGameState() {
    try {
        const raw = localStorage.getItem('gameState');
        if (raw) {
            const state = JSON.parse(raw);
            if (state.level) game.level = state.level;
            if (state.coins !== undefined) game.coins = state.coins;
            if (state.inventory) {
                game.inventory = state.inventory;
                if (game.inventory.expansion === undefined) game.inventory.expansion = 0; // Backwards compatibility
            }
            
            if (state.totalRevenue) game.totalRevenue = state.totalRevenue;
            if (state.totalOrdersCompleted) game.totalOrdersCompleted = state.totalOrdersCompleted;
            if (state.totalDishesServed) game.totalDishesServed = state.totalDishesServed;
            if (state.history) game.history = state.history;
            
            console.log("Game Loaded:", state);
        }
    } catch (e) { console.error("Load failed:", e); }
}

function generateDailyOrders(level) {
    try {
        const goal = game.getGoal(level);
        game.orderQueue = [];
        
        // 1. 确定当前解锁的菜谱池
        let availableRecipes = [];
        if (level >= 1) availableRecipes.push(...RECIPES.slice(0, 2)); // 基础: 番茄炒蛋, 洋葱炒蛋
        if (level >= 3) availableRecipes.push(...RECIPES.slice(2, 6)); // 进阶: 肉片, 肉丝, 麻婆豆腐, 炖肉
        if (level >= 6) availableRecipes.push(...RECIPES.slice(6, 9)); // 高级: 虾仁, 牛肉
        if (level >= 9) availableRecipes.push(...RECIPES.slice(9, 12)); // 复杂: 地三鲜, 炒饭
        if (availableRecipes.length === 0) availableRecipes = [RECIPES[0]];

        // 2. [核心修改] 读取 generateDailyGossip 生成的趋势
        // 如果没有生成过(比如第一天直接开始)，默认 balanced
        const todayTrend = game.dailyTrend || 'balanced';
        console.log(`[订单生成] 当前关卡: ${level}, 今日趋势: ${todayTrend}`);
        
        // 3. 构建加权卡池
        let weightedPool = [...availableRecipes];
        
        if (todayTrend !== 'balanced') {
            // 筛选符合趋势的菜品
            const trendDishes = availableRecipes.filter(r => {
                const ings = r.ingredients; // 简写
                
                if (todayTrend === 'meat') {
                    // 猪肉、牛肉、鸡肉(如有)
                    return ings.includes('pork') || ings.includes('beef');
                }
                if (todayTrend === 'vege') {
                    // 纯素菜或蔬菜占比高的
                    // 逻辑：必须包含蔬菜，且不含高级肉类(虾/牛)以符合清淡定义，或者就是特定的素菜
                    // 简单逻辑：只要有番茄、土豆、青椒、洋葱
                    return ings.includes('tomato') || ings.includes('potato') || ings.includes('pepper') || ings.includes('onion');
                }
                if (todayTrend === 'seafood') {
                    // 虾仁、鱼
                    return ings.includes('shrimp');
                }
                if (todayTrend === 'spicy') {
                    // [新增] 辣味/重口：青椒、豆腐(麻婆)、洋葱
                    // 这里的逻辑需要根据你的 RECIPES 定义来
                    // 假设：麻婆豆腐(tofu), 青椒肉丝(pepper), 葱爆牛肉(onion) 算重口
                    return ings.includes('pepper') || ings.includes('tofu') || r.name.includes('葱爆');
                }
                return false;
            });
            // [核心] 疯狂加权：符合趋势的菜品放入池子 4 次
            // 这样玩家如果按攻略囤货，大概率能碰上；如果不囤，大概率会缺货
            if (trendDishes.length > 0) {
                for(let k=0; k<4; k++) {
                    weightedPool.push(...trendDishes);
                }
                console.log(`[订单生成] 已针对 [${todayTrend}] 加权，卡池大小: ${weightedPool.length}`);
            }
        }
        // 4. 生成订单
        for (let i = 0; i < goal; i++) {
            const count = Math.ceil(Math.random() * game.getDishesPerOrder(level));
            const dishes = [];
            
            for(let j=0; j<count; j++) {
                // 从加权池中抽取
                const recipe = weightedPool[Math.floor(Math.random() * weightedPool.length)];
                dishes.push(recipe);
            }
            
            game.orderQueue.push({
                id: Date.now() + Math.random(),
                dishes: dishes,
                qualityLoss: 0
            });
        }
        saveGameState();
        return true;
    } catch (e) {
        console.error("Order generation failed:", e);
        return false;
    }
}

// Initialize History Data
let yesterdayRate = parseFloat(localStorage.getItem('yesterdayRate'));
if (isNaN(yesterdayRate)) yesterdayRate = 75.0; // Mock baseline for demo

const stations = {
    's1': { id: 's1', stage: 'IDLE', currentIngredients: [], recipe: null, progress: 0 },
    's2': { id: 's2', stage: 'IDLE', currentIngredients: [], recipe: null, progress: 0 },
    's3': { id: 's3', stage: 'IDLE', currentIngredients: [], recipe: null, progress: 0 },
    's4': { id: 's4', stage: 'IDLE', currentIngredients: [], recipe: null, progress: 0 }
};

/** 核心逻辑 **/
function checkSpawn() {
    if (!game.isLive || game.isPaused) return;
    
    // Initialize slots if not exists
    if (!game.orderSlots) game.orderSlots = [null, null, null, null, null];
    if (!game.slotCooldowns) game.slotCooldowns = [0, 0, 0, 0, 0];

    // [核心修改] 获取当前解锁的订单槽数量
    const expLvl = (game.inventory && game.inventory.expansion) ? game.inventory.expansion : 0;
    // Safety check: ensure SHOP_CONFIG is loaded
    const unlockedSlots = (SHOP_CONFIG && SHOP_CONFIG.expansion) ? SHOP_CONFIG.expansion.levels[expLvl].slots : 2;

    const now = Date.now();

    // Check each slot (only up to unlockedSlots)
    for (let idx = 0; idx < unlockedSlots; idx++) {
        const slot = game.orderSlots[idx];
        if (slot === null) {
             // Check Cooldown
             if (game.slotCooldowns[idx] > now) continue;
             
             // Spawn Chance (per slot)
             if (Math.random() < 0.005) spawnOrder(idx);
        }
    }
}

// 辅助函数：生成订单的 HTML 结构 (图片版，最多展示 3 道菜)
 function renderOrderHTML(order) { 
     const dishes = (order.dishes || []).slice(0, 3);
     const dishListHtml = dishes.map(d => { 
         const ingredientsList = d.ingredients || []; 
         let recipeHtml = ''; 
         if (ingredientsList.length > 0) { 
             recipeHtml = '<div class="recipe-tags">'; 
             ingredientsList.forEach(ingId => { 
                 const ingData = INGREDIENTS[ingId]; 
                 if (ingData) { 
                     recipeHtml += `<span class="micro-ing" title="${ingData.name}">${ingData.icon}</span>`; 
                 } 
             }); 
             recipeHtml += '</div>'; 
         } 
         
         // [核心修改] 使用 img 标签，src 自动指向 "菜名.png" 
         // 增加了 onerror 处理：如果图片不存在，回退显示 Emoji (d.icon) 
         return ` 
             <div class="order-item"> 
                 <img src="assets/dishes/${d.name}.png" class="item-icon" alt="${d.name}"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"> 
                 <span class="item-icon" style="display:none; font-size:24px;">${d.icon || '🥘'}</span> 
                 
                 <div class="order-info-col"> 
                     <span class="item-name">${d.name}</span> 
                     ${recipeHtml} 
                 </div> 
             </div>`; 
     }).join(''); 
 const fillPct = (order.patience / order.maxPatience) * 100; 
 return `<b>#${game.spawned}</b> <div class="order-list">${dishListHtml}</div> <div class="patience-bar"><div class="patience-fill" style="height:${fillPct}%"></div></div>`; 
 
 
 }

function spawnOrder(slotIdx, requeuedOrder = null) { 
     if (!game.isLive || game.isPaused) return; 
     if (!requeuedOrder && Array.isArray(game.activeOrders) && game.activeOrders.length >= 5) return;
     
     let order; 
     if (requeuedOrder) { 
         order = requeuedOrder; 
         order.patience = 2500; // 重置耐心值 
     } else { 
         if (game.orderQueue && game.orderQueue.length > 0) { 
             // 优先使用每日预设队列 
             order = game.orderQueue.shift(); 
             saveGameState(); 
        } else { 
            // [核心修复] 队列耗尽后的兜底逻辑：必须严格遵循关卡解锁规则！ 
             const level = game.level; 
             let availableRecipes = []; 
             
             // 严格的解锁梯度 (需与 generateDailyOrders 保持一致) 
             if (level >= 1) availableRecipes.push(...RECIPES.slice(0, 2)); // 基础 (番茄/蛋/洋葱) 
             if (level >= 3) availableRecipes.push(...RECIPES.slice(2, 6)); // 进阶 (猪肉/土豆/青椒/豆腐) 
             if (level >= 6) availableRecipes.push(...RECIPES.slice(6, 9)); // 高级 (牛肉/虾) 
             if (level >= 9) availableRecipes.push(...RECIPES.slice(9, 12)); // 复杂 (米饭/组合) 
             
             // 兜底防止空数组 
             if (availableRecipes.length === 0) availableRecipes = [RECIPES[0]]; 
        // 生成符合当前关卡的随机订单，最多 3 道菜
        const maxPerOrder = 3;
        const desired = Math.ceil(Math.random() * game.getDishesPerOrder(game.level));
        const count = Math.min(desired, maxPerOrder);
        const dishes = []; 
        for(let i=0; i<count; i++) { 
            // 从“已解锁池”中随机，绝不使用全局 RECIPES 
            const recipe = availableRecipes[Math.floor(Math.random() * availableRecipes.length)]; 
            dishes.push(recipe); 
        } 
        order = { id: Date.now() + Math.random(), dishes }; 
    } 

    // 任何来源的订单，统一限制最多 3 道菜
    if (!Array.isArray(order.dishes)) order.dishes = [];
    if (order.dishes.length > 3) order.dishes = order.dishes.slice(0, 3);

    game.spawned++; 
} 
 // 设置订单属性 
 order.slotIdx = slotIdx; 
 order.maxPatience = 60000 + (game.level * 2000); 
 order.patience = order.maxPatience; 
 order.dom = null; 
 const el = document.createElement('div'); 
 el.className = 'order-ticket'; 
 // 渲染订单卡片 
 if (typeof renderOrderHTML === 'function') { 
     el.innerHTML = renderOrderHTML(order); 
 } else { 
     el.innerHTML = `<b>#${game.spawned}</b><div class="order-list">...</div>`; 
 } 
 el.onclick = () => takeOrder(order); 
 
 // 挂载到对应槽位 
 const slotEl = document.getElementById('order-slot-' + slotIdx); 
 if (slotEl) { 
     slotEl.innerHTML = ''; 
     slotEl.appendChild(el); 
 } 
 
 order.dom = el; 
 game.activeOrders.push(order); 
 game.orderSlots[slotIdx] = order; 
 
 // 高亮匹配检查 
 updateCursor(); 
 }

function takeOrder(order) {
    if (game.isPaused) return;
    // 1. 检查手里是否有菜
    if (!holdingThing || holdingThing.type !== 'DISH') {
        const rect = order.dom.getBoundingClientRect();
        triggerFeedback(rect.left + rect.width / 2, rect.top - 20, "请先做好菜!", "red");
        return;
    }
    const heldDish = holdingThing.val;
    const dishIndex = order.dishes.findIndex(d => (d.name || d.n) === heldDish.name);
    // [核心修复] 菜送错了：自动退回原工位
    if (dishIndex === -1) {
        const rect = order.dom.getBoundingClientRect();
        triggerFeedback(rect.left + rect.width / 2, rect.top - 20, "菜送错了!", "red");

        // 尝试退回原工位
        if (holdingThing.sourceSid) {
            const s = stations[holdingThing.sourceSid];
            // 只有当工位是空的时候才退回，防止覆盖新做的菜
            if (s && s.stage === 'IDLE') {
                s.stage = 'FINISHED';
                s.dishResult = heldDish;
                s.recipe = heldDish;
                renderStation(holdingThing.sourceSid); // 刷新工位视觉

                holdingThing = null; // 清空手牌
                updateCursor();
                playSfx(150, 'sawtooth', 0.2);
                triggerFeedback(rect.left + rect.width / 2, rect.top + 20, "已退回工位", "orange");
            } else {
                triggerFeedback(rect.left + rect.width / 2, rect.top + 20, "原工位已满，无法退回", "#999");
            }
        }
        return;
    }
    // 2. 匹配成功：执行交单
    const basePrice = heldDish.price || 30;
    const quality = (heldDish.quality !== undefined) ? heldDish.quality : 1;
    const price = Math.ceil(basePrice * quality);

    // Play Revenue Sound (Coin sound)
    playRevenueSound();

    // UI 反馈
    const rect = order.dom.getBoundingClientRect();
    let label = `+¥${price}`;
    if (quality < 1) label += ` (${Math.floor(quality * 100)}%)`;
    const color = quality === 1 ? "#2ecc71" : (quality >= 0.7 ? "#e67e22" : "#e74c3c");
    triggerFeedback(rect.left + rect.width / 2, rect.top - 20, label, color);

    // [核心修复] 更新统计数据
    game.dailyRevenue += price;
    game.totalRevenue += price;
    game.revenue = game.dailyRevenue;
    game.coins += price;
    game.totalOrdersCompleted++;
    game.totalDishesServed++;
    // 关键：累加及格率数据
    game.dailyDishCount = (game.dailyDishCount || 0) + 1;
    game.dailyQualitySum = (game.dailyQualitySum || 0) + quality;

    // 移除订单中的菜品
    order.dishes.splice(dishIndex, 1);
    // 成功后，清空手里的菜
    holdingThing = null;
    updateCursor();

    // 检查订单是否全部完成
    if (order.dishes.length === 0) {
        const idx = game.activeOrders.indexOf(order);
        if (idx > -1) game.activeOrders.splice(idx, 1);

        if (game.orderSlots[order.slotIdx] === order) {
            game.orderSlots[order.slotIdx] = null;
            if (!game.slotCooldowns) game.slotCooldowns = [0, 0, 0, 0, 0];
            game.slotCooldowns[order.slotIdx] = Date.now() + 2000;
        }
        if (order.dom) order.dom.remove();
        game.served++;
        game.total++;
        // playCoin(); // Removed to avoid duplicate sound. playRevenueSound() is called when dish is served.
    } else {
        // [核心修改] 刷新订单显示（剩余菜品），带配方提示
        order.dom.innerHTML = renderOrderHTML(order);
    }
    updateHUD();
}

// Removed legacy functions: startStage, handleStation, trashOrder, confirmPrep, finishDishOrOrder, finishOrderFinal


function update() {
    if (!game.isLive) return;

    const now = Date.now();
    let dt = (now - game.lastTime) / 1000;
    if (dt > 1) dt = 0.016; // Safety cap
    game.lastTime = now;

    if (game.isPaused) { requestAnimationFrame(update); return; }
    
    // Timer Logic
    game.timeRemaining -= dt;
    const timerEl = document.getElementById('game-timer');
    if (timerEl) {
        const t = Math.max(0, Math.ceil(game.timeRemaining));
        timerEl.innerText = t;
        if (t <= 10) {
             timerEl.style.color = (Math.floor(now / 500) % 2 === 0) ? '#e74c3c' : '#ffffff';
        } else {
             timerEl.style.color = '#fff';
        }
    }

    if (game.timeRemaining <= 0) {
        settleDay("营业时间结束！");
        return;
    }
    
    // 调用智能生成逻辑
    checkSpawn();
    
    // Update Orders (Static Board Logic)
    game.activeOrders.forEach((order, idx) => {
        // Decrease Patience
        order.patience -= 16; // Approx 60fps
        
        // Update Visual Bar
        if (order.dom) {
            const fill = order.dom.querySelector('.patience-fill');
            if (fill) {
                const pct = (order.patience / order.maxPatience) * 100;
                
                // [核心修改] 控制 height 而不是 width
                fill.style.height = pct + '%';
                
                // 颜色逻辑保持不变
                if (pct < 30) fill.style.backgroundColor = '#e74c3c'; // Red warning
                else fill.style.backgroundColor = '#2ecc71'; // Green (Reset from yellow if needed)
            }
        }

        if (order.patience <= 0) {
            // Expired
            game.totalErrors++;
            
            // [核心修复] 计算动态罚款 (订单总价的 20%)
            const orderTotal = order.dishes.reduce((sum, d) => sum + (d.price || 0), 0);
            const penalty = Math.ceil(orderTotal * 0.2);
            
            if (order.dom) {
                 const rect = order.dom.getBoundingClientRect();
                 // [核心修复] 修正货币符号为 ¥
                 triggerFeedback(rect.left + rect.width/2, rect.top, `顾客离开 -¥${penalty}`, "red");
                 order.dom.remove();
            }
            game.activeOrders.splice(idx, 1);
            
            // Clear Slot
            if (game.orderSlots[order.slotIdx] === order) {
                game.orderSlots[order.slotIdx] = null;
                // Add Cooldown
                if (!game.slotCooldowns) game.slotCooldowns = [0,0,0,0,0];
                game.slotCooldowns[order.slotIdx] = Date.now() + 5000;
            }

            // [核心修复] 扣除动态罚款
            game.revenue = Math.max(0, game.revenue - penalty);
            game.coins = Math.max(0, game.coins - penalty);
            
            // [核心修改] 替换为随机生气音效
            playRandomAngrySound();
            updateHUD();
        }
    });

    requestAnimationFrame(update);
}

function triggerFeedback(x, y, text, color) {
    const div = document.createElement('div');
    div.className = 'float-text';
    div.innerText = text;
    document.body.appendChild(div);
    
    // 计算居中偏移 (需要先添加到DOM才能获取宽度)
    const w = div.offsetWidth;
    div.style.left = (x - w / 2) + 'px'; // 水平居中
    div.style.top = y + 'px';
    div.style.color = color;
    
    setTimeout(() => div.remove(), 1200);
}

function showToast(text, duration = 2000) {
    const div = document.createElement('div');
    div.className = 'toast-msg';
    div.innerText = text;
    div.style.animationDuration = `${duration}ms`;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), duration + 100);
}

window.cycleStationEquipment = function(sid) {
    const s = stations[sid];
    // 只有空闲时允许换锅，防止烹饪中数据错乱
    if (s.stage !== 'IDLE' && s.stage !== 'PREP_ING') {
        // Find the button to position feedback
        const btn = document.querySelector(`#s_${sid} .btn-trash-mini[title*="切换设备"]`);
        const x = btn ? btn.getBoundingClientRect().left : event.clientX;
        const y = btn ? btn.getBoundingClientRect().top : event.clientY;
        triggerFeedback(x, y, "工作中无法换锅!", "red");
        return;
    }

    const maxLevel = game.inventory.pot || 0;
    // 循环切换： 0 -> 1 -> ... -> max -> 0
    s.equipLevel = (s.equipLevel || 0) + 1;
    if (s.equipLevel > maxLevel) s.equipLevel = 0;

    playSfx(300, 'sine', 0.1);
    renderStation(sid); // 刷新 UI 显示新锅

    // 提示当前装备名称
    const config = SHOP_CONFIG.pot.levels[s.equipLevel];
    const el = document.getElementById('s_'+sid);
    if (el) {
        const rect = el.getBoundingClientRect();
        triggerFeedback(rect.left + 100, rect.top + 50, `已装备: ${config.name}`, "#f1c40f");
    }
};

function renderStation(sid, updateMode = 'full') {
    const s = stations[sid];
    const el = document.getElementById('s_' + sid);
    if (!el) return;

    const currentPotLevel = (s.equipLevel !== undefined) ? s.equipLevel : ((game.inventory && game.inventory.pot) || 0);
    const potConfig = SHOP_CONFIG.pot.levels[currentPotLevel] || SHOP_CONFIG.pot.levels[0];
    const potName = potConfig.name;

    // 判断工位是否忙碌 (用于按钮状态，不再用于隐藏备菜区)
    const isBusy = (s.stage === 'COOKING' || s.stage === 'FINISHED');

    // [Partial Update] 备菜区局部刷新
    if (updateMode === 'prep' && el.querySelector('.station-card.prep-card')) {
        const prepCard = el.querySelector('.station-card.prep-card');
        const prepStatus = s.currentIngredients.length > 0 ? 'status-active' : '';
        
        // [核心修改] 移除 opacity/pointer-events 的置灰逻辑
        prepCard.className = `station-card prep-card ${prepStatus}`;
        prepCard.style.opacity = '';
        prepCard.style.pointerEvents = '';
        prepCard.style.filter = '';

        // 更新食材图标 (保持不变)
        const ingList = el.querySelector('.ing-list-prep');
        if (ingList) {
            ingList.innerHTML = '';
            s.currentIngredients.forEach(ingId => {
                const span = document.createElement('span');
                span.className = 'ing-item-small';
                if(typeof INGREDIENTS !== 'undefined' && INGREDIENTS[ingId]) {
                    span.innerText = INGREDIENTS[ingId].icon;
                }
                ingList.appendChild(span);
            });
        }

        // 更新砧板图片 (保持不变)
        const prepBowl = el.querySelector('.prep-bowl');
        if (prepBowl) {
             const existingImg = prepBowl.querySelector('img');
             const shouldHaveBoard = s.currentIngredients.length > 0;
             const targetSrc = shouldHaveBoard ? 'assets/station/备菜砧板.png' : 'assets/station/备菜盘.png';
             const targetAlt = shouldHaveBoard ? '备菜砧板' : '备菜盘';
             
             if (existingImg && !existingImg.src.includes(targetSrc.split('/').pop())) {
                 existingImg.src = targetSrc;
                 existingImg.alt = targetAlt;
             } else if (!existingImg) {
                 prepBowl.insertAdjacentHTML('beforeend', `<img src="${targetSrc}" alt="${targetAlt}">`);
             }
        }

        // [核心修改] 更新按钮：即使 isBusy 也要渲染按钮，但根据状态禁用
        const prepActionDiv = el.querySelector('.prep-action-container');
        const prepStatusDiv = el.querySelector('.prep-status-text');

        if (prepActionDiv && s.currentIngredients.length > 0) {
            const analysis = analyzeDish(s.currentIngredients);
            const labelColor = analysis ? analysis.color : '#999';
            const labelText = analysis ? analysis.name : '...';

            if (prepStatusDiv) {
                prepStatusDiv.innerHTML = labelText;
                prepStatusDiv.style.color = labelColor;
            }

            // 如果机器在忙，按钮显示“等待空闲”并禁用
            const btnDisabled = isBusy ? 'disabled style="background:#bdc3c7; cursor:not-allowed;"' : '';
            const btnText = isBusy ? '⏳ 等待空闲' : '🔥 开始烹饪';

            prepActionDiv.innerHTML = `
                <button class="move-btn" ${btnDisabled} onclick="event.stopPropagation(); this.disabled=true; startCooking('${sid}')">
                    ${btnText}
                </button>
            `;
        } else if (prepActionDiv) {
            prepActionDiv.innerHTML = '<div style="height:36px;"></div>';
            if (prepStatusDiv) prepStatusDiv.innerHTML = '';
        }

        return; // 局部更新结束
    }

    // [性能优化] 烹饪进度条刷新 (保持不变)
    const existingMachine = el.querySelector('.cook-machine');
    if (s.stage === 'COOKING' && existingMachine && existingMachine.classList.contains('active')) {
        const barFill = el.querySelector('.progress-bar-fill');
        if (barFill) barFill.style.width = s.progress + '%';
        return;
    }

    // 全量渲染逻辑
    el.className = 'station';
    
    let prepStatus = s.currentIngredients.length > 0 ? 'status-active' : '';
    let cookStatus = '';
    if (s.stage === 'COOKING') cookStatus = 'status-cooking';
    else if (s.stage === 'FINISHED') cookStatus = 'status-finished';

    // [核心修改] 移除 prepStyle 中的 opacity 设置
    const prepStyle = '';
    
    // [新增] 提前计算 Omni 状态，用于控制标题显示
    const isOmni = potName && potName.toLowerCase().includes('omni');

    el.innerHTML = `
        <div class="station-card cook-card ${cookStatus}">
            <div class="card-header">
                ${isOmni ? '' : '<span class="card-title">OUTPUT / 烹饪</span>'}
                <div style="display:flex; gap:5px; margin-left: auto;">
                    <button class="btn-trash-mini" style="background:rgba(52, 152, 219, 0.3);" title="切换设备: ${potName}" onclick="event.stopPropagation(); cycleStationEquipment('${sid}')">🔄</button>
                    <!-- [已移除] 垃圾桶按钮 -->
                </div>
            </div>
            <div class="station-cook-zone" onclick="event.stopPropagation(); handleStationClick('${sid}', event, 'cook')">
                <div class="cook-machine"></div>
                <div class="dish-status" style="font-size:12px; color:#999; margin-top:4px; font-weight:bold;">空闲</div>
                <div class="progress-bar-container" style="display:none;"><div class="progress-bar-fill"></div></div>
                <button class="clean-btn" style="display:none" onclick="event.stopPropagation(); cleanStation('${sid}')">🔧</button>
            </div>
        </div>

        <div class="station-card prep-card ${prepStatus}" style="${prepStyle}">
            <div class="card-header">
                <span class="card-title">INPUT / 备菜</span>
                <!-- [已移除] 备菜区清空按钮 -->
            </div>
            <div class="station-prep-zone" onclick="event.stopPropagation(); handleStationClick('${sid}', event, 'prep')">
                <div class="prep-status-text"></div>
                <div class="prep-bowl" style="position:relative;">
                     <div class="ing-list-prep"></div>
                    ${s.currentIngredients.length > 0
                        ? '<img src="assets/station/备菜砧板.png" alt="备菜砧板">'
                        : '<img src="assets/station/备菜盘.png" alt="备菜盘">'}
                </div>
                <div class="prep-action-container"></div>
            </div>
        </div>
    `;

    // 渲染食材图标 (保持不变)
    const ingList = el.querySelector('.ing-list-prep');
    if (ingList) {
        s.currentIngredients.forEach(ingId => {
            const span = document.createElement('span');
            span.className = 'ing-item-small';
            if(typeof INGREDIENTS !== 'undefined' && INGREDIENTS[ingId]) {
                span.innerText = INGREDIENTS[ingId].icon;
            }
            ingList.appendChild(span);
        });
    }

    // [核心修改] 全量渲染时的按钮逻辑：允许显示但禁用 
    const prepActionDiv = el.querySelector('.prep-action-container'); 
    const prepStatusDiv = el.querySelector('.prep-status-text'); 

    if (prepActionDiv && s.currentIngredients.length > 0) { 
        const analysis = analyzeDish(s.currentIngredients); 
        const labelColor = analysis ? analysis.color : '#999'; 
        const labelText = analysis ? analysis.name : '...'; 

        if (prepStatusDiv) { 
            prepStatusDiv.innerHTML = labelText; 
            prepStatusDiv.style.color = labelColor; 
        } 

        const btnDisabled = isBusy ? 'disabled style="background:#bdc3c7; cursor:not-allowed;"' : ''; 
        const btnText = isBusy ? '⏳ 等待空闲' : '🔥 开始烹饪'; 

        prepActionDiv.innerHTML = ` 
            <button class="move-btn" ${btnDisabled} onclick="event.stopPropagation(); this.disabled=true; startCooking('${sid}')"> 
                ${btnText} 
            </button> 
        `; 
    } else if (prepActionDiv) { 
        prepActionDiv.innerHTML = '<div style="height:36px;"></div>'; 
        if (prepStatusDiv) prepStatusDiv.innerHTML = ''; 
    } 

    // 渲染烹饪机器 (保持原有逻辑，省略重复代码...) 
    // ... 这里直接使用原有的 cookMachine 渲染代码 ... 
    const cookMachine = el.querySelector('.cook-machine');
    const status = el.querySelector('.dish-status');
    const barContainer = el.querySelector('.progress-bar-container');
    const barFill = el.querySelector('.progress-bar-fill');
    const cleanBtn = el.querySelector('.clean-btn');

    if (cookMachine) {
        cookMachine.className = 'cook-machine';
        if (s.isBroken || (s.maintenance && s.maintenance >= 10)) cookMachine.classList.add('maintenance');
        
        // --- [修改] 设备渲染逻辑 (安全分支模式) --- 
    let stoveHtml = ''; 
    
    // 1. 判断是否为 Omni 设备 (已在上文定义) 
    if (isOmni) { 
        // === Omni 专用分支 === 
        
        // 1. 文件名清洗："Omni 1.0" -> "Omni1.0" 
        const fileName = potName.replace(/\s+/g, ''); 
        
        // 2. 动态判定当前工位状态，分发后缀 
        let stateSuffix = '空闲'; // 默认状态 
        
        if (s.stage === 'COOKING') { 
            stateSuffix = '烹饪中'; 
        } else if (s.stage === 'FINISHED') { 
            // 状态是空闲，但上面有菜，说明是做好了等玩家收 
            stateSuffix = '出餐中'; 
        } 
        
        // 3. 渲染图片，带有双重回退机制 
        // 优先找: Omni1.0空闲.png / Omni1.0烹饪中.png / Omni1.0出餐中.png 
        // 找不到则回退找: Omni1.0.png (原版/商店图) 
        stoveHtml = ` 
            <img src="assets/equipment/${fileName}${stateSuffix}.png" 
                 class="omni-popout-bg" 
                 alt="${potName} ${stateSuffix}" 
                 onerror=" 
                    if (!this.getAttribute('data-fallback')) { 
                        this.setAttribute('data-fallback', 'true'); 
                        this.src='assets/equipment/${fileName}.png'; 
                    } else { 
                        this.src='assets/equipment/${potName}.png'; 
                        this.onerror=null; 
                    } 
                 "> 
        `; 
    } else { 
            // === 普通灶台逻辑 (完全保持原样，防止位移) === 
            const expansionLevel = game.inventory.expansion || 0; 
            const ngParams = JSON.parse(localStorage.getItem('ng_params') || '{}'); 
            const region = (ngParams.location || 'cn:main').split(':')[0]; 
            let suffix = '01'; 
            if (sid === 's2') suffix = '02'; 
            if (sid === 's3') suffix = '03'; 
            if (expansionLevel === 0) suffix = '01'; 
            if (expansionLevel === 1 && suffix === '03') suffix = '01'; 
            const stoveImageName = `stove_${region}_lv${expansionLevel}_${suffix}.png`; 
            
            // 注意：这里继续使用旧的 .stove-bg 类 
            stoveHtml = `<img src="assets/equipment/${stoveImageName}" class="stove-bg" alt="灶台">`; 
        }

        // 2. 根据状态组合 HTML
        if (s.stage === 'COOKING') {
            cookMachine.classList.add('active');
            
            // Omni 特殊处理：使用破框大图
            if (isOmni) {
                // Omni: stoveHtml 已包含大图，追加烹饪中的视觉（如有）
                cookMachine.innerHTML = `${stoveHtml}`;
            } else {
                // 普通: 正常显示
                cookMachine.innerHTML = `${stoveHtml}<img src="assets/equipment/${potName}.png" alt="Cooking" class="pot-main" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MCA1MCI+PHRleHQgeT0iNDAiIGZvbnQtc2l6ZT0iNDAiPvCfpZg8L3RleHQ+PC9zdmc+'">`;
            }
            
            status.innerText = '烹饪中...';
            status.style.color = '#e67e22';
            barContainer.style.display = 'block';
            barFill.style.width = s.progress + '%';
        } else if (s.stage === 'FINISHED') {
            cookMachine.classList.add('finished');
            const dishName = s.recipe ? s.recipe.name : 'unknown';
            const dishIcon = s.recipe ? s.recipe.icon : '✅';
            
            let badgeHtml = '';
            if (s.servingsLeft > 1) {
                badgeHtml = `<div style="position:absolute; top:25px; right:25px; background:#e74c3c; color:white; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:14px; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.3); z-index:10;">x${s.servingsLeft}</div>`;
            }

            // [核心修复] 生成菜品图标 (dishHtml) - Omni 出餐口特效优化
            const dishImg = (s.recipe && s.recipe.image) ? s.recipe.image : `assets/dishes/${dishName}.png`;
            
            // 基础样式：居中, 64px (覆盖 class 中的 45px)
            let dishStyle = 'width:64px; height:64px; object-fit:contain; pointer-events:auto; transition: all 0.2s ease-out;';
            
            // 如果是 Omni 设备，并且处于出餐阶段 (FINISHED = Idle with dish)
            if (isOmni && s.stage === 'FINISHED') {
                // 视觉模拟：调整为 98px
                // 位置下移：保持在出餐口托盘位置 (top: 80% + 78px)
                // 动效：上下浮动引导取餐
                dishStyle += `
                    width: 98px !important;
                    height: 98px !important;
                    top: calc(80% + 78px) !important;
                    filter: drop-shadow(0 6px 8px rgba(0,0,0,0.5));
                    animation: omni-dish-bounce 1.5s infinite ease-in-out;
                `;
            }

            const dishHtml = `
                <div style="position:absolute; width:100%; height:100%; top:0; left:0; z-index:100; pointer-events:none;">
                    <img src="${dishImg}" 
                         alt="${dishName}" 
                         class="station-dish-icon" 
                         style="${dishStyle}" 
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                    <span style="display:none; font-size:42px; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);">${dishIcon}</span>
                    ${badgeHtml}
                </div>
            `;
            
            // 组装：背景(stoveHtml) + 菜品层(dishHtml)
            // 注意：stoveHtml 里的 .omni-popout-bg 已经是 z-index:0，dishHtml 是 z-index:100
            cookMachine.innerHTML = `${stoveHtml}${dishHtml}`;
            
            // [UI微调] Omni 设备出餐阶段不显示文字
            if (isOmni) {
                status.innerText = '';
            } else {
                status.innerText = '点击取餐!';
            }
            status.style.color = '#2ecc71';
            barContainer.style.display = 'none';
        } else {
            // IDLE
            if (isOmni) {
                cookMachine.innerHTML = `${stoveHtml}`;
            } else {
                // [微调] 特殊锅具在空闲时下移+左移
                const shiftPots = ['基础铁锅', '专业不粘锅', '多段控温精钢锅'];
                const extraStyle = shiftPots.includes(potName) ? 'transform: translate(-6px, 16px);' : '';
                cookMachine.innerHTML = `${stoveHtml}<img src="assets/equipment/${potName}.png" alt="Idle" class="pot-main" style="${extraStyle}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MCA1MCI+PHRleHQgeT0iNDAiIGZvbnQtc2l6ZT0iNDAiPvCfpZg8L3RleHQ+PC9zdmc+'">`;
            }
            status.innerText = '空闲';
            status.style.color = '#ccc';
            barContainer.style.display = 'none';
        }
        
        // --- [新增] Omni 样式动态修正 ---
        const cookCard = el.querySelector('.station-card.cook-card');
        const cookZone = el.querySelector('.station-cook-zone');
        
        if (cookCard && cookZone) {
            if (isOmni) {
                // Omni 专用：背景全透明，移除边框和阴影
                cookCard.style.background = 'none';
                cookCard.style.boxShadow = 'none';
                cookCard.style.border = 'none';
                cookZone.style.background = 'none';
                cookZone.style.boxShadow = 'none';
                cookZone.style.border = 'none';
                
                // 移除“+”号提示 (用户要求不显示)
                const plus = cookZone.querySelector('.omni-plus-sign');
                if (plus) plus.remove();
            } else {
                // 普通灶台：恢复原有的卡片质感
                cookCard.style.background = '';
                cookCard.style.boxShadow = '';
                cookCard.style.border = '';
                cookZone.style.background = '';
                cookZone.style.boxShadow = '';
                cookZone.style.border = '';
                const plus = cookZone.querySelector('.omni-plus-sign');
                if (plus) plus.remove();
            }
        }
    } 
    
    if (cleanBtn && s.maintenance >= 8) { 
        cleanBtn.style.display = 'block'; 
        cleanBtn.innerText = s.maintenance >= 10 ? '🆘' : '🧽'; 
        cleanBtn.style.backgroundColor = s.maintenance >= 10 ? '#c0392b' : '#f39c12'; 
    } 
}

function initRealBusinessHUD() {
    const hudRow = document.getElementById('hud-row');
    
    // 1. 确保底部进度条可见
    const progContainer = document.getElementById('revenue-progress-container');
    if(progContainer) progContainer.style.display = 'block';

    // [修正] 不再通过 JS 动态覆盖 HTML，而是直接使用 index.html 中定义好的静态结构
    // 这样可以保留 3 行布局 (Time+Pass / Target / Revenue)
}

function updateHUD() {
    // 更新目标栏位：显示当前钱包余额 (如果用户想要的是钱包余额 vs 目标)
    // 根据需求：目标 (资金目标) -> 可能指 今日目标，也可能指 钱包余额 / 下一级目标
    // 假设需求是：钱包余额 / 目标
    const targetEl = document.getElementById('target-current');
    if(targetEl) targetEl.innerText = `¥${game.coins}`;
    
    // [新增] 更新目标金额 (防止被重置)
    const goalEl = document.getElementById('target-goal');
    if(goalEl) goalEl.innerText = `¥${game.targetRevenue}`;
    
    // 进度条逻辑
    const progress = Math.min(100, (game.coins / game.targetRevenue) * 100);
    const progBar = document.getElementById('revenue-progress-bar');
    if(progBar) {
        progBar.style.width = `${progress}%`;
        progBar.style.background = progress >= 80 ? '#2ecc71' : '#f1c40f';
    }

    // [核心修改] 动态更新天数文案
    const dayLabel = document.getElementById('hud-day-label');
    if(dayLabel) dayLabel.innerText = `DAY ${game.level} 营收`;

    // 更新今日营收数值
    document.getElementById('revenue').innerText = `¥${game.dailyRevenue}`;

    // 更新合格率
    const count = game.dailyDishCount || 0;
    const sum = game.dailyQualitySum || 0;
    const currentRate = count > 0 ? (sum / count * 100) : 0;
    document.getElementById('pass-rate').innerText = `${currentRate.toFixed(1)}%`;

    // 更新趋势
    const trendEl = document.getElementById('pass-trend');
    const yesterdayRate = window.yesterdayRate; // 确保获取全局变量或从 localStorage 读
    if (count > 0 && typeof yesterdayRate !== 'undefined') {
        trendEl.style.display = 'inline-flex';
        const diff = currentRate - yesterdayRate;
        const isUp = diff >= 0;
        trendEl.className = `trend-box ${isUp ? 'trend-up' : 'trend-down'}`;
        trendEl.querySelector('.trend-icon').innerText = isUp ? '▲' : '▼';
        trendEl.querySelector('.trend-val').innerText = `${Math.abs(diff).toFixed(1)}%`;
    } else {
        trendEl.style.display = 'none';
    }

    updateBalanceDisplay();
}

function updateBalanceDisplay() {
    const shopBalance = document.getElementById('shop-balance');
    const homeBalance = document.getElementById('home-balance');
    if (shopBalance) shopBalance.innerText = `¥${game.coins}`;
    if (homeBalance) homeBalance.innerText = `¥${game.coins}`;
}

function switchScreen(screenId) {
    console.log(`[UI] Switching to: ${screenId}`);

    // [新增] 统一管理 Game UI 容器显示状态
    const gameUI = document.getElementById('game-ui');
    if (gameUI) {
        // 只有在进入正式游戏容器时才显示 game-ui
        if (screenId === 'game-container') {
            gameUI.style.display = 'block';
        } else {
            gameUI.style.display = 'none';
        }
    }

    // [修复] 切换屏幕时隐藏全局垃圾桶
    const trashCard = document.getElementById('global-trash-card');
    if (trashCard) {
        if (screenId === 'game-container') {
            trashCard.style.display = 'flex';
        } else {
            trashCard.style.display = 'none';
        }
    }
    
    stopShopMusic(); // [新增] 切屏时停止商店音乐
    
    // [核心修复] 切换界面时，强制清空手持物品
    if (typeof resetHand === 'function') resetHand();
    
    // 1. 获取关键元素
    const container = document.getElementById('game-container');
    const startScreen = document.getElementById('start-screen');
    const playArea = document.getElementById('play-area');
    const hud = document.getElementById('hud');
    const belt = document.getElementById('belt-container');

    // 2. 确保主容器始终显示
    if (container) container.style.display = 'flex';

    // 3. 定义所有互斥的界面层级
    const overlays = ['shop-overlay', 'overlay', 'pause-overlay', 'map-screen', 'loading', 'achievement-modal', 'settings-modal', 'end-game-modal', 'prep-modal'];

    // 4. 先隐藏所有悬浮层
    overlays.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });

    // 5. 根据目标 ID 处理显示逻辑
    if (screenId === 'start-screen') {
        // --- 首页模式 ---
        if (startScreen) startScreen.style.display = 'flex';
        if (playArea) playArea.style.display = 'none';
        if (hud) hud.style.display = 'none';
        if (belt) belt.style.display = 'none';
        
        uiState = 'HOME';
        // stopMusic(); // [Fixed] Removed to allow seamless transition (AudioController handles mutex)
        startMusic();
    } else if (screenId === 'game-container') {
        // --- 游戏模式 ---
        if (startScreen) startScreen.style.display = 'none';
        if (playArea) playArea.style.display = 'grid';
        if (hud) hud.style.display = 'flex';
        if (belt) belt.style.display = 'flex';
        
        uiState = 'GAME';
    } else {
        // --- 通用弹窗模式 (如 map-screen) ---
        // 如果目标是一个覆盖层，直接显示它
        const targetEl = document.getElementById(screenId);
        if (targetEl) {
            targetEl.style.display = 'flex';
            
            // 地图页属于首页分支，隐藏游戏元素，保留背景
            if (screenId === 'map-screen') {
                if (startScreen) startScreen.style.display = 'none';
                if (playArea) playArea.style.display = 'none';
                if (hud) hud.style.display = 'none';
                // [Fix] Ensure theme music continues playing
                AudioController.playTheme();
            }
        }
    }
}

function analyzeDish(ingredients) {
    if (!ingredients || ingredients.length === 0) return null;

    // 4. 修复及格率判定公式 (Fix Quality Logic)
    
    // Step 1: Identify the dish based on Main Ingredient (Any required ingredient present)
    // We iterate through all recipes and count how many of their ingredients are in the pot.
    let bestMatch = null;
    let bestMatchCount = 0;
    
    for (const recipe of RECIPES) {
        // Count how many of this recipe's ingredients are in the pot
        const matchCount = recipe.ingredients.filter(id => ingredients.includes(id)).length;
        if (matchCount > 0 && matchCount > bestMatchCount) {
            bestMatchCount = matchCount;
            bestMatch = recipe;
        }
    }
    
    if (!bestMatch) {
        return {
            name: "黑暗料理",
            quality: 0.1,
            label: "无法识别 (10%)",
            color: "#7f8c8d",
            icon: "🤢",
            price: 0,
            hasStock: false
        };
    }
    
    const targetRecipe = bestMatch;
    
    // Step 2: Calculate Quality
    
    // Check 1: Wrong Ingredients (Contamination) -> 10%
    // If pot contains anything NOT in the recipe -> 10%
    const hasWrongIngredient = ingredients.some(id => !targetRecipe.ingredients.includes(id));
    
    if (hasWrongIngredient) {
         return {
            name: targetRecipe.name, // Still identified as this dish but ruined
            recipe: targetRecipe,
            quality: 0.1,
            label: "投错料 (10%)",
            color: "#7f8c8d",
            icon: targetRecipe.icon,
            price: targetRecipe.price,
            hasStock: false
        };
    }
    
    // Check 2: Missing Ingredients (Incomplete) -> 40%
    const hasAllRequired = targetRecipe.ingredients.every(id => ingredients.includes(id));
    
    if (!hasAllRequired) {
        return {
            name: targetRecipe.name,
            recipe: targetRecipe,
            quality: 0.4,
            label: "缺辅料 (40%)",
            color: "#e74c3c",
            icon: targetRecipe.icon,
            price: targetRecipe.price,
            hasStock: false
        };
    }
    
    // Check 3: Ratio (Assuming 1:1 for now)
    // If we have all required, and no wrong ingredients, check counts.
    // Since we filtered out "Wrong Ingredients" above, we only have valid ingredients here.
    // We just need to check if counts match recipe requirements (usually 1 each).
    // The user prompt says "Perfect Ratio (1:1) -> 100%".
    // If I have 2 tomatoes and 1 egg for Tomato Egg, implies ratio off?
    // Let's check counts.
    
    const counts = {};
    ingredients.forEach(id => counts[id] = (counts[id] || 0) + 1);
    
    let isRatioPerfect = true;
    for (const id of targetRecipe.ingredients) {
        // Assume recipe needs 1 of each for now (Standard logic)
        if (counts[id] !== 1) {
            isRatioPerfect = false;
        }
    }
    
    if (isRatioPerfect) {
        return {
            name: targetRecipe.name,
            recipe: targetRecipe,
            quality: 1.0,
            label: "完美 (100%)",
            color: "#f1c40f",
            icon: targetRecipe.icon,
            price: targetRecipe.price,
            hasStock: true
        };
    } else {
        // Ratio deviation but has all types?
        // User prompt didn't explicitly say what to do here, but implied "Perfect Ratio -> 100%".
        // If ratio is off (e.g. 2:1), maybe fallback to a lower score or standard deviation logic.
        // I'll use 80% for "Ratio Deviation" to distinguish from "Missing (40%)".
        return {
            name: targetRecipe.name,
            recipe: targetRecipe,
            quality: 0.8,
            label: "比例偏差 (80%)",
            color: "#e67e22",
            icon: targetRecipe.icon,
            price: targetRecipe.price,
            hasStock: true
        };
    }
}

// [新增] 全局状态 
let pantryLayer = 1; 
// [修改] 改为 12 (3列 x 4行) 
const ITEMS_PER_LAYER = 12;

// 切换抽屉开关 
// [交互] 切换抽屉状态 (带音效) 
window.togglePantry = function() { 
    const drawer = document.getElementById('pantry-drawer'); 
    if (!drawer) return; 
    
    if (drawer.classList.contains('closed')) { 
        // 打开 
        drawer.classList.remove('closed'); 
        drawer.classList.add('open'); 
        // [新增] 恢复旧版食材柜音效 (220-150Hz 下降音) -> 改为清脆声 (600Hz Triangle, Vol 0.3)
        playSfx(600, 'triangle', 0.2, 0.3); // slide open sound approximation 
    } else { 
        // 关闭 
        drawer.classList.remove('open'); 
        drawer.classList.add('closed'); 
        // [新增] 恢复旧版关闭音效 (150Hz 短促) -> 改为清脆声 (500Hz Square, Vol 0.2)
        playSfx(500, 'square', 0.1, 0.2); // click close sound approximation 
    } 
};

// 翻页逻辑 
window.changePantryLayer = function(delta) { 
    const currentLevel = game.level;
    const allowedIngIds = new Set();
    let unlockedRecipes = [];
    if (currentLevel >= 1) unlockedRecipes.push(...RECIPES.slice(0, 2));
    if (currentLevel >= 3) unlockedRecipes.push(...RECIPES.slice(2, 6));
    if (currentLevel >= 6) unlockedRecipes.push(...RECIPES.slice(6, 9));
    if (currentLevel >= 9) unlockedRecipes.push(...RECIPES.slice(9, 12));
    unlockedRecipes.forEach(r => r.ingredients.forEach(i => allowedIngIds.add(i)));
    if (currentLevel === 1) ['tomato', 'egg', 'onion'].forEach(id => allowedIngIds.add(id));
    
    const allItems = Object.values(INGREDIENTS).filter(ing => allowedIngIds.has(ing.id));
    const maxLayers = Math.ceil(allItems.length / ITEMS_PER_LAYER) || 1; 
    
    let newLayer = pantryLayer + delta; 
    if (newLayer < 1) newLayer = 1; 
    if (newLayer > maxLayers) newLayer = maxLayers; 
    
    if (newLayer !== pantryLayer) { 
        pantryLayer = newLayer; 
        updateInventoryDisplay(); 
        playSfx(400, 'triangle', 0.1, 0.2); // Page flip sound
    } 
};

function updateInventoryDisplay() { 
    const grid = document.getElementById('ingredient-grid'); 
    if (!grid) return; 
    grid.innerHTML = ''; 
    
    const currentLevel = game.level; 
    const allowedIngIds = new Set(); 
    let unlockedRecipes = []; 
    if (currentLevel >= 1) unlockedRecipes.push(...RECIPES.slice(0, 2)); 
    if (currentLevel >= 3) unlockedRecipes.push(...RECIPES.slice(2, 6)); 
    if (currentLevel >= 6) unlockedRecipes.push(...RECIPES.slice(6, 9)); 
    if (currentLevel >= 9) unlockedRecipes.push(...RECIPES.slice(9, 12)); 
    unlockedRecipes.forEach(r => r.ingredients.forEach(i => allowedIngIds.add(i))); 
    if (currentLevel === 1) ['tomato', 'egg', 'onion'].forEach(id => allowedIngIds.add(id)); 
    
    const allItems = Object.values(INGREDIENTS).filter(ing => allowedIngIds.has(ing.id));
    
    // 分页计算
    const totalLayers = Math.ceil(allItems.length / ITEMS_PER_LAYER) || 1;
    if (pantryLayer > totalLayers) pantryLayer = totalLayers;
    
    const start = (pantryLayer - 1) * ITEMS_PER_LAYER; 
    const end = start + ITEMS_PER_LAYER; 
    const currentItems = allItems.slice(start, end); 
    
    // 更新页码显示
    const layerIndicator = document.getElementById('pantry-layer-indicator'); 
    if(layerIndicator) layerIndicator.innerText = `${pantryLayer}/${totalLayers}`; 
    
    // 渲染固定 16 个格子
    for (let i = 0; i < ITEMS_PER_LAYER; i++) {
        const div = document.createElement('div');
        div.className = 'ingredient-item';
        
        if (i < currentItems.length) {
            const ing = currentItems[i];
            const isDayOne = currentLevel === 1;
            const stock = (game.dailyInventory && game.dailyInventory[ing.id] !== undefined) ? game.dailyInventory[ing.id] : 0;
            let stockDisplay = stock;
            let stockColor = stock > 0 ? '#fff' : '#e74c3c'; // 白色文字在深色标签上
            if (isDayOne) {
                stockDisplay = '∞';
                stockColor = '#2ecc71';
            }
            
            div.innerHTML = `
                <span class="ing-icon">${ing.icon}</span>
                <span class="ing-name" style="font-size:12px; margin-top:4px; color:#ecf0f1; font-weight:bold; text-shadow:none;">${ing.name}</span>
                <span class="ingredient-count" style="${isDayOne ? 'background:#2ecc71;' : ''}">${stockDisplay}</span>
            `;
            
            div.onclick = (e) => {
                e.stopPropagation();
                handleIngredientClick(e, ing);
                // [注意] 这里移除了 togglePantry()，保持抽屉打开
            };
            
            if (!isDayOne && stock <= 0) {
                div.style.opacity = '0.6';
            }
        } else {
            // 空格子占位
            div.style.opacity = '0.3';
            div.style.cursor = 'default';
        }
        grid.appendChild(div);
    }
}
 
const initIngredients = updateInventoryDisplay;

function handleIngredientClick(e, ing) {
    if (game.isTrashMode) {
        if(typeof showToast === 'function') showToast("丢弃模式下无法拿取食材");
        return;
    }
    
    // [修改] 移除了自动收起抽屉的逻辑
    // const drawer = document.getElementById('pantry-drawer');
    // if (drawer && drawer.classList.contains('open')) {
    //    togglePantry();
    // }

    // Allow picking up even if stock is 0
    // if (ing.stock <= 0) return;
    
    if (holdingThing && holdingThing.type === 'INGREDIENT' && holdingThing.val.id === ing.id) {
        holdingThing = null;
        updateCursor();
        return;
    }
    
    holdingThing = { type: 'INGREDIENT', val: ing };
    updateCursor();
    playSfx(400, 'sine', 0.1);
}

function updateCursor() {
    const cursor = document.getElementById('drag-cursor');
    if (!cursor) return;
    
    const tickets = document.querySelectorAll('.order-ticket');
    tickets.forEach(t => t.classList.remove('match-highlight'));

    if (holdingThing) {
        document.body.style.cursor = 'default'; // [新增] 恢复默认光标
        if (cursor.style.display !== 'block') cursor.style.display = 'block';

        let newHTML = '';
        const currentId = cursor.getAttribute('data-holding-id');
        const newId = holdingThing.type + '-' + (holdingThing.val.name || holdingThing.val.id);

        if (currentId !== newId) {
            if (holdingThing.type === 'INGREDIENT') {
                newHTML = `<span style="font-size:40px;">${holdingThing.val.icon}</span>`;
            } else if (holdingThing.type === 'DISH') {
                const dishName = holdingThing.val.name;
                const dishIcon = holdingThing.val.icon || '🥘';
                newHTML = `
                    <img src="assets/dishes/${dishName}.png" alt="${dishName}" 
                         style="width:60px; height:60px; object-fit:contain; display:block;"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                    <span style="display:none; font-size:40px;">${dishIcon}</span>
                `;
            }
            cursor.innerHTML = newHTML;
            cursor.setAttribute('data-holding-id', newId);
        }

        if (holdingThing.type === 'DISH') {
            game.activeOrders.forEach(order => {
                if (order.dishes.some(d => (d.name||d.n) === holdingThing.val.name)) {
                    if (order.dom) order.dom.classList.add('match-highlight');
                }
            });
        }
    } else if (game.isTrashMode) {
        // [新增] 清洁模式显示扫把
        document.body.style.cursor = 'none'; // [新增] 隐藏系统光标
        if (cursor.style.display !== 'block') cursor.style.display = 'block';
        const currentId = cursor.getAttribute('data-holding-id');
        if (currentId !== 'trash-broom') {
            cursor.innerHTML = '<span style="font-size:80px;">🧹</span>';
            cursor.setAttribute('data-holding-id', 'trash-broom');
        }
    } else {
        document.body.style.cursor = 'default'; // [新增] 恢复默认光标
        if (cursor.style.display !== 'none') cursor.style.display = 'none';
        cursor.removeAttribute('data-holding-id');
    }
}

window.addEventListener('mousemove', (e) => {
    const cursor = document.getElementById('drag-cursor');
    if (cursor && cursor.style.display !== 'none') {
        cursor.style.transform = `translate(${e.clientX}px, ${e.clientY}px) translate(-50%, -50%)`;
    }
});

// [新增] 触屏拖拽支持
window.addEventListener('touchmove', (e) => {
    const cursor = document.getElementById('drag-cursor');
    if (cursor && cursor.style.display !== 'none' && e.touches.length > 0) {
        // 阻止默认滚动，防止画面抖动
        if (e.cancelable) e.preventDefault();
        
        const touch = e.touches[0];
        // 移动光标
        cursor.style.transform = `translate3d(${touch.clientX}px, ${touch.clientY}px, 0) translate(-50%, -50%)`;
    }
}, { passive: false }); // 必须设为 false 才能 preventDefault

function initOrderSlots() {
    const belt = document.getElementById('belt-container');
    if (!belt) return;
    
    // 1. 获取当前配置
    const expLvl = (game.inventory && game.inventory.expansion) ? game.inventory.expansion : 0;
    const config = SHOP_CONFIG.expansion.levels[expLvl];
    const unlockedSlots = config.slots; // 2, 3, or 5
    
    // 2. 清空并重置容器
    belt.innerHTML = '';
    
    // 重置数据结构 (保持5个长度防止逻辑越界，但只使用前 unlockedSlots 个)
    if (!game.orderSlots || game.orderSlots.length !== 5) {
        game.orderSlots = [null, null, null, null, null];
        game.slotCooldowns = [0, 0, 0, 0, 0];
    }
    
    // 3. [核心修改] 只循环渲染已解锁的槽位
    for (let i = 0; i < unlockedSlots; i++) {
        const slot = document.createElement('div');
        slot.id = 'order-slot-' + i;
        slot.className = 'order-slot';
        // 如果有现存的订单DOM（例如刚升级完刷新），尝试恢复它（可选优化）
        // 这里简单处理：生成空槽位，等待下一次渲染或生成
        
        // 调试显示编号 (可选)
        // slot.innerText = i + 1;
        // slot.style.color = 'rgba(255,255,255,0.1)';
        // slot.style.fontSize = '20px';
        // slot.style.fontWeight = 'bold';
        // slot.style.alignItems = 'center';
        
        belt.appendChild(slot);
    }
    
    // 锁定槽位不再渲染，背景容器会因为 width: fit-content 自动收缩
}

function initStations() {
    const kitchen = document.getElementById('kitchen-area');
    if (!kitchen) return;
    kitchen.innerHTML = '';
    
    // 获取当前解锁数量 (1, 2, 或 3)
    const expLvl = (game.inventory && game.inventory.expansion) ? game.inventory.expansion : 0;
    
    // [核心修改] 根据装修等级添加 CSS 类名，用于隔离样式
    kitchen.classList.remove('kitchen-lv0', 'kitchen-lv1', 'kitchen-lv2');
    kitchen.classList.add('kitchen-lv' + expLvl);

    // 安全获取配置，防止报错
    const unlockedCount = (SHOP_CONFIG && SHOP_CONFIG.expansion) ? SHOP_CONFIG.expansion.levels[expLvl].stations : 1;

    // [核心修改] 定义物理位置映射：[左侧位, 中间位, 右侧位]
    // id: 对应的灶台ID
    // req: 需要解锁到的数量才显示 (例如 req:2 表示只有解锁了2个灶台时，s2才会变成真灶台)
    const layoutMap = [
        { id: 's2', req: 2 }, // 左侧放 s2
        { id: 's1', req: 1 }, // 中间放 s1 (永远显示，因为最少解锁1个)
        { id: 's3', req: 3 }  // 右侧放 s3
    ];

    layoutMap.forEach(slot => {
        // 判断该位置是否已解锁
        const isUnlocked = unlockedCount >= slot.req;
        
        if (isUnlocked) {
            // --- 渲染真实工位 ---
            const sid = slot.id;
            
            // 初始化数据状态 (保持不变)
            if (!stations[sid]) {
                stations[sid] = { 
                    id: sid, 
                    stage: 'IDLE', 
                    currentIngredients: [], 
                    recipe: null, 
                    progress: 0, 
                    maintenance: 0,
                    // [新增] 默认装备当前拥有的最高级锅，但允许独立修改
                    equipLevel: (game.inventory && game.inventory.pot) ? game.inventory.pot : 0
                };
            }
            
            // 清理旧定时器/音频
            if (stations[sid].audio) { stations[sid].audio.pause(); stations[sid].audio = null; }
            if (stations[sid].timer) { clearInterval(stations[sid].timer); stations[sid].timer = null; }
            
            // 重置状态
            stations[sid].currentIngredients = [];
            stations[sid].stage = 'IDLE';
            stations[sid].recipe = null;
            stations[sid].isBroken = false;

            const el = document.createElement('div');
            el.id = 's_' + sid;
            el.className = 'station';
            
            // 渲染工位 HTML (由 renderStation 接管)
            el.innerHTML = '';
            kitchen.appendChild(el);
            renderStation(sid); // 立即渲染初始状态
        } else {
            // --- 渲染隐形占位符 (撑开布局) ---
            const placeholder = document.createElement('div');
            placeholder.className = 'station station-placeholder';
            // 保持与正常 station 一样的尺寸和间距，但完全不可见
            placeholder.style.visibility = 'hidden';
            placeholder.style.pointerEvents = 'none';
            kitchen.appendChild(placeholder);
        }
    });
}

// === 新增：清洁模式控制 ===
game.isTrashMode = false;
function toggleTrashMode() {
    // [新增] 优先处理手持物品丢弃
    if (holdingThing) {
        holdingThing = null;
        updateCursor();
        if(typeof playSfx === 'function') playSfx(100, 'sawtooth', 0.2);
        
        const btn = document.getElementById('global-trash-card');
        if (btn) {
            const rect = btn.getBoundingClientRect();
            triggerFeedback(rect.left + rect.width/2, rect.top, "已丢弃", "#999");
        }
        return;
    }

    game.isTrashMode = !game.isTrashMode;
    const btn = document.getElementById('global-trash-card');
    const label = btn ? btn.querySelector('.global-trash-label') : null;
    
    if (btn) {
        if (game.isTrashMode) {
            btn.classList.add('active');
            if (label) label.innerText = "请选目标";
            if (typeof playSfx === 'function') playSfx(400, 'triangle', 0.1);
            
            // [修改] 仅在第一次使用时显示提示
            const hasSeenTip = localStorage.getItem('hasSeenTrashTip');
            if (!hasSeenTip) {
                if (typeof showToast === 'function') showToast("请点击 备菜区 或 烹饪区 进行丢弃");
                localStorage.setItem('hasSeenTrashTip', 'true');
            }
        } else {
            btn.classList.remove('active');
            if (label) label.innerText = "丢弃";
        }
    }
    updateCursor(); // [新增] 更新光标状态(显示/隐藏扫把)
}

function handleStationClick(sid, event, zone) {
    // === 新增：清洁模式拦截 ===
    if (game.isTrashMode) {
        if (zone === 'prep') {
            trashStation(sid, 'prep');
        } else {
            // 点击烹饪区或整体 -> 倒掉菜品
            trashStation(sid, 'cook');
        }
        toggleTrashMode(); // 操作完自动退出模式
        return;
    }

    if (game.isPaused) return;
    const s = stations[sid];

    // 逻辑 1: 放置食材 (备菜区)
    // 如果点击的是备菜区，或者点击的是整个工位且手里拿着食材
    if (zone === 'prep' || (!zone && holdingThing?.type === 'INGREDIENT')) {
        if (holdingThing && holdingThing.type === 'INGREDIENT') {
            // [核心修改] 移除“工位忙碌”拦截，允许在烹饪时备菜
            // 原来的 if (s.stage === 'COOKING' || s.stage === 'FINISHED') ... 已删除
            
            // [修改] 实时扣除库存 
            const ingId = holdingThing.val.id; 
            if (game.dailyInventory) { 
                // Day 1 特权：无限库存，不检查也不扣除 
                if (game.level !== 1) { 
                    if (game.dailyInventory[ingId] <= 0) { 
                         triggerFeedback(event.clientX, event.clientY, "库存不足!", "red"); 
                         return; 
                    } 
                    game.dailyInventory[ingId]--; 
                    // 如果有顶栏显示库存的UI，这里需要刷新 
                    if(typeof initIngredients === 'function') initIngredients(); 
                } 
            }

            s.currentIngredients.push(ingId);
            
            // [核心修改] 仅当工位空闲时才改变状态，防止打断 COOKING 状态
            if (s.stage === 'IDLE') {
                s.stage = 'PREP_ING';
            }
            
            playSfx(200, 'sine', 0.1);
            renderStation(sid, 'prep');
            
            // [核心修复] 投放完成后，立即清空鼠标手持状态
            resetHand();
            return;
        }
    }

    // 逻辑 2: 取菜 / 交换菜品 (烹饪区)
    // 如果点击的是烹饪区，或者点击的是整个工位且判定不是放食材
    if (zone === 'cook' || !zone) {
        if (s.stage === 'FINISHED') {
            
            // [核心修复] 交换逻辑：如果手里已经有菜，先尝试把手里的菜退回原工位
            if (holdingThing && holdingThing.type === 'DISH') {
                const oldDish = holdingThing;
                const oldSid = oldDish.sourceSid;
                
                // 检查原工位是否存在且空闲
                if (oldSid && stations[oldSid]) {
                    const oldStation = stations[oldSid];
                    
                    if (oldStation.stage === 'IDLE') {
                        // 执行归位
                        oldStation.stage = 'FINISHED';
                        oldStation.dishResult = oldDish.val;
                        oldStation.recipe = oldDish.val; // 恢复数据
                        renderStation(oldSid); // 刷新原工位视觉
                        
                        // 视觉反馈
                        const rect = event.target.getBoundingClientRect();
                        triggerFeedback(rect.left, rect.top - 50, "🔄 菜品已归位", "#3498db");
                    } else {
                        // 如果原工位莫名其妙被占了（极少见），阻止操作以防吞卡
                        triggerFeedback(event.clientX, event.clientY, "原工位已满，无法交换!", "red");
                        return;
                    }
                }
            }

            // 拿起当前工位的新菜
            holdingThing = { type: 'DISH', val: s.dishResult || s.recipe, sourceSid: sid };
            
            // [核心修改] 批量出餐逻辑
            if (s.servingsLeft > 1) {
                // 还有库存：扣减一份，保留 FINISHED 状态
                s.servingsLeft--;
                playSfx(1000, 'sine', 0.2); // 取餐音效
                
                // 视觉反馈：飘字提示剩余
                const rect = event.target.getBoundingClientRect();
                triggerFeedback(rect.left + rect.width/2, rect.top, `剩余 ${s.servingsLeft} 份`, "#2ecc71");
                
                // 仅刷新显示，不重置
                renderStation(sid);
            } else {
                // --- [核心修复] 取走最后一份菜 --- 
                
                // 1. 判断备菜区是否有食材 
                if (s.currentIngredients.length > 0) { 
                    s.stage = 'PREP_ING'; // 如果有备菜，转为备菜状态 
                } else { 
                    s.stage = 'IDLE'; // 如果没备菜，转为空闲 
                } 
                
                // 2. [关键] 绝对不要清空 s.currentIngredients !!! 
                // s.currentIngredients = []; // <--- 已删除此行 
                
                // 3. 重置烹饪相关数据 
                s.dishResult = null; 
                s.recipe = null; 
                s.progress = 0; 
                s.servingsLeft = 0; 
                
                if (s.timer) clearInterval(s.timer);
                playSfx(1000, 'sine', 0.2);
                renderStation(sid);
            }
            
            updateCursor();
            return;
        }
    }
}

function startCooking(sid) {
    // [修复] 开始烹饪时，强制清空鼠标上的物品 
    if (holdingThing) resetHand(); 

    const s = stations[sid];
    if (s.stage === 'COOKING') return; // Prevent double trigger
    
    // Finalize Dish Analysis
    const analysis = analyzeDish(s.currentIngredients);
    s.dishResult = analysis; 
    s.recipe = analysis.recipe || { name: analysis.name, icon: analysis.icon, price: analysis.price };

    // [库存扣除逻辑已移除] - 现改为在放入食材时实时扣除 (handleStationClick)

    // [新增] 获取当前锅具配置
    // const potLevel = (game.inventory && game.inventory.pot) ? game.inventory.pot : 0;
    // [修改] 使用工位独立配置
    const currentPotLevel = (s.equipLevel !== undefined) ? s.equipLevel : 0;
    const potConfig = SHOP_CONFIG.pot.levels[currentPotLevel] || SHOP_CONFIG.pot.levels[0];

    s.stage = 'COOKING';
    s.currentIngredients = []; 
    s.progress = 0;
    
    // [新增] 初始化剩余份数，默认为 1
    s.servingsLeft = potConfig.yield || 1;
    
    // Maintenance Speed
    // [修改] 利用新的 effect 定义，effect 越大越快
    let speed = 2 * (1 + (potConfig.effect || 0));
    if (s.maintenance >= 10) {
        s.isBroken = true;
        speed = 0.5; // Slow down
    }
    
    if (s.timer) clearInterval(s.timer);
    
    // [新增] 播放炒菜音效
    if (typeof Audio !== 'undefined') {
        if (s.audio) { s.audio.pause(); s.audio = null; }
        s.audio = new Audio('audio/炒菜音效.mp3');
        s.audio.loop = true; 
        s.audio.volume = 0.5;
        s.audio.play().catch(e => console.log('Cooking audio play failed:', e));
    }

    s.timer = setInterval(() => {
        if (game.isPaused) {
            if (s.audio && !s.audio.paused) s.audio.pause();
            return;
        }
        
        // 恢复播放
        if (s.audio && s.audio.paused && s.stage === 'COOKING') {
            s.audio.play().catch(e => {});
        }

        s.progress += speed; 
        if (s.progress >= 100) {
            clearInterval(s.timer);
            s.stage = 'FINISHED';
            
            // [新增] 停止音效
            if (s.audio) {
                s.audio.pause();
                s.audio = null;
            }

            s.maintenance++; // Add wear
            // [新增] 播放出餐音效
            const finishAudio = new Audio('audio/出餐音效.mp3');
            finishAudio.volume = 0.6;
            finishAudio.play().catch(e => console.warn('Finish cooking SFX failed:', e));
            renderStation(sid);
        }
        renderStation(sid);
    }, 100);
    renderStation(sid);
}

function trashStation(sid, type = 'all', withSound = true, isPenalty = true) {
    // Handle old signature: (sid, withSound, isPenalty)
    if (typeof type === 'boolean') {
        isPenalty = (typeof withSound !== 'undefined') ? withSound : true;
        withSound = type;
        type = 'all';
    }

    const s = stations[sid];
    
    // 1. Clear Prep (Ingredients)
    if (type === 'prep' || type === 'all') {
        // Penalty logic: Only applies when discarding ingredients
        if (isPenalty && s.currentIngredients.length > 0) {
            let cost = 0;
            s.currentIngredients.forEach(ingId => {
                 if (INGREDIENTS[ingId]) cost += (INGREDIENTS[ingId].price || 5);
            });
            const penalty = Math.ceil(cost * 0.2);
            if (penalty > 0) {
                game.coins = Math.max(0, game.coins - penalty);
                // Show feedback: try new mini button first, then fallback
                const btn = document.querySelector(`#s_${sid} .prep-card .btn-trash-mini`) || document.querySelector(`#s_${sid} .btn-trash`);
                if (btn) {
                    const rect = btn.getBoundingClientRect();
                     triggerFeedback(rect.left, rect.top, `-${penalty} (浪费)`, "red");
                }
                updateBalanceDisplay();
            }
        }
        s.currentIngredients = [];
        // If stage was PREP_ING, reset to IDLE. If COOKING, don't touch stage unless type is all/cook
        if (s.stage === 'PREP_ING') s.stage = 'IDLE';
    }

    // 2. Clear Cook (Progress/Machine)
    if (type === 'cook' || type === 'all') {
        if (s.stage === 'COOKING' || s.stage === 'FINISHED') {
             s.stage = 'IDLE';
             s.recipe = null;
             s.progress = 0;
             if (s.timer) clearInterval(s.timer);
             // [新增] 停止音效
             if (s.audio) {
                 s.audio.pause();
                 s.audio = null;
             }
        }
    }

    renderStation(sid, type === 'prep' ? 'prep' : 'full');
    if (withSound) {
        // [修改] 播放倒垃圾音效
        const trashAudio = new Audio('audio/倒垃圾.mp3');
        trashAudio.volume = 0.6;
        trashAudio.play().catch(e => console.warn('Trash SFX failed:', e));
    }
}

function cleanStation(sid) {
    const s = stations[sid];
    s.maintenance = 0;
    s.isBroken = false;
    playSfx(300, 'noise', 0.5);
    renderStation(sid);
}

function startPreOpening() {
    // 1. 拦截开始逻辑：禁止立即 initLevel，直接调用 showPrepModal
    showPrepModal();
}

/* [新增] Loading 界面逻辑 */
const LOADING_CAROUSEL_IMAGES = [
    'assets/equipment/kitchen_cn_lv0.png',
    'assets/equipment/kitchen_cn_lv1.png',
    'assets/equipment/kitchen_cn_lv2.png',
    'assets/equipment/多段控温精钢锅.png',
    'assets/equipment/Omni1.0.png',
    'assets/equipment/Omni2.0.png',
    'assets/equipment/Omni3.0.png'
];
const LOADING_TIPS_TEXTS = [ 
    "🔥 Omni 智能设备可以自动识别食材并选择最佳烹饪方式！", 
    "🗑️ 垃圾桶不仅能清理变质菜品，还能丢弃手持的错误食材。", 
    "💰 每天的“热门菜品”会根据市场趋势变化，记得查看今日情报！", 
    "⏲️ 升级“极速处理”科技可以大幅减少备菜时间。", 
    "🧹 保持厨房整洁，尽量不要造成食材浪费。", 
    "📈 连续完成订单可以触发“火热时刻”，获得双倍收益！", 
    "🍳 完美的烹饪时机是获得五星好评的关键。", 
    "🛒 每天清晨集市会有新鲜食材，记得早起抢购！", 
    "🏪 扩展分店可以解锁更多菜谱。", 
    "🥘 某些特殊菜品需要特定的厨具才能制作，请留意设备要求。", 
    "🎵 可以在设置中调整音效和背景音乐。", 
    "📅 记得每天结算后查看经营报表，优化你的经营策略。", 
    "🐟 海鲜类食材保鲜期较短，建议优先使用。", 
    "🌶️ 辣味菜品在冬季更受欢迎，夏季则推荐清爽凉菜。", 
    "🧂 适量添加调味料可以提升菜品品质，但不要过量哦！", 
    "🤝 雇佣帮手可以自动完成部分简单的工作。", 
    "📦 食材库空间有限，合理规划库存至关重要。", 
    "✨ 传说中的“神级厨具”隐藏在某个神秘的地方...", 
    "Omni 1.0 出餐居然这么快，不愧是爷爷当年的得力帮手！", 
    "Omni 2.0 炒出来的菜好像更香，听说核心温控技术升级了。", 
    "什么时候让食客能体验到 Omni 3.0 的神奇风味呢？努力赚钱吧！", 
    "自从扩容后厨后，感觉装修风格也变得更气派了。", 
    "备菜区的食材一定要保持新鲜，这是我们店的老规矩。", 
    "不知道集市上的道明叔今天又进了什么好肉。", 
    "左伊姐的杂货铺总能发现一些提味的小惊喜。", 
    "听说 Omni 系列研发的初衷，就是为了完美还原大厨的“锅气”。", 
    "忙不过来的时候，记得看看有没有闲置的 Omni 设备能帮忙。", 
    "每一道新菜品解锁成功，离重振老店招牌就更近了一步。", 
    "即使是最基础的番茄炒蛋，用不同的设备做出来口感也会有微妙不同。", 
    "看着后厨从空荡荡变得满满当当，真有成就感啊。", 
    "有时候在集市多和街坊邻居聊聊，说不定会有意外收获。", 
    "今天争取多卖几单，早点攒够钱把那个心仪已久的大家伙买回来！", 
    "我们家独家的特制酱料配方，就藏在这一道道看似普通的家常菜里。", 
    "无论科技怎么进步，用心为食客做菜的那份心意永远不会变。", 
    "合理安排备菜区的空间，是成为高效主厨的第一步。" 
];

function initLoadingScreen() {
    const iconEl = document.getElementById('loading-icon');
    const tipsEl = document.getElementById('loading-tips');
    
    // 1. 图片轮播 (每 2 秒切换)
    if (iconEl && LOADING_CAROUSEL_IMAGES.length > 0) {
        let currentIdx = 0;
        const updateIcon = () => {
            iconEl.style.backgroundImage = `url('${LOADING_CAROUSEL_IMAGES[currentIdx]}')`;
            currentIdx = (currentIdx + 1) % LOADING_CAROUSEL_IMAGES.length;
        };
        updateIcon(); // 立即显示第一张
        setInterval(updateIcon, 2000); // 每2秒切换
    }

    // 2. 文案轮播 (每 2.5 秒切换)
    if (tipsEl && LOADING_TIPS_TEXTS.length > 0) {
        let textIndex = Math.floor(Math.random() * LOADING_TIPS_TEXTS.length);
        tipsEl.innerText = LOADING_TIPS_TEXTS[textIndex]; // 初始随机一条
        
        setInterval(() => {
            // 简单的淡入淡出效果
            tipsEl.style.opacity = '0';
            setTimeout(() => {
                textIndex = (textIndex + 1) % LOADING_TIPS_TEXTS.length; // 顺序轮播
                tipsEl.innerText = LOADING_TIPS_TEXTS[textIndex];
                tipsEl.style.opacity = '0.9';
            }, 300); // 300ms 后切换文字并显示
        }, 2500);
    }
}

window.onload = () => {
    initLoadingScreen(); // [新增] 启动 Loading 界面动态效果

    const bar = document.getElementById('loading-bar');
    const txt = document.getElementById('loading-text');
    const btn = document.getElementById('btn-start');
    const btnShop = document.getElementById('btn-shop');

    if (btnShop) btnShop.onclick = showShop;

    loadGameState();
    updateBalanceDisplay();

    // [核心修改] 检查是否有新征程参数
    const ngParamsRaw = localStorage.getItem('ng_params');
    if (ngParamsRaw) {
        try {
            const ngParams = JSON.parse(ngParamsRaw);
            // 如果是 Day 1 且没有历史记录（刚重置完），则应用启动资金
            if (game.level === 1 && (!game.history || game.history.length === 0)) {
                if (typeof ngParams.startCoins === 'number') {
                    game.coins = ngParams.startCoins;
                    window.tempCoins = game.coins; // 同步给商店/备菜临时变量
                    console.log(`[New Journey] Inherited coins: ¥${game.coins}`);
                }
            }
        } catch(e) {
            console.error("Error parsing ng_params", e);
        }
    }
    
    updateBalanceDisplay(); // 立即刷新 UI 显示金额

    initRealBusinessHUD();

    initGameBackground();
    updateGameBackground();
    preloadAudio();
    try { runPrepLogicTests(); } catch (e) { console.warn('Prep tests skipped:', e); }

    let triedStartLoadingBgm = false;
    const tryStartLoadingBgm = () => {
        if (triedStartLoadingBgm) return;
        triedStartLoadingBgm = true;
        if (themeMusicEnabled) startMusic();
    };

    tryStartLoadingBgm();
    document.addEventListener('pointerdown', () => {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        tryStartLoadingBgm();
    }, { once: true, passive: true });

    let progress = 0;
    const duration = 10000; // 10s
    const startTime = Date.now();
    
    function step() {
        const elapsed = Date.now() - startTime;
        progress = Math.min(100, (elapsed / duration) * 100);
        
        bar.style.width = `${progress}%`;
        txt.innerText = `资源加载中 ${progress.toFixed(0)}%`;
        
        if (progress < 100) {
            requestAnimationFrame(step);
        } else {
            txt.innerText = "加载完成！";
            setTimeout(() => {
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.style.display = 'none';
                switchScreen('start-screen');
            }, 50);
        }
    }
    requestAnimationFrame(step);

    if (btn) {
        btn.onclick = function() {
            // [新增] 音效与 AudioContext 激活
            const playStartSound = () => { if(typeof playSfx === 'function') playSfx(400, 'triangle', 0.3); };

            if (audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => {
                    console.log("AudioContext resumed by Start Button");
                    playStartSound();
                }).catch(e => console.error("Audio resume failed:", e));
            } else {
                playStartSound();
            }
            
            // [新增] 检查并补充预加载（以防onload时网络卡顿未完成）
            if (angryBuffers.length === 0) {
                 console.log("Retry preloading angry sounds...");
                 preloadAudio(); 
            }

            // 统一使用 startGame() 进入游戏，确保 BGM 连续性与逻辑一致
            startGame();
        };
    }

    const storeBtn = document.getElementById('btn-store');
    if (storeBtn) {
        storeBtn.onclick = () => {
            playCoin();
            showToast('商店系统即将上线', 1500);
        };
    }
};

function setPaused(paused) {
    if (!game.isLive) return;
    game.isPaused = paused;
    document.getElementById('pause-overlay').style.display = paused ? 'flex' : 'none';
    document.getElementById('btn-pause').innerText = paused ? "▶ 继续" : "⏸ 暂停";
    musicGain.gain.value = paused ? 0.15 : 0.3;
    updateGameBackground();
}

window.confirmEndGame = function() {
    // [修复] 使用自定义模态框，保持游戏背景状态
    const modal = document.getElementById('end-game-modal');
    if (modal) {
        modal.style.display = 'flex';
    } else {
        if (confirm("确定要结束当前游戏吗？\n当前关卡进度将不会保存，但会保留最高分记录。")) {
            window.endGame();
        }
    }
};

window.hideEndGameModal = function() {
    const modal = document.getElementById('end-game-modal');
    if (modal) modal.style.display = 'none';
};

window.endGame = function() {
    console.log("Starting endGame sequence...");

    // [修复] 强制隐藏全局垃圾桶
    const trashCard = document.getElementById('global-trash-card');
    if (trashCard) trashCard.style.display = 'none';
    
    // 隐藏自定义模态框
    const modal = document.getElementById('end-game-modal');
    if (modal) modal.style.display = 'none';

    // 强制保险：如果发生严重错误，100ms后强制刷新
    const safetyTimeout = setTimeout(() => {
        const gameContainer = document.getElementById('game-container');
        if (gameContainer && gameContainer.style.display !== 'none') {
             console.error("EndGame failed to hide game container. Forcing reload.");
             location.reload();
        }
    }, 500);

    try {
        // 1. 停止游戏循环
        game.isLive = false;
        game.isPaused = false;
        
        // 尝试清除定时器 (使用 try-catch 防止变量未定义导致的崩溃)
        try { if (typeof gameInterval !== 'undefined') clearInterval(gameInterval); } catch(e){}
        try { if (typeof timerInterval !== 'undefined') clearInterval(timerInterval); } catch(e){}
        
        // 2. 停止音乐
        try {
            stopMusic();
        } catch(e) {
            console.warn("stopMusic failed:", e);
        }
        
        // 3. 强制隐藏暂停界面和游戏界面 (使用 cssText 覆盖所有样式)
        const pauseOverlay = document.getElementById('pause-overlay');
        if (pauseOverlay) {
            pauseOverlay.style.cssText = 'display: none !important;';
        }
        
        const gameContainer = document.getElementById('game-container');
        if (gameContainer) {
            gameContainer.style.display = 'none';
        }
        
        const overlay = document.getElementById('overlay');
        if (overlay) overlay.style.display = 'none';
        
        // 4. 重置游戏状态
        // 这里不需要太复杂，因为 switchScreen('start-screen') 会处理一部分
        // 但我们要确保数据被重置，防止下次开始有问题
        if (game) {
             game.activeOrders = [];
             game.orderSlots = [null, null, null, null, null];
             game.slotCooldowns = [0, 0, 0, 0, 0];
             // 更多重置...
        }

        // 5. 显示开始界面
        console.log("Switching to start-screen...");
        switchScreen('start-screen');
        
        // 6. 恢复音量
        try {
            if (typeof musicGain !== 'undefined' && typeof audioCtx !== 'undefined') {
                musicGain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            }
        } catch(e) {
            console.warn("Restore volume failed:", e);
        }
        
        // 7. 播放主题曲
        try {
            if (themeMusicEnabled) {
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume().then(() => {
                        AudioController.playTheme();
                    });
                } else {
                    AudioController.playTheme();
                }
            }
        } catch(e) {
             console.warn("Theme bgm play failed:", e);
        }
        
        clearTimeout(safetyTimeout); // 如果成功执行到这里，取消强制刷新

    } catch (criticalError) {
        console.error("CRITICAL ERROR in endGame:", criticalError);
        // Fallback: force reload immediately
        location.reload(); 
    }
};

// 移除可能存在的旧监听器 (虽然 DOM 已经替换了 onclick，但为了保险)
const btnEndGame = document.getElementById('btn-end-game');
if (btnEndGame) {
    // 移除所有 click 监听器是不可能的，但我们已经替换了 onclick 属性
    // 如果之前是通过 addEventListener 添加的，它们仍然存在。
    // 最好的办法是用 cloneNode 替换元素，去除所有监听器
    const newBtn = btnEndGame.cloneNode(true);
    btnEndGame.parentNode.replaceChild(newBtn, btnEndGame);
    // 重新绑定 onclick (cloneNode 会复制 inline onclick，但不会复制 addEventListener)
    // 但因为我们在 HTML 中写了 onclick，cloneNode 会保留它。
}

function showResult(msg) {
    // [新增] 结算时隐藏全局垃圾桶
    const trashCard = document.getElementById('global-trash-card'); 
    if (trashCard) trashCard.style.display = 'none';

    playResultSfx(); // [新增] 播放成绩单音效
    
    // [修复] 结算时停止所有工位的音效 (如炒菜声)
    if (typeof stations === 'object') {
        Object.values(stations).forEach(s => {
            if (s.audio) {
                s.audio.pause();
                s.audio = null;
            }
        });
    }

    try {
        game.isLive = false;
        game.isPaused = false;
        document.getElementById('pause-overlay').style.display = 'none';
        document.getElementById('overlay').style.display = 'flex';
        updateGameBackground();
        
        const modalTitle = document.getElementById('modal-title');
        if (modalTitle) modalTitle.innerText = "💰 今日结算";
        
        // 1. 渲染图表 (保持原有的图表逻辑)
        let chartHtml = '<div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">';
        chartHtml += '<div style="font-size:14px; color:#666; margin-bottom:10px;">近7日营收趋势</div>';
        
        const historySource = Array.isArray(game.history) ? game.history : [];
        const uniqueHistory = [];
        historySource.forEach(h => {
            if (uniqueHistory.length > 0 && uniqueHistory[uniqueHistory.length - 1].day === h.day) {
                uniqueHistory[uniqueHistory.length - 1] = h;
            } else {
                uniqueHistory.push(h);
            }
        });
        const historySlice = uniqueHistory.slice(-7);
        
        if (historySlice.length < 1) {
            chartHtml += '<div style="text-align:center; color:#999; padding:30px;">暂无数据</div>';
        } else {
            const width = 340;
            const height = 120;
            const padding = { top: 15, bottom: 20, left: 10, right: 10 };
            
            const revenues = historySlice.map(h => Number.isFinite(h.revenue) ? h.revenue : 0);
            const maxRev = Math.max(...revenues, 100);
            const minRev = Math.min(...revenues, 0);
            const range = maxRev - minRev || 1;
            
            const points = historySlice.map((h, i) => {
                const safeRev = Number.isFinite(h.revenue) ? h.revenue : 0;
                const x = padding.left + (i / (historySlice.length - 1 || 1)) * (width - padding.left - padding.right);
                const y = height - padding.bottom - ((safeRev - minRev) / range) * (height - padding.top - padding.bottom);
                return { x, y, val: safeRev, day: h.day };
            });
            
            let pathD = `M ${points[0].x} ${points[0].y}`;
            points.forEach((p, i) => { if (i > 0) pathD += ` L ${p.x} ${p.y}`; });
            
            chartHtml += `
            <div class="chart-container" style="margin-bottom: 25px; height: auto; border: none !important; box-shadow: none;">
                <div id="chart-tooltip" class="chart-tooltip"></div>
                <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet" style="width:100%; height:auto; display:block; overflow:visible;">
                    <line x1="${padding.left}" y1="${padding.top}" x2="${width-padding.right}" y2="${padding.top}" stroke="#eee" stroke-width="1" stroke-dasharray="4"/>
                    <line x1="${padding.left}" y1="${height-padding.bottom}" x2="${width-padding.right}" y2="${height-padding.bottom}" stroke="#eee" stroke-width="1"/>
                    <path d="${pathD}" class="chart-line" />
                    ${points.map(p => `<text x="${p.x}" y="${height - 5}" class="chart-label" style="font-size:10px; fill:#999; text-anchor:middle;">D${p.day}</text>`).join('')}
                    ${points.map(p => `<circle cx="${p.x}" cy="${p.y}" r="4" class="chart-point" onmouseover="showTooltip(event, 'Day ${p.day}\\n营收: ¥${p.val}')" onmouseout="hideTooltip()" />`).join('')}
                </svg>
            </div>`;
        }
        chartHtml += '</div>';
        
        const descEl = document.getElementById('modal-desc');
        if (descEl) descEl.innerHTML = msg + chartHtml;
        
        // --- [核心修复] 按钮逻辑重构 ---
        // 修改：直接获取容器，而不是依赖可能被删除的 modal-btn
        const container = document.querySelector('#overlay .modal-actions');
        
        if (container) {
            container.innerHTML = ''; // 清空旧按钮
            
            // 重新设置容器样式
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.gap = '12px';
            container.style.marginTop = '20px';

            // 1. 进驻新城市按钮 (仅当资金达标时显示)
            if (game.coins >= game.targetRevenue) {
                const expandBtn = document.createElement('button');
                expandBtn.innerHTML = "🏆 资金达标！查看通关考评";
                expandBtn.onclick = () => {
                    document.getElementById('overlay').style.display = 'none';
                    showAchievementDetails();
                };
                // 金色样式
                expandBtn.style.cssText = "background:linear-gradient(135deg, #f1c40f, #e67e22); color:white; padding:12px 20px; border:none; border-radius:12px; font-weight:bold; cursor:pointer; font-size:16px; box-shadow:0 4px 10px rgba(241,196,15,0.4); width:100%; animation: pulseGold 2s infinite;";
                container.appendChild(expandBtn);
            }

            // 2. 标准操作行 (返回首页 + 继续营业)
            const actionRow = document.createElement('div');
            actionRow.style.cssText = "display:flex; gap:10px; width:100%;";

            // [修复] 补回“返回首页”按钮
            const btnHome = document.createElement('button');
            btnHome.innerText = "🏠 返回首页";
            btnHome.onclick = () => hideResultModal();
            btnHome.style.cssText = "flex:1; background:transparent; border:1px solid #ccc; color:#666; padding:12px; border-radius:12px; cursor:pointer; font-weight:bold; font-size:15px;";
            
            // [修复] “继续营业”按钮
            const btnContinue = document.createElement('button');
            btnContinue.id = "btn-continue-next"; // [关键] 赋予ID，供startNextLevel查找
            btnContinue.innerText = "📅 开始第 " + (game.level + 1) + " 天";
            // [关键] 传入正确的ID 'btn-continue-next'
            btnContinue.onclick = () => startNextLevel('btn-continue-next');
            btnContinue.style.cssText = "flex:2; background:#2ecc71; color:white; padding:12px; border:none; border-radius:12px; font-weight:bold; cursor:pointer; font-size:16px; box-shadow:0 4px 0 #27ae60;";

            actionRow.appendChild(btnHome);
            actionRow.appendChild(btnContinue);
            container.appendChild(actionRow);
        }
        
        // 触发图表动画
        requestAnimationFrame(() => {
            const points = document.querySelectorAll('#modal-desc .chart-point');
            points.forEach((p, i) => {
                p.style.animationDelay = `${(i + 1) * 50}ms`;
                p.classList.add('animate');
            });
            const line = document.querySelector('#modal-desc .chart-line');
            if(line) {
                const len = line.getTotalLength();
                line.style.strokeDasharray = len;
                line.style.strokeDashoffset = len;
                line.getBoundingClientRect();
                line.style.transition = 'stroke-dashoffset 1s ease';
                line.style.strokeDashoffset = '0';
            }
        });
        
    } catch (e) {
        console.error('Result modal render error:', e);
    }
}

function hideResultModal() {
    const overlay = document.getElementById('overlay');
    if (overlay) overlay.style.display = 'none';
    switchScreen('start-screen');
}

window.showTooltip = function(evt, text) {
    const tt = document.getElementById('chart-tooltip');
    tt.innerText = text;
    tt.style.opacity = '1';
    
    // Position relative to the container
    const container = document.querySelector('.chart-container');
    const containerRect = container.getBoundingClientRect();
    const pointRect = evt.target.getBoundingClientRect();
    
    // Calculate initial position (centered above point)
    let left = pointRect.left - containerRect.left - (tt.offsetWidth / 2) + (pointRect.width / 2);
    let top = pointRect.top - containerRect.top - tt.offsetHeight - 8;

    // Boundary Checks
    if (left < 0) left = 0;
    if (left + tt.offsetWidth > containerRect.width) left = containerRect.width - tt.offsetWidth;
    if (top < 0) top = pointRect.top - containerRect.top + pointRect.height + 8; // Flip to bottom

    tt.style.left = left + 'px';
    tt.style.top = top + 'px';
};
window.hideTooltip = function() {
    const tt = document.getElementById('chart-tooltip');
    if(tt) tt.style.opacity = '0';
};

// --- Audio Logic ---
// 预设金币音效合成 (更清脆的双音调)
function createCoinBuffer(ctx) {
    const sr = ctx.sampleRate;
    const dur = 0.1; // Shorter
    const len = Math.floor(sr * dur);
    const buf = ctx.createBuffer(1, len, sr);
    const data = buf.getChannelData(0);
    
    for (let i = 0; i < len; i++) {
        const t = i / sr;
        // B5 (987Hz) -> E6 (1318Hz) rapid arpeggio effect
        const f = t < 0.05 ? 987.77 : 1318.51; 
        // Simple decay envelope
        const vol = 1 - (t / dur);
        data[i] = Math.sin(2 * Math.PI * f * t) * vol * 0.15; // Normalized volume (0.3 -> 0.15)
        
        // Add some high harmonics for "sparkle"
        data[i] += Math.sin(2 * Math.PI * f * 2 * t) * vol * 0.05; // Normalized volume (0.1 -> 0.05)
    }
    return buf;
}

let lastCoinTime = 0;
function playCoin() {
    if (!sfxEnabled || !coinBuffer) return;
    const now = audioCtx.currentTime;
    
    // Prevent overlap overlap (max 10 coins per second)
    if (now - lastCoinTime < 0.08) return;
    lastCoinTime = now;

    const src = audioCtx.createBufferSource();
    src.buffer = coinBuffer;
    src.connect(sfxGain);
    src.start();
}

let lastRevenueTime = 0;
function playRevenueSound() {
    if (!sfxEnabled) return;
    const now = audioCtx.currentTime;
    
    // Prevent overlap overlap (max 10 coins per second)
    if (now - lastRevenueTime < 0.08) return;
    lastRevenueTime = now;

    if (revenueBuffer) {
        const src = audioCtx.createBufferSource();
        src.buffer = revenueBuffer;
        src.connect(sfxGain);
        src.start();
    } else {
        // Fallback to HTML5 Audio if Web Audio buffer not ready
        console.warn("revenueBuffer not ready, using fallback");
        // Clone the audio object to allow overlapping plays
        const tempAudio = revenueAudio.cloneNode();
        tempAudio.volume = 0.5;
        tempAudio.play().catch(e => console.error("Fallback audio play failed:", e));
    }
}

function showAchievementDetails() {
    // 1. Calculate Stats
    const totalRevenue = game.totalRevenue;
    const completedOrders = game.totalOrdersCompleted;
    const dishesServed = game.totalDishesServed;
    
    let totalRateSum = 0;
    game.history.forEach(h => totalRateSum += parseFloat(h.rate));
    const finalRate = game.history.length > 0 ? (totalRateSum / game.history.length).toFixed(1) : "0.0";
    
    const errors = game.totalErrors;
    const days = game.level;

    // 2. Determine Grade
    let grade = 'C';
    let title = gameLang === 'en' ? "Kitchen Staff" : "后厨学徒";
    if (finalRate >= 90 && errors < 5) { grade = 'S'; title = gameLang === 'en' ? "Legendary Chef" : "传奇名厨"; }
    else if (finalRate >= 80 && errors < 10) { grade = 'A'; title = gameLang === 'en' ? "Head Chef" : "行政主厨"; }
    else if (finalRate >= 70) { grade = 'B'; title = gameLang === 'en' ? "Sous Chef" : "资深大厨"; }
    
    // 3. Update UI
    const container = document.getElementById('ach-container');
    document.getElementById('ach-title').innerText = `🏆 ${title}`;
    
    container.innerHTML = `
        <div class="ach-grade-box">
            <div class="ach-grade-badge">${grade}</div>
            <div class="ach-grade-title">${gameLang==='en'?'Performance Rating':'综合评级'}</div>
        </div>
        
        <div class="ach-stats-grid">
            <div class="ach-stat-item">
                <span class="ach-stat-label">${gameLang==='en'?'Total Revenue':'总营业额'}</span>
                <span class="ach-stat-val val-gold">¥${totalRevenue}</span>
            </div>
            <div class="ach-stat-item">
                <span class="ach-stat-label">${gameLang==='en'?'Satisfaction':'顾客满意度'}</span>
                <span class="ach-stat-val val-green">${finalRate}%</span>
            </div>
            <div class="ach-stat-item">
                <span class="ach-stat-label">${gameLang==='en'?'Orders Completed':'完成单量'}</span>
                <span class="ach-stat-val">${completedOrders}</span>
            </div>
            <div class="ach-stat-item">
                <span class="ach-stat-label">${gameLang==='en'?'Dishes Served':'出餐总数'}</span>
                <span class="ach-stat-val">${dishesServed}</span>
            </div>
            <div class="ach-stat-item">
                <span class="ach-stat-label">${gameLang==='en'?'Errors':'失误次数'}</span>
                <span class="ach-stat-val ${errors>5?'val-red':'val-green'}">${errors}</span>
            </div>
            <div class="ach-stat-item">
                <span class="ach-stat-label">${gameLang==='en'?'Days':'营业天数'}</span>
                <span class="ach-stat-val">${days}</span>
            </div>
        </div>

        <div class="ach-chart-box">
            <canvas id="ach-revenue-chart"></canvas>
        </div>
    `;

    const achModal = document.getElementById('achievement-modal');
    if (achModal) {
        achModal.classList.remove('grade-S','grade-A','grade-B','grade-C');
        achModal.classList.add(`grade-${grade}`);
        achModal.style.display = 'flex';
        setGameBgVisual('grayscale(0.12) brightness(0.70) contrast(1.06)', 0.58);
    }

    // 5. Render Chart.js
    if (window.Chart) {
        const ctx = document.getElementById('ach-revenue-chart').getContext('2d');
        const historySlice = game.history.slice(-7);
        // Fallback data if history is empty (for demo/test)
        const labels = historySlice.length ? historySlice.map(h => `Day ${h.day}`) : ['Day 1'];
        const data = historySlice.length ? historySlice.map(h => h.revenue) : [0];

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '每日营收 (¥)',
                    data: data,
                    backgroundColor: 'rgba(241, 196, 15, 0.2)',
                    borderColor: 'rgba(241, 196, 15, 1)',
                    borderWidth: 3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: 'rgba(241, 196, 15, 1)',
                    pointRadius: 4,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { 
                        backgroundColor: 'rgba(0,0,0,0.8)', 
                        titleColor: '#f1c40f',
                        callbacks: { label: (c) => ` 营收: ¥${c.raw}` }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { color: 'rgba(0,0,0,0.05)' }, 
                        ticks: { color: '#666', font: {size: 10} },
                        border: { display: false }
                    },
                    x: { 
                        grid: { display: false }, 
                        ticks: { color: '#666', font: {size: 10} },
                        border: { display: false }
                    }
                },
                animation: { duration: 1500, easing: 'easeOutQuart' }
            }
        });
    }

    // 6. Play Sound based on grade
    if (grade === 'S' || grade === 'A') playSfx(1000, 'sine', 0.5); // Happy
    else playSfx(400, 'square', 0.5); // Normal
}

// --- Settings Modal Logic ---
function showSettingsModal() {
    document.getElementById('settings-modal').style.display = 'flex';
}
function hideSettingsModal() {
    document.getElementById('settings-modal').style.display = 'none';
}

// --- New Location Selection Logic ---

function showLocationSelection() {
    const ach = document.getElementById('achievement-modal');
    if (ach) ach.style.display = 'none';
    switchScreen('map-screen');
    if (typeof renderLocationStep1 === 'function') {
        renderLocationStep1();
    }
}

function closeLocationSelection() {
    // [核心修复] 退出时清理底部栏
    const oldBar = document.getElementById('map-bottom-bar');
    if (oldBar) oldBar.remove();
    
    switchScreen('start-screen');
}

let selectedLocationId = 'cn-shenzhen:cbd';
let selectedRegionId = null;
let selectedDistrictId = null;
let locationStep = 1;

const WORLD_REGIONS = [ 
    { 
        id: 'cn', 
        country: '中国', 
        city: '中华美食总店', 
        flag: '🇨🇳', 
        desc: '梦开始的地方', 
        isStarter: true, // 标记为初始 
        unlocked: true,  // 默认解锁 
        districts: [ 
            { id: 'main', name: '总店·商业街', unlocked: true, unlockCost: 0, customerProfile: { type: '街坊邻居', spend: '中', patience: '中' } } 
        ] 
    }, 
    { 
        id: 'jp', 
        country: '日本', 
        city: '东京分店', 
        flag: '🇯🇵', 
        desc: '精致快节奏', 
        unlocked: true, 
        districts: [ 
            { id: 'shibuya', name: '涩谷·十字街头', unlocked: true, unlockCost: 5000, customerProfile: { type: '上班族', spend: '中', patience: '低' } } 
        ] 
    }, 
    { 
        id: 'fr', 
        country: '法国', 
        city: '巴黎分店', 
        flag: '🇫🇷', 
        desc: '浪漫与顶级美味', 
        unlocked: true, 
        districts: [ 
            { id: 'champ', name: '香榭丽舍·旗舰店', unlocked: true, unlockCost: 8000, customerProfile: { type: '美食家', spend: '极高', patience: '高' } } 
        ] 
    } 
];

function getRegionById(id) {
    return WORLD_REGIONS.find(r => r.id === id) || null;
}

function playLocationSelectSound() {
    if (!sfxEnabled) return;
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.connect(g); g.connect(masterGain);
    osc.frequency.setValueAtTime(600, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.1);
    g.gain.setValueAtTime(0.1, audioCtx.currentTime);
    g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
    osc.start(); osc.stop(audioCtx.currentTime + 0.1);
}

// [核心修复] 根据区域和等级获取店铺外观图标
function getShopImage(region, expansionLevel) {
    // 默认区域处理 (防止旧存档缺少 regionId)
    const r = region || 'cn';
    const lv = expansionLevel || 0;
    
    // 新命名规范: assets/equipment/kitchen_cn_lv0.png
    return `assets/equipment/kitchen_${r}_lv${lv}.png`;
}

function renderLocationStep1() { 
    const dock = document.getElementById('region-dock-container'); 
    if (!dock) return; 
    
    // 清理旧内容 
    dock.innerHTML = ''; 
    const oldBar = document.getElementById('map-bottom-bar'); 
    if (oldBar) oldBar.remove(); 

    // 数据准备 
    const legacyList = JSON.parse(localStorage.getItem('legacy_shops_list') || '[]'); 
    const currentParams = JSON.parse(localStorage.getItem('ng_params') || '{}'); 
    const currentName = currentParams.branchName || "中国 · 总店商业街"; 
    const currentLocId = currentParams.location ? currentParams.location.split(':')[0] : 'cn'; 
    
    // 构建列表 
    const currentShopObj = { 
        isCurrent: true, 
        name: currentName, 
        regionId: currentLocId, 
        expansion: game.inventory.expansion || 0, 
        income: calculateLegacyDailyIncome() 
    }; 
    const allShops = [currentShopObj, ...legacyList]; 
    
    // --- A. 顶部：我的店铺 --- 
    // [修改] 移除冗余的 sectionTitle，直接渲染容器 
    const empireContainer = document.createElement('div'); 
    empireContainer.className = 'empire-scroll-container'; 
    // 增加一点顶部间距，避免稍微挡住大标题 
    empireContainer.style.marginTop = "10px"; 
    
    allShops.forEach(shop => { 
        const regionInfo = getRegionById(shop.regionId) || WORLD_REGIONS[0]; 
        const card = document.createElement('div'); 
        card.className = 'empire-card'; 
        
        const isLive = shop.isCurrent; 
        // [核心修复] 传入 regionId 以匹配新文件名
        const imgSrc = getShopImage(shop.regionId, shop.expansion || 0);
        
        // 计算托管收益
        const level = (shop.expansion || 0);
        const managedRevenue = 100 + (50 * level);

        // 样式逻辑
        let borderColor = isLive ? '#2ecc71' : '#bdc3c7'; 
        card.style.borderColor = borderColor; 
        
        let badgeHtml = ''; 
        if (isLive) badgeHtml = `<div class="card-badge badge-live">营业中</div>`; 
        else badgeHtml = `<div class="card-badge" style="background:#34495e;">托管中</div>`; 
        
        card.innerHTML = ` 
            ${badgeHtml} 
            <div style="width:60px; height:60px; margin: 10px 0 5px; display:flex; align-items:center; justify-content:center;"> 
                <img src="${imgSrc}" style="width:100%; height:100%; object-fit:contain; filter:drop-shadow(0 4px 4px rgba(0,0,0,0.4));" onerror="this.style.display='none'"> 
            </div> 
            <div class="empire-country-tag"> 
                <span>${regionInfo.flag}</span> ${regionInfo.country} 
            </div> 
            <div class="empire-name">${shop.name}</div> 
            <div class="empire-info-row"> 
                ${isLive ? `预计 ¥${shop.income}/日` : `收益 ¥${managedRevenue}/日`} 
            </div> 
        `; 
        
        card.onclick = isLive ? 
            () => { playSfx(400,'sine',0.1); closeLocationSelection(); } : 
            () => { playSfx(400,'sine',0.1); showLegacyManageModal(shop); };
            
        empireContainer.appendChild(card); 
    }); 
    dock.appendChild(empireContainer); 
    
    // --- B. 底部：拓展版图 Tab 栏 --- 
    const mapScreen = document.getElementById('map-screen'); 
    const bottomBar = document.createElement('div'); 
    bottomBar.id = 'map-bottom-bar'; 
    bottomBar.className = 'map-bottom-bar'; 
    
    // [修改] 标题：样式类已更新为横向 
    const barTitle = document.createElement('div'); 
    barTitle.className = 'map-bottom-title'; 
    barTitle.innerHTML = `
        <div class="map-bottom-main-text">拓展新版图</div>
        <div class="map-bottom-sub-text">选择新分店位置</div>
    `;
    bottomBar.appendChild(barTitle); 
    
    // 排序 
    const sortOrder = ['fr', 'cn', 'jp']; 
    const sortedRegions = [...WORLD_REGIONS].sort((a, b) => sortOrder.indexOf(a.id) - sortOrder.indexOf(b.id)); 
    
    sortedRegions.forEach(region => { 
        // const isCurrent = (region.id === currentLocId); 
        const tab = document.createElement('div'); 
        tab.className = 'country-tab'; // 默认不选中
        
        tab.innerHTML = ` 
            <div class="tab-flag">${region.flag}</div> 
            <div class="tab-name">${region.country}</div> 
        `; 
        
        if (region.unlocked) { 
            tab.onclick = () => { 
                playLocationSelectSound(); 
                // [Update] 统一Tab选中态
                document.querySelectorAll('.country-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                renderLocationStep2(region.id); 
            }; 
        } else { 
            tab.style.opacity = '0.5'; 
            tab.style.filter = 'grayscale(1)'; 
            tab.onclick = () => { playSfx(150, 'sawtooth', 0.2); showToast('该地区尚未解锁', 1000); }; 
        } 
        bottomBar.appendChild(tab); 
    }); 
    
    // [新增] "等待开放" 按钮 
    const waitingTab = document.createElement('div'); 
    waitingTab.className = 'country-tab waiting'; 
    waitingTab.innerHTML = ` 
        <div class="tab-flag" style="filter:grayscale(1); opacity:0.6;">🔜</div> 
        <div class="tab-name">等待开放</div> 
    `; 
    waitingTab.onclick = () => { showToast('更多国家敬请期待...', 1000); }; 
    bottomBar.appendChild(waitingTab); 
    
    mapScreen.appendChild(bottomBar); 
}

// ================= 剧情系统 ================= 
const INTRO_STORY = [ 
    { 
        speaker: "高叔", 
        text: "孩子……你终于回来了。", 
        image: "assets/characters/高叔.png", 
        audio: "assets/voice/intro_gao_0.mp3", // [新增] 配音路径 
        volume: 0.5 // [调整] 第一句音量调低
    }, 
    { 
        speaker: "高叔", 
        text: "这间店你爷爷守了一辈子，现在……你就是这家店的主厨了。", 
        image: "assets/characters/高叔.png", 
        audio: "assets/voice/intro_gao_1.mp3",
        volume: 0.5 // [调整] 第二句音量调低
    }, 
    { 
        speaker: "高叔", 
        text: "高叔相信你一定能让这个老招牌重新在这条街亮起来。", 
        image: "assets/characters/高叔.png", 
        audio: "assets/voice/intro_gao_2.mp3" 
    }, 
    { 
        speaker: "高叔", 
        text: "我帮你张罗了一批新鲜食材已经入库了，先练练手，把咱那灶台热起来再说！", 
        image: "assets/characters/高叔.png", 
        reward: { coins: 500, items: { 'tomato': 5, 'egg': 5, 'rice': 5, 'onion': 5 } }, 
        audio: "assets/voice/intro_gao_3.mp3" 
    } 
]; 

// [全局音频对象] 确保跨函数/跨调用时也能控制音频停止
let currentVoiceAudio = null;
let currentDialogueBgm = null; // [新增] 全局剧情 BGM 对象

function renderStoryModal(storyData, onComplete) { 
    let currentIndex = 0; 
    // let currentVoiceAudio = null; // [修改] 移除局部变量，使用全局变量
    const container = document.getElementById('game-container') || document.body; 
    
    // 移除旧层 
    const oldOverlay = document.getElementById('story-overlay'); 
    if (oldOverlay) oldOverlay.remove(); 
    
    // [新增] 安全停止之前的音频（如果存在）
    if (currentVoiceAudio) {
        currentVoiceAudio.pause();
        currentVoiceAudio = null;
    }

    // 1. [优化] 极速淡出原 BGM (50ms 一次，迅速降噪) 
    const fadeOutBgm = () => { 
        const audios = document.querySelectorAll('audio'); 
        audios.forEach(audio => { 
            // 排除语音和剧情BGM 
            if (!audio.paused && !audio.src.includes('对话框bgm.mp3')) { 
                let vol = audio.volume; 
                const fadeInterval = setInterval(() => { 
                    if (vol > 0.05) { 
                        vol -= 0.1; // [修改] 每次减 0.1，更快 
                        if(vol < 0) vol = 0; 
                        audio.volume = vol; 
                    } else { 
                        audio.pause(); 
                        clearInterval(fadeInterval); 
                    } 
                }, 50); // [修改] 50ms 极速响应 
            } 
        }); 
    }; 
    // 立即执行淡出 
    fadeOutBgm(); 

    // 2. [优化] 降低剧情背景音，不抢人声 
    currentDialogueBgm = new Audio('audio/对话框bgm.mp3'); 
    currentDialogueBgm.loop = true; 
    currentDialogueBgm.volume = 0.3; // [修改] 降至 0.3 
    currentDialogueBgm.play().catch(e => console.log("剧情BGM自动播放受阻:", e));

    const overlay = document.createElement('div'); 
    overlay.id = 'story-overlay'; 
    overlay.style.cssText = ` 
        position:fixed; top:0; left:0; width:100%; height:100%; z-index:20001; 
        background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.6)), url('assets/bg/门店后厨.jpg') center/cover no-repeat; 
        display:flex; flex-direction:column; justify-content:flex-end; padding-bottom:15%; 
        transition: background 0.5s ease; 
    `; 

    const stopCurrentVoice = () => { 
        if (currentVoiceAudio) { 
            currentVoiceAudio.pause(); 
            currentVoiceAudio.currentTime = 0; 
            currentVoiceAudio = null; 
        } 
    }; 

    const renderFrame = () => { 
        stopCurrentVoice(); 
        if (currentIndex >= storyData.length) { 
            // [新增] 剧情结束，停止专属 BGM
            if (currentDialogueBgm) {
                currentDialogueBgm.pause();
                currentDialogueBgm.currentTime = 0;
                currentDialogueBgm = null;
            }
            overlay.remove(); 
            if (onComplete) onComplete(); 
            return; 
        } 
        
        const frame = storyData[currentIndex]; 
        
        // [核心逻辑修改] 音频播放控制 
        const playFrameAudio = () => { 
            if (frame.audio) { 
                stopCurrentVoice(); // 再次确保安全 
                currentVoiceAudio = new Audio(frame.audio); 
                // 3. [优化] 优先使用配置音量，默认统一为 0.8 
                currentVoiceAudio.volume = (frame.volume !== undefined) ? frame.volume : 0.8;
                currentVoiceAudio.play().catch(e => console.log("Audio play blocked:", e)); 
            } 
        }; 
        // 如果有奖励且未领取 -> 暂停播放，等待领奖 
        // 如果没有奖励 -> 立即播放 
        if (!frame.reward || frame.rewarded) { 
            playFrameAudio(); 
        } 

        // 背景切换 
        if (frame.reward) { 
            overlay.style.background = "linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.85)), url('assets/bg/家庭厨房.jpeg') center/cover no-repeat"; 
        } else { 
            overlay.style.background = "linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.6)), url('assets/bg/门店后厨.jpg') center/cover no-repeat"; 
        } 
        
        // 奖励弹窗 
        let rewardModalHtml = ''; 
        if (frame.reward && !frame.rewarded) { 
            if(typeof playSfx === 'function') playSfx(500, 'sine', 0.4); 
            rewardModalHtml = ` 
                <div id="intro-reward-modal" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); backdrop-filter:blur(8px); z-index:10000; display:flex; align-items:center; justify-content:center;" onclick="event.stopPropagation()"> 
                    <style>
                        @keyframes popIn {
                            0% { transform: scale(0.2) translateY(40px); opacity: 0; }
                            60% { transform: scale(1.1) translateY(-10px); opacity: 1; }
                            80% { transform: scale(0.95) translateY(5px); }
                            100% { transform: scale(1) translateY(0); opacity: 1; }
                        }
                        .reward-btn:active { transform: scale(0.96); }
                    </style>
                    <div style="background:linear-gradient(145deg, #ffffff, #fffaf5); width:90%; max-width:360px; border-radius:24px; padding:32px 24px; text-align:center; box-shadow:0 25px 50px -12px rgba(0,0,0,0.5); border: 4px solid rgba(255,255,255,0.8); animation: popIn 0.6s cubic-bezier(0.25, 1, 0.5, 1); margin-bottom: calc(20vh + 18px);"> 
                        <div style="width:80px; height:80px; margin:0 auto 20px; background:linear-gradient(135deg, #fceabb, #f8b500); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 20px rgba(243,156,18,0.3);">
                            <div style="font-size:42px;">🎁</div> 
                        </div>
                        <h3 style="margin:0 0 24px 0; color:#d35400; font-size:24px; font-weight:800; text-shadow:0 1px 2px rgba(211,84,0,0.1);">高叔的馈赠</h3> 
                        <div style="background:rgba(255,248,225,0.8); border-radius:16px; padding:20px; margin-bottom:28px; border:1px solid rgba(243,156,18,0.2);"> 
                            <div style="display:flex; justify-content:space-between; margin-bottom:12px; border-bottom:1px dashed rgba(0,0,0,0.1); padding-bottom:12px;">
                                <span style="color:#7f8c8d; font-weight:600;">启动资金</span>
                                <span style="color:#e74c3c; font-size:20px; font-weight:800; font-family:monospace;">¥${frame.reward.coins}</span>
                            </div>
                            <div style="display:flex; justify-content:space-between;">
                                <span style="color:#7f8c8d; font-weight:600;">基础食材包</span>
                                <span style="color:#2ecc71; font-size:18px; font-weight:800;">x1</span>
                            </div>
                        </div> 
                        <button class="reward-btn" onclick="acceptIntroReward(event)" style="background:linear-gradient(135deg, #e67e22, #d35400); color:#fff; border:none; padding:16px 0; border-radius:30px; font-size:18px; font-weight:bold; cursor:pointer; box-shadow:0 8px 20px rgba(230,126,34,0.4); width:100%; transition:transform 0.1s;">收下这份心意</button> 
                    </div> 
                </div> 
            `; 
            
            window.acceptIntroReward = (e) => { 
                e.stopPropagation(); 
                // 发放奖励逻辑... 
                if (frame.reward.coins) { 
                    game.coins = (game.coins || 0) + frame.reward.coins; 
                    if (typeof updateBalanceDisplay === 'function') updateBalanceDisplay(); 
                } 
                if (frame.reward.items) { 
                    for (let key in frame.reward.items) { 
                        game.inventory[key] = (game.inventory[key] || 0) + frame.reward.items[key]; 
                    } 
                } 
                frame.rewarded = true; 
                if (typeof playSfx === 'function') playSfx(880, 'square', 0.2); 
                
                // [核心修改] 领奖后才播放该段语音
                playFrameAudio();

                // 移除弹窗 
                const modal = document.getElementById('intro-reward-modal'); 
                if (modal) modal.remove(); 
            }; 
        } 
    
    // [核心修改] 放大整体布局、立绘及气泡，将点击提示放入气泡内部 
    overlay.innerHTML = ` 
        <div style="width:95%; max-width:800px; margin:0 auto; padding:20px; position:relative; cursor:pointer; height:100%; display:flex; flex-direction:column; justify-content:flex-end;" onclick="advanceStory(event)"> 
            <div class="chat-row left" style="display:flex; margin-bottom: 0; align-items: flex-end;"> 
                
                <div class="chat-portrait-box" style="width: 160px; height: 220px; flex-shrink: 0; position: relative; z-index: 10;"> 
                    <img src="${frame.image}" 
                         class="chat-portrait-img" 
                         style="display:block; width: 320px; height: 380px; max-width:none; position:absolute; bottom:0; left:50%; transform:translateX(-50%); object-fit:contain; object-position:bottom center;" 
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"> 
                    <div class="chat-portrait-placeholder" style="background:#e67e22; display:none; width:80px; height:80px; font-size:40px; line-height:80px; border-radius:10px;">高</div> 
                </div> 
                
                <div class="chat-bubble" style="position:relative; flex-grow: 1; padding: 30px 40px 50px 120px !important; margin-left: -70px; z-index: 5; font-size: 18px; line-height: 1.6; min-height: 120px;"> 
                    <span style="font-weight:bold; color:#d35400; display:block; margin-bottom:12px; font-size:22px;">${frame.speaker}</span> 
                    ${frame.text} 
                    
                    <div style="position:absolute; right:25px; bottom:15px; font-size:14px; color:#e67e22; font-weight:bold; animation:blink 1.2s infinite;"> 
                        (点击屏幕继续) ▶ 
                    </div> 
                </div> 
            </div> 
        </div> 
        ${rewardModalHtml} 
    `; 
    }; 
    window.advanceStory = (e) => { 
        if (e) e.stopPropagation(); 
        
        const frame = storyData[currentIndex]; 
        // [核心修改 3] 拦截逻辑：如果当前帧有奖励且未领取，禁止进入下一句 
        if (frame.reward && !frame.rewarded) { 
            return; 
        } 
        
        currentIndex++; 
        renderFrame(); 
        if (typeof playSfx === 'function') playSfx(400, 'triangle', 0.05); 
    }; 
    renderFrame(); 
    container.appendChild(overlay); 
}

// [加一点文字闪烁动画提升提示效果] 
const style = document.createElement('style'); 
style.innerHTML = "@keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }"; 
document.head.appendChild(style); 
// ================= 剧情系统结束 =================

function renderLocationStep2(regionId) {
    const list = document.getElementById('district-list-container');
    const sidePanel = document.getElementById('district-panel');
    const dock = document.getElementById('region-dock-container');
    if (!list || !sidePanel) return;
    
    const region = getRegionById(regionId);
    if (!region) return;

    selectedRegionId = regionId;
    selectedDistrictId = null;

    // [核心修改] 获取当前所在的确切商圈 ID (如 'cn:main')
    const currentParams = JSON.parse(localStorage.getItem('ng_params') || '{}');
    // 默认为 cn:main (因为第一关没有 ng_params 时就是在这里)
    const myCurrentLocationId = currentParams.location || 'cn:main';

    // Update Header
    document.getElementById('dp-flag').textContent = region.flag;
    document.getElementById('dp-city-name').textContent = region.country; // 只显示国家名

    // Show Panel & Hide Dock
    sidePanel.classList.add('active');
    if (dock) dock.classList.add('hidden'); // Hide dock
    
    list.innerHTML = '';

    // 预先重置按钮状态
    const confirmBtn = document.getElementById('btn-confirm-loc');
    confirmBtn.innerText = "请选择新店位置";
    confirmBtn.disabled = true;
    confirmBtn.classList.add('disabled');

    region.districts.forEach(district => {
        const item = document.createElement('div');
        item.className = 'district-item';
        
        const thisLocId = region.id + ':' + district.id;
        const isMyCurrentSpot = (thisLocId === myCurrentLocationId);
        const isAffordable = game.coins >= district.unlockCost;
        const isUnlocked = district.unlocked && region.unlocked;
        
        // [核心修改] 状态标签逻辑
        let tagHtml = '';
        if (!isUnlocked) {
            tagHtml = '<span class="di-tag tag-locked">未开放</span>';
        } else if (isMyCurrentSpot) {
            // [核心修改] 显示“已进驻”
            tagHtml = '<span class="di-tag" style="background:#2ecc71; color:white;">✅ 已进驻</span>';
        } else if (!isAffordable) {
            tagHtml = '<span class="di-tag tag-expensive">资金不足</span>';
        } else {
            tagHtml = '<span class="di-tag tag-open">可进驻</span>';
        }
        
        let html = `
            <div class="di-header">
                <span class="di-name">${district.name}</span>
                ${tagHtml}
            </div>
            <div class="di-info">
                <div>💰 费用: ¥${district.unlockCost}</div>
                <div>👥 客群: ${district.customerProfile.type}</div>
                <div>💸 消费: ${district.customerProfile.spend}</div>
                <div>⏳ 耐心: ${district.customerProfile.patience}</div>
            </div>
        `;
        
        item.innerHTML = html;

        if (isUnlocked) {
            item.onclick = () => {
                playLocationSelectSound();
                selectedDistrictId = district.id;
                selectedLocationId = thisLocId;
                
                // 高亮选中
                document.querySelectorAll('.district-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                // [核心修改] 更新按钮状态
                if (isMyCurrentSpot) {
                    confirmBtn.innerText = "当前正在营业";
                    confirmBtn.disabled = true;
                    confirmBtn.style.background = "#bdc3c7";
                    confirmBtn.style.cursor = "default";
                } else if (!isAffordable) {
                    confirmBtn.innerText = "资金不足";
                    confirmBtn.disabled = true;
                    confirmBtn.style.background = "#bdc3c7";
                } else {
                    confirmBtn.innerText = `确认进驻 (¥${district.unlockCost})`;
                    confirmBtn.disabled = false;
                    confirmBtn.style.background = "rgba(241, 196, 15, 0.9)"; // 恢复金色
                    confirmBtn.style.cursor = "pointer";
                }
            };
            
            // 即使已进驻，也保持高亮可见，但不置灰（除非没解锁）
            if (isMyCurrentSpot) {
                item.style.border = "1px solid #2ecc71";
                item.style.background = "rgba(46, 204, 113, 0.1)";
            } else if (!isAffordable) {
                item.style.opacity = '0.7';
            }
        } else {
            item.classList.add('locked');
            item.onclick = () => {
                playSfx(150, 'sawtooth', 0.2);
                showToast('该商圈尚未开放', 1000);
            };
        }

        list.appendChild(item);
    });
}

window.closeDistrictPanel = function() {
    const sidePanel = document.getElementById('district-panel');
    const dock = document.getElementById('region-dock-container');
    
    // 1. Hide Panel
    if (sidePanel) sidePanel.classList.remove('active');
    
    // 2. Restore Dock
    if (dock) {
        dock.classList.remove('hidden');
    }
    
    // 3. Logic Closure
    selectedRegionId = null;
    selectedDistrictId = null;
    
    // 4. Reset UI State
    document.querySelectorAll('.district-item').forEach(i => i.classList.remove('active'));
    // [新增] 移除底部 Tab 选中态
    document.querySelectorAll('.country-tab').forEach(t => t.classList.remove('active'));
};

function confirmNewJourney() {
    if (!selectedRegionId || !selectedDistrictId) { showToast('请先选择区域', 1500); return; }
    
    const region = getRegionById(selectedRegionId);
    const district = region.districts.find(d => d.id === selectedDistrictId);
    if (!district) return;
    
    if (game.coins < district.unlockCost) { showToast('资金不足', 1500); return; }

    const newBranchName = region.country + ' · ' + district.name;
    const remainingCoins = game.coins - district.unlockCost;

    const currentParams = JSON.parse(localStorage.getItem('ng_params') || '{}');
    const currentShopName = currentParams.branchName || "中国 · 总店商业街";
    // [核心修复] 获取当前 regionId (例如 'cn')
    const currentLoc = currentParams.location || 'cn:main';
    const currentRegionId = currentLoc.split(':')[0];

    const shopToArchive = {
        id: Date.now().toString(),
        name: currentShopName,
        regionId: currentRegionId, // [关键] 保存国家ID
        baseIncome: calculateLegacyDailyIncome(),
        accumulatedCash: 0,
        health: 100,
        expansion: game.inventory.expansion || 0
    };

    let legacyList = JSON.parse(localStorage.getItem('legacy_shops_list') || '[]');
    legacyList.push(shopToArchive);
    localStorage.setItem('legacy_shops_list', JSON.stringify(legacyList));

    if (confirm(`确认花费 ¥${district.unlockCost} 进驻 [${newBranchName}]？\n\n剩余资金 ¥${remainingCoins} 将带入新店。\n当前店铺 [${currentShopName}] 将转为托管模式。`)) {
        GameStateManager.resetAllData(true);
        
        const newGameParams = {
            location: selectedLocationId,
            branchName: newBranchName,
            startCoins: remainingCoins,
            isNGPlus: true
        };
        localStorage.setItem('ng_params', JSON.stringify(newGameParams));
        location.reload();
    }
}

function isKitchenIdle() {
    return Object.values(stations).every(s => s.stage === 'IDLE' && !s.order);
}

function settleDay(reason = "营业结束") {
    if (!game.isLive || game.dayEnded) return;
    game.isLive = false;
    game.dayEnded = true;
    Object.values(stations).forEach(s => { if (s.timer) { clearInterval(s.timer); s.timer = null; } });

    const safeDailyDishCount = Number.isFinite(game.dailyDishCount) ? game.dailyDishCount : 0;
    const safeDailyQualitySum = Number.isFinite(game.dailyQualitySum) ? game.dailyQualitySum : 0;
    const dailyRate = safeDailyDishCount > 0 ? (safeDailyQualitySum / safeDailyDishCount) : 0;
    const ratePercent = (dailyRate * 100).toFixed(0);
    const servedRate = game.total > 0 ? (game.served / game.total) : 0;
    localStorage.setItem('yesterdayRate', (servedRate * 100).toFixed(1));

    game.history.push({ day: game.level, revenue: game.dailyRevenue, rate: ratePercent });
    updateBalanceDisplay();
    saveGameState();

    const rateHtml = `<span style="font-weight:900; color:${dailyRate >= 0.8 ? '#2ecc71' : '#f39c12'}">${ratePercent}%</span>`;

    // [核心修改] 日报文案：强调“钱包余额”与目标的差距
    let msg = `<b>${reason}</b><br>`;
    msg += `当日营业额: <b>¥${game.dailyRevenue}</b><br>`;
    msg += `钱包余额: <b style="color:#f1c40f">¥${game.coins}</b> <span style="color:#aaa">/ ¥${game.targetRevenue}</span><br>`;
    msg += `当日合格率: ${rateHtml}`;
    logSystemEvent('SETTLEMENT_TRIGGER', { day: game.level, revenue: game.dailyRevenue });

    // [核心修复] 无论是否有钱，统一显示标准结算弹窗 
    // 不再跳转到 showAchievementDetails，避免逻辑断层 
    showResult(msg);
}

function resetHand() {
    holdingThing = null;
    updateCursor();
    document.body.style.cursor = 'default';
}

function resetStations() {
    Object.keys(stations).forEach(sid => {
        const s = stations[sid];
        s.stage = 'IDLE';
        s.currentIngredients = [];
        s.recipe = null;
        s.progress = 0;
        // Keep maintenance state or reset? User said "physically clear... data". 
        // Usually maintenance carries over, but user said "clear...". 
        // I will keep maintenance as it adds challenge, but clear the current activity.
        if (s.timer) {
            clearInterval(s.timer);
            s.timer = null;
        }
        renderStation(sid);
    });
}

function cancelAction() {
    if (holdingThing) {
        // Drop item effect
        triggerFeedback(window.innerWidth/2, window.innerHeight/2, "取消操作", "#ccc");
        resetHand();
    }
}

function renderOrders() {
    const belt = document.getElementById('belt-container');
    if (!belt) return;
    
    // 1. Ensure slots exist (restore structure if missing)
    if (!document.getElementById('order-slot-0')) {
        initOrderSlots();
    }
    
    // 2. Reset all slots to empty state
    for (let i = 0; i < 5; i++) {
        const slot = document.getElementById('order-slot-' + i);
        if (slot) {
            slot.innerHTML = i + 1; 
        }
    }
    
    // 3. Place active orders into their slots
    game.activeOrders.forEach(order => {
        if (!order.dom) {
            const el = document.createElement('div');
            el.className = 'order-ticket';
            el.onclick = () => takeOrder(order);
            order.dom = el;
        }
        
        // [核心修改]
        order.dom.innerHTML = renderOrderHTML(order);
        
        // Mount to slot
        const slot = document.getElementById('order-slot-' + order.slotIdx);
        if (slot) {
            slot.innerHTML = '';
            slot.appendChild(order.dom);
        }
    });
}

function resetDailyStats() {
    game.dailyRevenue = 0;
    
    // [核心修复] 重置及格率相关统计
    game.dailyDishCount = 0;
    game.dailyQualitySum = 0;
    
    game.served = 0;
    game.total = 0;
    game.spawned = 0;
    game.totalErrors = 0;
    game.activeOrders = []; 
    game.orderSlots = [null, null, null, null, null];
    game.slotCooldowns = [0, 0, 0, 0, 0];
    
    renderOrders(); 
}

function initLevel(regenerateOrders = true) {
    // Reset Timer
    game.timeRemaining = 120;
    game.lastTime = Date.now();
    
    // 1. Clear Stations & Hand
    resetStations();
    resetHand();
    
    // 2. Reset Stats & Orders
    resetDailyStats();
    
    // 3. Generate New Orders
    if (regenerateOrders) {
        generateDailyOrders(game.level);
    }
    
    // 4. Update UI
    updateHUD();
    updateBalanceDisplay();
    
    console.log(`Level ${game.level} Initialized`);
}

function startNextLevel(btnId = 'modal-btn') {
    const btn = document.getElementById(btnId);
    if (!btn) return;
    // UI Feedback
    const originalText = btn.innerText;
    btn.disabled = true;
    btn.innerText = "正在开启...";
    btn.style.opacity = "0.7";
    btn.style.cursor = "wait";
    const previousState = {
        level: game.level,
        isLive: game.isLive,
        isPaused: game.isPaused
    };
    // Mock API Call
    new Promise((resolve, reject) => {
        setTimeout(() => {
            if (!navigator.onLine) {
                reject(new Error("无网络连接"));
                return;
            }
            // 移除随机报错，让体验更丝滑
            const nextLevel = game.level + 1;
            const orderGenSuccess = generateDailyOrders(nextLevel);
            if (!orderGenSuccess) {
                reject(new Error("订单生成失败"));
                return;
            }
            resolve({ newLevel: nextLevel });
        }, 500);
    })
    .then(data => {
        console.log("Business state switched successfully:", data);
        
        game.level = data.newLevel;
        game.isLive = false;
        game.isPaused = true;
        game.dayEnded = false;
        
        initDailyInventory();
        
        // [核心修复] 立即保存新关卡进度！防止刷新后回退到旧天数
        saveGameState();
        
        initLevel(false);
        
        document.getElementById('pause-overlay').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('achievement-modal').style.display = 'none';
        
        btn.disabled = false;
        btn.innerText = originalText;
        btn.style.opacity = "1";
        btn.style.cursor = "pointer";
        updateGameBackground('IDLE');
        if(typeof stations === 'object') {
            Object.keys(stations).forEach(sid => {
                if(typeof renderStation === 'function') renderStation(sid);
            });
        }
        
        // [新增] 插入街坊情报环节
        showPrepModal();
    })
    .catch(error => {
        console.error('Business state switch error:', error);
        game.level = previousState.level;
        game.isLive = previousState.isLive;
        game.isPaused = previousState.isPaused;
        triggerFeedback(window.innerWidth/2, 100, `开启失败: ${error.message}`, "#ff4757");
        btn.disabled = false;
        btn.innerText = "重试开启";
        btn.style.opacity = "1";
        btn.style.cursor = "pointer";
    });
}

function runPrepLogicTests() {
    function assertEq(name, a, b) {
        const ok = Math.abs(a - b) < 1e-6;
        console[ok ? 'log' : 'error'](`[TEST] ${name}: ${ok ? 'PASS' : 'FAIL'} (${a} vs ${b})`);
    }
    assertEq('no penalty (10/10)', computePrepPenaltyPercent(10, 10), 0);
    assertEq('10% over -> 5% penalty', computePrepPenaltyPercent(10, 11), 5);
    assertEq('20% over -> 10% penalty', computePrepPenaltyPercent(10, 12), 10);
    assertEq('100% over capped to 40%', computePrepPenaltyPercent(10, 20), 40);
}

// 绑定事件
const musicToggle = document.getElementById('toggle-music');
const themeToggle = document.getElementById('toggle-theme');

if (themeToggle) {
    themeToggle.checked = themeMusicEnabled;
    themeToggle.addEventListener('change', e => {
        themeMusicEnabled = e.target.checked;
        
        if (!themeMusicEnabled) {
            // 关闭：如果当前正在播放主题曲，则停止
            if (AudioController.currentBgm === 'bgm-theme') {
                AudioController.stopCurrent();
            }
        } else {
            // 开启：检查是否在菜单界面，是则播放
            const loadingEl = document.getElementById('loading');
            const startScreen = document.getElementById('start-screen');
            const isMenuState = (loadingEl && loadingEl.style.display !== 'none') || 
                                (startScreen && startScreen.style.display !== 'none');
            
            if (isMenuState) {
                startMusic();
            }
        }
    });
}

if (musicToggle) {
    musicToggle.checked = gameMusicEnabled;
    musicToggle.addEventListener('change', e => {
            gameMusicEnabled = e.target.checked;
            if (gameMusicEnabled) {
                const loadingEl = document.getElementById('loading');
                if (loadingEl && loadingEl.style.display === 'none' && game.isLive) {
                    AudioController.playGame();
                }
            } else {
                // 停止游戏音乐
                if (AudioController.currentBgm === 'bgm-game') {
                    AudioController.stopCurrent();
                }
                
                if (nintendoBGMInterval) {
                    clearInterval(nintendoBGMInterval);
                    nintendoBGMInterval = null;
                }
            }
        });
}
document.getElementById('toggle-sfx').addEventListener('change', e => { sfxEnabled = e.target.checked; });
document.querySelectorAll('.action-btn').forEach(b => b.addEventListener('pointerdown', () => playCoin()));
document.getElementById('btn-pause').addEventListener('click', () => setPaused(!game.isPaused));
document.getElementById('btn-resume').addEventListener('click', () => setPaused(false));
document.addEventListener('keydown', (e) => {
    if (e.code === 'Space' || e.key === 'p' || e.key === 'P') {
        e.preventDefault();
        setPaused(!game.isPaused);
    }
    if (e.key === 'Escape') {
        cancelAction();
    }
});

// Global cancel on background click
document.addEventListener('click', (e) => {
    if (e.target.id === 'play-area' || 
        e.target.id === 'kitchen-area' || 
        e.target === document.body ||
        e.target.id === 'game-container') {
        cancelAction();
    }
});
document.addEventListener('DOMContentLoaded', () => {
    const shopBtn = document.getElementById('btn-shop');
    if (shopBtn) {
        shopBtn.onclick = (e) => {
            e.preventDefault();
            showShop();
        };
    }
});
    
function initDailyInventory() {
    const fridgeLevel = game.inventory.fridge || 0;
    if (fridgeLevel < 1) {
        // Reset if no Cold Storage
        game.dailyInventory = {};
        Object.keys(INGREDIENTS).forEach(key => {
            game.dailyInventory[key] = 0;
        });
    } else {
        // Keep existing, but ensure all keys exist
        if (!game.dailyInventory) game.dailyInventory = {};
        Object.keys(INGREDIENTS).forEach(key => {
            if (game.dailyInventory[key] === undefined) {
                game.dailyInventory[key] = 0;
            }
        });
    }
}

function renderPrepUI() { 
    const container = document.getElementById('prep-grid'); 
    if (!container || typeof INGREDIENTS === 'undefined') return; 

    container.innerHTML = ''; 
    Object.entries(INGREDIENTS).forEach(([id, data]) => { 
        const current = window.tempInventory[id] || 0; 
        // 检查是否有足够的钱买至少一个 
        const canAfford = window.tempCoins >= data.price; 

        const card = document.createElement('div'); 
        card.className = `market-item-card ${current > 0 ? 'active' : ''}`; 

        card.innerHTML = ` 
            <div class="pc-icon">${data.icon}</div> 
            <div class="pc-name">${data.name}</div> 
            <div class="pc-price">¥${data.price}/份</div> 
            
            <div class="pc-controls"> 
                <button class="pc-btn pc-btn-minus" onclick="changePrep('${id}', -1)">-</button> 
                <div class="pc-count" id="prep-cnt-${id}">${current}</div> 
                <button class="pc-btn pc-btn-plus" onclick="changePrep('${id}', 1)" ${!canAfford ? 'style="opacity:0.5"' : ''}>+</button> 
            </div> 
        `; 
        container.appendChild(card); 
    }); 

    updatePrepFooter(); 
}

function updatePrepFooter() { 
    const walletEl = document.getElementById('prep-wallet-display'); 
    const costEl = document.getElementById('prep-cost-display'); 

    if(walletEl) walletEl.innerText = `¥${window.tempCoins}`; 
    // 计算总花费 (初始资金 - 当前资金) 
    const totalCost = window.startCoins - window.tempCoins; 
    if(costEl) costEl.innerText = `¥${totalCost}`; 
}

window.changePrep = function(id, delta) { 
    const price = INGREDIENTS[id].price; 
    const isDayOne = game.level === 1; // [新增] 
    
    // Day 1 允许无限加购，不检查余额 
    if (!isDayOne && delta > 0 && window.tempCoins < price) { 
        if(typeof playSfx === 'function') playSfx(150, 'sawtooth', 0.2); 
        if(typeof showToast === 'function') showToast("老板，资金不足啦！", 1000); 
        return; 
    } 
    
    const current = window.tempInventory[id] || 0; 
    const newValue = Math.max(0, current + delta); 
    
    if (newValue !== current) { 
        window.tempInventory[id] = newValue; 
        
        // [核心修改] Day 1 不扣钱 
        if (!isDayOne) { 
            window.tempCoins -= (newValue - current) * price; 
        } 
        
        if(typeof playSfx === 'function') { 
            if(delta > 0) playSfx(400, 'sine', 0.1); 
            else playSfx(300, 'square', 0.1); 
        } 
        
        const countEl = document.getElementById(`prep-cnt-${id}`); 
        const cardEl = countEl ? countEl.closest('.market-item-card') : null; 
        
        if (countEl) countEl.innerText = newValue; 
        if (cardEl) { 
            if (newValue > 0) cardEl.classList.add('active'); 
            else cardEl.classList.remove('active'); 
        } 
        
        updatePrepFooter(); 
    } 
};

window.confirmPrep = async function() { 
    console.log("确认进货：正在初始化游戏..."); 
    
    // 1. 强制唤醒音频引擎 
    if (typeof audioCtx !== 'undefined' && audioCtx.state === 'suspended') { 
        try { 
            await audioCtx.resume(); 
            console.log("✅ AudioContext 已强制唤醒"); 
        } catch (err) { 
            console.warn("❌ AudioContext 唤醒失败:", err); 
        } 
    } 
    // 2. 同步数据 
    game.dailyInventory = { ...window.tempInventory }; 
    game.coins = window.tempCoins; 
    
    // [新增] 重置食材柜层数
    if (typeof pantryLayer !== 'undefined') pantryLayer = 1;

    // [修复] 每天开始营业时，强制重置食材柜为关闭状态
    const drawer = document.getElementById('pantry-drawer');
    if (drawer) {
        drawer.classList.remove('open');
        drawer.classList.add('closed');
    }

    // [核心修改] 触发旧店后台结算 (不再直接发钱)
    processLegacyShopDailyTick();

    // [核心修改] 3. & 4. 切换到游戏视图
    // 先手动隐藏 prep-modal (因为它可能不在 switchScreen 的管理列表里)
    const prepModal = document.getElementById('prep-modal');
    if(prepModal) prepModal.style.display = 'none';
    const cover = document.getElementById('cover');
    if(cover) cover.style.display = 'none';

    // [新增] 只有在这里才显示垃圾桶！ 
    const trashCard = document.getElementById('global-trash-card'); 
    if (trashCard) trashCard.style.display = 'flex'; 

    // [优化] game-ui 显示逻辑已移至 switchScreen 中统一管理
    // const gameUI = document.getElementById('game-ui');
    // if (gameUI) gameUI.style.display = 'block';

    // 使用 switchScreen 统一管理：它会自动显示 play-area/hud/belt，并隐藏 start-screen
    switchScreen('game-container');

    // 5. 激活核心状态 
    game.isPaused = false; 
    game.isLive = true; 
    // [修复] 强制重置天数结束标志，防止上一局状态残留 
    game.dayEnded = false; 
 
    // 6. 切换背景 
 if(typeof updateGameBackground === 'function') { 
     updateGameBackground(); 
 } 
 
 // [关键修复] 音频切换逻辑 
 // 切换到游戏音乐
 AudioController.playGame(); 
 
 // 7. 初始化游戏逻辑 
    if(typeof initStations === 'function') initStations(); 
    if(typeof initOrderSlots === 'function') initOrderSlots();
    initLevel(); 
 if(typeof initIngredients === 'function') initIngredients(); 
    updateBalanceDisplay(); 
    
    // Check and play pantry animation
    // if(typeof checkAndPlayPantryAnimation === 'function') checkAndPlayPantryAnimation();

    // 8. 开启游戏循环 
 requestAnimationFrame(update); 
 showToast(`DAY ${game.level} 开始营业啦`, 2000); 
 };

function loadBackgroundImageWithRetry(element, url, version, retries = 3) {
    const img = new Image();
    // 添加时间戳防止缓存
    const uniqueUrl = `${url}?v=${version}&t=${Date.now()}`;
    
    img.onload = function() {
        element.style.background = `url('${uniqueUrl}') no-repeat center center / cover`;
        console.log("Market image loaded successfully:", uniqueUrl);
    };
    
    img.onerror = function() {
        console.error("Failed to load market image:", uniqueUrl);
        if (retries > 0) {
            console.log(`Retrying... (${retries} attempts left)`);
            setTimeout(() => {
                loadBackgroundImageWithRetry(element, url, version, retries - 1);
            }, 500);
        } else {
             // 最终失败兜底
             element.style.background = '#2c3e50'; 
             showToast("背景加载异常，已启用备用背景");
        }
    };
    
    img.src = uniqueUrl;
}

function showPrepModal() {
    // 1. 基础清理
    document.querySelectorAll('#cover, #start-screen, .loading-screen').forEach(el => el.style.display = 'none');
    
    // 2. 数据初始化
    window.tempInventory = Object.assign({}, game.dailyInventory || {});
    window.tempCoins = (game.coins !== undefined) ? game.coins : 500;
    window.startCoins = window.tempCoins;
    initDailyInventory();

    // 3. 创建/获取 Modal 容器
    let modal = document.getElementById('prep-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'prep-modal';
        document.getElementById('game-container').appendChild(modal);
    }
    modal.className = 'prep-overlay';
    modal.style.cssText = 'display: flex !important; pointer-events: auto !important; opacity: 1 !important; visibility: visible !important;';

    // 4. 生成情报数据
    generateDailyGossip();

    // 5. 渲染基本结构 (注意：Grid 和 Footer 加上了 prep-ui-hidden 类，初始不可见)
    // Day 1 特殊文案处理
    const isDayOne = game.level === 1;
    const ngParams = JSON.parse(localStorage.getItem('ng_params') || '{}');
    const isNewBranch = ngParams.isNGPlus === true;

    let introText = "";

    if (isDayOne) {
        if (isNewBranch) {
            introText = `🚀 <b>${ngParams.branchName || '新分店'}</b> 盛大开业！<br><span style='font-size:0.6em; opacity:0.9'>利用启动资金，快速在新城市站稳脚跟吧。</span>`;
        } else {
            // [修复] 仅在首次进入时显示开业贺礼，并领取物资
            const hasSeenPrepGift = localStorage.getItem('hasSeenPrepGift');
            
            if (!hasSeenPrepGift) {
                introText = "新店开业大吉！<br><span style='font-size:0.6em; opacity:0.8; font-weight:400'>街坊邻居们听说你回来重开老店，特意凑了些新鲜食材送来当贺礼！</span>";
                
                // 仅在首次领取时发放物资
                if (Object.keys(window.tempInventory).length === 0) {
                    window.tempInventory['tomato'] = 5;
                    window.tempInventory['egg'] = 5;
                    window.tempInventory['onion'] = 5;
                }
                
                localStorage.setItem('hasSeenPrepGift', 'true');
            } else {
                // 如果已领取过，显示默认文案
                introText = "晨光熹微，市集喧嚣...<br><span style='font-size:0.6em; opacity:0.8; font-weight:400'>甄选今日最新鲜的食材</span>";
            }
        }
    } else {
        introText = "晨光熹微，市集喧嚣...<br><span style='font-size:0.6em; opacity:0.8; font-weight:400'>甄选今日最新鲜的食材</span>";
    }

    modal.innerHTML = `
        <div class="prep-bg"></div>
        <div class="prep-curtain"></div>
        
        <div class="prep-intro-text">${introText}</div>
        
        <div class="prep-container">
            <div class="prep-header prep-ui-hidden">
                <div class="prep-header-content">
                    <h1 class="prep-title" style="margin-top:0;">清晨集市</h1>
                    <div class="prep-subtitle">根据刚才的情报，合理规划采购...</div>
                </div>
                <button class="btn-back" onclick="playSfx(300, 'sine', 0.1); switchScreen('start-screen')"><span>↩</span> 返回</button>
            </div>
            
            <div id="prep-grid" class="prep-grid prep-ui-hidden"></div>
            
            <div id="prep-footer" class="prep-footer prep-ui-hidden">
                <div style="display:flex; gap:20px;">
                    <div class="pf-info">
                        <span class="pf-label">钱包余额</span>
                        <span class="pf-val highlight" id="prep-wallet-display">¥${window.tempCoins}</span>
                    </div>
                    <div class="pf-info">
                        <span class="pf-label">预计花费</span>
                        <span class="pf-val" id="prep-cost-display">¥0</span>
                    </div>
                </div>
                <button class="btn-start-day" onclick="playSfx(400, 'triangle', 0.1); window.confirmPrep()"><span>🌤️</span> 开门营业</button>
            </div>
        </div>
    `;
    
    // [修复] 动态加载背景图片，强制刷新缓存并监控状态
    const bgEl = modal.querySelector('.prep-bg');
    if (bgEl) {
        // 使用版本号 v1.0 (如果更新了图片文件，请修改此处)
        loadBackgroundImageWithRetry(bgEl, 'assets/bg/白天菜市场.png', '1.0');
    }

    // 6. 渲染商品内容 (此时虽然不可见但已存在 DOM 中)
    renderPrepUI();
    
    // 7. 播放音乐 (与集市共享)
    AudioController.playShop();

    // 8. [关键] 启动对话流程
    // 延时从 500ms 改为 2200ms，等待 Intro Text (2.5s) 播放大半后再出现
    setTimeout(() => {
        startMarketChatterFlow();
    }, 2200);
}

function renderPrepUI() { 
    const container = document.getElementById('prep-grid'); 
    if (!container || typeof INGREDIENTS === 'undefined') return; 
    container.innerHTML = ''; 
    // 1. [核心逻辑] 计算当前关卡已解锁的食材列表 
    const currentLevel = game.level; 
    const allowedIngredients = new Set(); 
    // 根据 generateDailyOrders 的逻辑反推解锁的菜谱 
    let unlockedRecipes = []; 
    if (currentLevel >= 1) unlockedRecipes.push(...RECIPES.slice(0, 2)); // 基础 
    if (currentLevel >= 3) unlockedRecipes.push(...RECIPES.slice(2, 6)); // 进阶 
    if (currentLevel >= 6) unlockedRecipes.push(...RECIPES.slice(6, 9)); // 高级 
    if (currentLevel >= 9) unlockedRecipes.push(...RECIPES.slice(9, 12)); // 复杂 

    // 提取食材 ID 
    unlockedRecipes.forEach(r => r.ingredients.forEach(i => allowedIngredients.add(i))); 

    // Day 1 特殊逻辑：虽然只有番茄鸡蛋，但为了让界面好看，可以稍微多展示几个基础的（如洋葱/米饭），或者严格限制 // 这里我们严格限制，防止玩家买错 

    // 2. 定义分类字典 
    const categories = { 
        'veggie': { title: '🥬 新鲜蔬果', items: [] }, 
        'meat': { title: '🥩 肉禽蛋品', items: [] }, 
        'seafood': { title: '🦐 海鲜水产', items: [] }, 
        'other': { title: '🧂 其它调味', items: [] } 
    }; 
    // 3. 智能归类 (仅包含已解锁的) 
    Object.entries(INGREDIENTS).forEach(([id, data]) => { 
        // [过滤] 如果不在允许列表中，直接跳过 
        if (!allowedIngredients.has(id)) return; 
        if (['tomato', 'potato', 'onion', 'lettuce', 'veg'].some(k => id.includes(k) || data.name.includes('番茄') || data.name.includes('菜'))) { 
            categories.veggie.items.push({id, ...data}); 
        } else if (['pork', 'beef', 'chicken', 'egg', 'meat'].some(k => id.includes(k) || data.name.includes('肉') || data.name.includes('蛋'))) { 
            categories.meat.items.push({id, ...data}); 
        } else if (['shrimp', 'fish', 'seafood'].some(k => id.includes(k) || data.name.includes('虾') || data.name.includes('鱼'))) { 
            categories.seafood.items.push({id, ...data}); 
        } else { 
            categories.other.items.push({id, ...data}); 
        } 
    }); 
    // 4. 渲染分类区块 
    const isDayOne = game.level === 1; 
    Object.values(categories).forEach(cat => { if (cat.items.length === 0) return; const catSection = document.createElement('div'); catSection.className = 'market-category'; 

    let itemsHtml = ''; 
    cat.items.forEach(item => { 
        const current = window.tempInventory[item.id] || 0; 
        
        // Day 1 逻辑：虽然免费，但为了不让数字太夸张，我们可以锁定购买数量或者显示"∞" 
        // 这里我们让玩家随意点，但是不扣钱 
        const priceDisplay = isDayOne ? '<span style="color:#2ecc71">赠送</span>' : `¥${item.price}/份`; 
        const canAfford = isDayOne ? true : (window.tempCoins >= item.price); 
        
        itemsHtml += ` 
            <div class="market-item-card ${current > 0 ? 'active' : ''}"> 
                <div class="pc-icon">${item.icon}</div> 
                <div class="pc-info"> 
                    <div class="pc-name">${item.name}</div> 
                    <div class="pc-price">${priceDisplay}</div> 
                </div> 
                <div class="pc-controls"> 
                    <button class="pc-btn pc-btn-minus" onclick="changePrep('${item.id}', -1)">-</button> 
                    <div class="pc-count" id="prep-cnt-${item.id}">${current}</div> 
                    <button class="pc-btn pc-btn-plus" onclick="changePrep('${item.id}', 1)" ${!canAfford ? 'style="opacity:0.5"' : ''}>+</button> 
                </div> 
            </div> 
        `; 
    }); 

    catSection.innerHTML = ` 
        <div class="category-title">${cat.title}</div> 
        <div class="category-items">${itemsHtml}</div> 
    `; 
    container.appendChild(catSection); 
    }); 

    // 补丁：更新底部预算
    if (typeof updatePrepFooter === 'function') updatePrepFooter();
}



// --- 分店托管系统核心逻辑 ---
// 计算旧店评分 (每日基础产出)
function calculateLegacyDailyIncome() {
    const inv = game.inventory;
    let baseIncome = 0;
    
    // 评分算法：Omni系列权重极高，K-MES是必要条件
    if (inv.pot >= 3) baseIncome += 150;
    if (inv.pot >= 5) baseIncome += 250; // Omni 3.0
    if (inv.pot >= 7) baseIncome += 350; // 小锅
    
    baseIncome += (inv.expansion * 150); // 装修加成

    // 自动化系数 (没有 MES 系统效率极低)
    let automation = 0.1;
    if (inv.belt >= 2) automation = 0.6;
    if (inv.belt >= 3) automation = 1.0;
    
    return Math.floor(baseIncome * automation);
}

// 每日后台结算 (在新的一天开始时调用)
function processLegacyShopDailyTick() {
    // 读取列表
    const raw = localStorage.getItem('legacy_shops_list');
    if (!raw) return;

    let list = JSON.parse(raw);
    if (!Array.isArray(list) || list.length === 0) return;
    
    let totalAdded = 0;

    // 遍历所有店铺进行结算 (新逻辑：无维护模式，纯收益)
    list.forEach(shop => {
        // 收益公式：基础100 + 等级加成 (50 * expansion)
        // expansion: 0 (标准), 1 (扩建), 2 (星级)
        const level = (shop.expansion || 0);
        const revenue = 100 + (50 * level);
        
        totalAdded += revenue;
    });

    // 直接汇入总资产
    if (totalAdded > 0) {
        game.coins += totalAdded;
        if (typeof updateBalanceDisplay === 'function') updateBalanceDisplay();
        
        // 汇总提示
        showToast(`${list.length} 家星级厨房共营收 ¥${totalAdded}`, 4000);
    }
}

// [新增] 显示分店详情弹窗 (新版：仅展示信息)
function showLegacyManageModal(shopData) {
    const overlay = document.getElementById('overlay');
    overlay.style.zIndex = '4000';

    const title = document.getElementById('modal-title');
    const desc = document.getElementById('modal-desc');
    const actions = document.querySelector('#overlay .modal-actions');

    if (!overlay || !title || !desc || !actions) return;

    title.innerText = `🏢 分店详情：${shopData.name}`;
    title.style.color = "#2ecc71";
    
    // 计算当前等级收益
    const level = (shopData.expansion || 0);
    const dailyRevenue = 100 + (50 * level);
    
    // 等级描述
    const levelNames = ["标准厨房", "扩建厨房", "星级厨房"];
    const levelName = levelNames[level] || "标准厨房";

    desc.innerHTML = `
        <div style="text-align:left; width:100%; padding: 10px;">
            <div style="margin-bottom:15px; padding:15px; background:#f0f3f5; border-radius:12px;">
                <div style="font-size:14px; color:#7f8c8d; margin-bottom:5px;">当前规模</div>
                <div style="font-size:18px; font-weight:bold; color:#2c3e50;">${levelName}</div>
            </div>
            
            <div style="margin-bottom:15px; padding:15px; background:#fff8e1; border-radius:12px; border:1px solid #ffe0b2;">
                <div style="font-size:14px; color:#f39c12; margin-bottom:5px;">每日托管收益</div>
                <div style="font-size:24px; font-weight:bold; color:#e67e22;">¥${dailyRevenue}</div>
                <div style="font-size:12px; color:#d35400; margin-top:5px;">* 收益已自动汇入总资产</div>
            </div>
            
            <div style="font-size:13px; color:#95a5a6; line-height:1.5;">
                <p>该分店由专业团队全权托管，每日自动结算收益。</p>
            </div>
        </div>
    `;

    // 重写按钮
    actions.innerHTML = '';

    const btnClose = document.createElement('button');
    btnClose.innerText = "关闭";
    btnClose.style.background = "#34495e";
    btnClose.style.color = "white";
    btnClose.style.border = "none";
    btnClose.style.padding = "12px 40px";
    btnClose.style.borderRadius = "25px";
    btnClose.style.fontSize = "16px";
    btnClose.style.cursor = "pointer";
    btnClose.style.boxShadow = "0 4px 10px rgba(52, 73, 94, 0.3)";
    
    btnClose.onclick = () => {
        playSfx(300, 'sine', 0.1);
        overlay.style.display = 'none';
        overlay.style.zIndex = '';
    };

    actions.appendChild(btnClose);
    overlay.style.display = 'flex';
}
</script>





<script>
// ================= 游戏启动逻辑 =================
function showIntroGiftModal() {
    const overlay = document.createElement('div');
    overlay.id = 'intro-gift-modal';
    overlay.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;z-index:20000;display:flex;flex-direction:column;align-items:center;justify-content:center;animation:fadeIn 0.5s;";
    const bg = document.createElement('div');
    bg.style.cssText = "position:absolute;inset:0;background:url('assets/bg/门店后厨.jpg') center/cover no-repeat;filter:blur(4px) brightness(0.5);";
    overlay.appendChild(bg);
    const gifts = [
        { id: 'egg', count: 5 },
        { id: 'tomato', count: 5 },
        { id: 'onion', count: 5 }
    ];
    let itemsHtml = '';
    gifts.forEach(item => {
        const ing = (typeof INGREDIENTS !== 'undefined' ? INGREDIENTS[item.id] : null);
        const icon = ing && ing.icon ? ing.icon : '🥦';
        const name = ing && ing.name ? ing.name : item.id;
        itemsHtml += `
            <div style="display:flex;flex-direction:column;align-items:center;background:rgba(0,0,0,0.35);border-radius:12px;padding:15px;width:90px;border:1px solid rgba(255,255,255,0.2)">
                <div style="font-size:44px;margin-bottom:8px">${icon}</div>
                <span style="color:#fff;font-size:14px">${name}</span>
                <span style="color:#f1c40f;font-weight:bold;font-size:16px">x${item.count}</span>
            </div>
        `;
    });
    overlay.innerHTML += `
        <div style="position:relative;width:90%;max-width:680px;background:#fff;border-radius:16px;padding:20px;display:flex;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,0.5)">
            <div style="width:80px;height:80px;margin-right:15px;flex-shrink:0">
                <img src="assets/npc/高叔_normal.png" style="width:100%;height:100%;object-fit:cover;border-radius:8px">
            </div>
            <div>
                <div style="color:#d35400;font-weight:bold;margin-bottom:5px">高叔</div>
                <div style="color:#2c3e50;line-height:1.6">虽然现在只能炒些家常小菜，但这是咱们起步的根基。收下这些，开始你的第一天营业吧！</div>
            </div>
        </div>
        <h3 style="position:relative;color:#fff;margin-bottom:20px;font-weight:normal;letter-spacing:2px">— 初始物资 —</h3>
        <div style="position:relative;display:flex;gap:15px;flex-wrap:wrap;justify-content:center;margin-bottom:40px;">
            ${itemsHtml}
        </div>
        <button id="btn-intro-start" style="position:relative;background:linear-gradient(135deg,#e67e22,#d35400);color:#fff;border:none;padding:15px 60px;font-size:20px;border-radius:30px;font-weight:bold;cursor:pointer;box-shadow:0 4px 15px rgba(230,126,34,0.4);animation:pulse 2s infinite">开始营业</button>
    `;
    document.body.appendChild(overlay);
    const btn = overlay.querySelector('#btn-intro-start');
    btn.onclick = async () => {
        playSfx(400, 'sine', 0.1);
        try {
            if (typeof audioCtx !== 'undefined' && audioCtx.state === 'suspended') await audioCtx.resume();
        } catch {}
        overlay.remove();
        localStorage.setItem('hasPlayedIntro', 'true');
        if (typeof saveGameState === 'function') saveGameState();
        initGameAfterIntro(gifts);
    };
}

function initGameAfterIntro(gifts) {
    if (typeof initDailyInventory === 'function') initDailyInventory();
    if (!game.dailyInventory) game.dailyInventory = {};
    gifts.forEach(g => {
        const realId = (g.id === 'vegetable' && INGREDIENTS && INGREDIENTS['pepper']) ? 'pepper' : g.id;
        game.dailyInventory[realId] = (game.dailyInventory[realId] || 0) + g.count;
    });
    window.tempInventory = { ...game.dailyInventory };
    window.tempCoins = (game.coins !== undefined) ? game.coins : 500;
    window.startCoins = window.tempCoins;
    if (typeof window.confirmPrep === 'function') {
        window.confirmPrep();
    }
}

// [新增] 新手集市插曲：高叔叮嘱 -> 赠送物资
function showUncleGaoInterlude() {
    const prepModal = document.getElementById('prep-modal');
    if (!prepModal) return;
    const layer = document.createElement('div');
    layer.id = 'intro-interlude-layer';
    layer.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;z-index:10002;display:flex;flex-direction:column;justify-content:flex-end;padding-bottom:15%;background:transparent;animation:fadeIn 0.3s;";
    const gifts = [
        { id: 'egg', name: '鸡蛋', count: 5 },
        { id: 'tomato', name: '番茄', count: 5 },
        { id: 'onion', name: '洋葱', count: 5 }
    ];
    const dialogueHtml = `
        <div id="gao-dialogue-box" style="width:95%; max-width:800px; margin:0 auto; padding:20px; position:relative; cursor:pointer; height:100%; display:flex; flex-direction:column; justify-content:flex-end;" onclick="switchToIntroShelf()">
            <div class="chat-row left" style="display:flex; margin-bottom: 0; align-items: flex-end;">
                <div class="chat-portrait-box" style="width: 160px; height: 220px; flex-shrink: 0; position: relative; z-index: 10;">
                    <img src="assets/characters/高叔.png" 
                         class="chat-portrait-img" 
                         style="display:block; width: 320px; height: 380px; max-width:none; position:absolute; bottom:0; left:50%; transform:translateX(-50%); object-fit:contain; object-position:bottom center;" 
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div class="chat-portrait-placeholder" style="background:#e67e22; display:none; width:80px; height:80px; font-size:40px; line-height:80px; border-radius:10px;">高</div>
                </div>
                <div class="chat-bubble" style="position:relative; flex-grow: 1; padding: 30px 40px 50px 120px !important; margin-left: -70px; z-index: 5; font-size: 18px; line-height: 1.6; min-height: 120px;">
                    <span style="font-weight:bold; color:#d35400; display:block; margin-bottom:12px; font-size:22px;">高叔</span>
                    虽然现在只能炒些家常小菜，但这是咱们起步的根基。
                    <div style="position:absolute; right:25px; bottom:15px; font-size:14px; color:#e67e22; font-weight:bold; animation:blink 1.2s infinite;">
                        (点击屏幕继续) ▶
                    </div>
                </div>
            </div>
        </div>
    `;
    let gridHtml = '';
    gifts.forEach(item => {
        const ing = (typeof INGREDIENTS !== 'undefined' ? INGREDIENTS[(item.id === 'vegetable') ? 'pepper' : item.id] : null);
        const icon = ing && ing.icon ? ing.icon : '🥦';
        const name = item.name || (ing && ing.name ? ing.name : item.id);
        gridHtml += `
            <div style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:12px;padding:24px;display:flex;flex-direction:column;align-items:center;justify-content:center;backdrop-filter:blur(5px);width:100%;max-width:260px;box-sizing:border-box;overflow:hidden;">
                <div style="font-size:48px;margin-bottom:10px;">${icon}</div>
                <div style="color:#fff;font-weight:bold;margin-bottom:5px;">${name}</div>
                <div style="color:#f1c40f;font-weight:900;font-size:18px;">x${item.count}</div>
                <div style="font-size:12px;color:#2ecc71;margin-top:5px;">赠送</div>
            </div>
        `;
    });
    const shelfHtml = `
        <div id="intro-shelf-box" style="display:none;width:100%;height:100%;flex-direction:column;align-items:center;justify-content:center;position:relative;z-index:2;">
            <h2 style="color:#fff;font-size:28px;margin-bottom:10px;text-shadow:0 2px 4px rgba(0,0,0,0.5);">📦 初始物资</h2>
            <p style="color:rgba(255,255,255,0.8);margin-bottom:30px;">高叔为你准备的启动食材</p>
            <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:24px;width:85%;max-width:900px;margin:0 auto 40px;justify-items:center;align-items:stretch;">
                ${gridHtml}
            </div>
            <button onclick="finishIntroInterlude()" style="background:linear-gradient(135deg,#e67e22,#d35400);color:#fff;border:none;padding:15px 60px;font-size:20px;border-radius:50px;font-weight:bold;cursor:pointer;box-shadow:0 4px 15px rgba(230,126,34,0.4);transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">开始营业</button>
        </div>
    `;
    layer.innerHTML = dialogueHtml + shelfHtml;
    prepModal.appendChild(layer);
    const curtainEl = document.createElement('div');
    curtainEl.className = 'prep-curtain';
    layer.appendChild(curtainEl);
    window.switchToIntroShelf = () => {
        playSfx(400, 'sine', 0.1);
        const d = document.getElementById('gao-dialogue-box');
        if (d) d.style.display = 'none';
        const shelf = document.getElementById('intro-shelf-box');
        const curtain = layer.querySelector('.prep-curtain');
        if (curtain) {
            curtain.classList.add('active');
            setTimeout(() => {
                if (shelf) {
                    shelf.style.display = 'flex';
                    shelf.style.animation = 'fadeIn 0.5s';
                }
            }, 800);
        } else {
            if (shelf) {
                shelf.style.display = 'flex';
                shelf.style.animation = 'fadeIn 0.5s';
            }
        }
    };
    window.finishIntroInterlude = () => {
        playSfx(400, 'triangle', 0.1);
        localStorage.setItem('hasPlayedIntro', 'true');
        if (typeof saveGameState === 'function') saveGameState();
        layer.remove();
        initGameAfterIntro(gifts);
    };
}

function initGame() {
    showPrepModal();
}

function startGame() {
    AudioController.playTheme();
    
    const startScreen = document.getElementById('start-screen');
    const gameUI = document.getElementById('game-ui');
    
    if (startScreen) startScreen.style.display = 'none';
    // [修正] 移除此处直接显示 gameUI，改为在 switchScreen('game-container') 中统一处理
    // if (gameUI) gameUI.style.display = 'block';
    
    const hasPlayed = localStorage.getItem('hasPlayedIntro');
    
    if (!hasPlayed) {
        setTimeout(() => {
            renderStoryModal(INTRO_STORY, () => {
                initGame();
            });
        }, 500);
    } else {
        initGame();
    }
}

// 绑定开始按钮
(function() {
    const realBtn = document.getElementById('btn-start') || document.getElementById('start-btn');
    if (realBtn) {
        realBtn.onclick = function(e) {
            e.preventDefault();
            startGame();
        };
    }
})();
</script>
</body>
</html>


</html>
